

# ATELIER COMPLET : Assembly SSAS - Calcul de Jours Ouvrés

---

## 1. PRÉPARATION DE LA DLL

### Étape 1.1 : Créer le projet C# dans Visual Studio

1. Ouvrir **Visual Studio**
2. **Fichier** → **Nouveau** → **Projet**
3. Sélectionner **Bibliothèque de classes (.NET Framework)**
4. Nom du projet : `SSASCustomFunctions`
5. Framework : **.NET Framework 4.7.2** ou supérieur
6. Cliquer sur **Créer**

### Étape 1.2 : Ajouter la référence Analysis Services

1. Dans l'**Explorateur de solutions**, clic droit sur **Références**

2. **Ajouter une référence...**

3. Cliquer sur **Parcourir...**

4. Naviguer vers :
   
   ```
   C:\Program Files\Microsoft SQL Server\150\SDK\Assemblies\
   ```
   
   (Le numéro peut varier : 140, 150, 160 selon votre version SQL Server)

5. Sélectionner : **Microsoft.AnalysisServices.AdomdServer.dll**

6. Cliquer **OK**

### Étape 1.3 : Écrire le code de la classe

Remplacer le contenu de **Class1.cs** par :

```csharp
using System;
using Microsoft.AnalysisServices.AdomdServer;

namespace SSASCustomFunctions
{
    public class DateFunctions
    {
        /// <summary>
        /// Calcule le nombre de jours ouvrés entre deux dates
        /// Exclut les samedis et dimanches
        /// </summary>
        [SafeToPrepare(true)]
        public static int CalculerJoursOuvres(DateTime dateDebut, DateTime dateFin)
        {
            if (dateDebut > dateFin)
                return 0;

            int joursOuvres = 0;
            DateTime dateActuelle = dateDebut;

            while (dateActuelle <= dateFin)
            {
                if (dateActuelle.DayOfWeek != DayOfWeek.Saturday && 
                    dateActuelle.DayOfWeek != DayOfWeek.Sunday)
                {
                    joursOuvres++;
                }
                dateActuelle = dateActuelle.AddDays(1);
            }

            return joursOuvres;
        }

        /// <summary>
        /// Vérifie si une date est un jour ouvré
        /// </summary>
        [SafeToPrepare(true)]
        public static bool EstJourOuvre(DateTime date)
        {
            return date.DayOfWeek != DayOfWeek.Saturday && 
                   date.DayOfWeek != DayOfWeek.Sunday;
        }

        /// <summary>
        /// Ajoute un nombre de jours ouvrés à une date
        /// </summary>
        [SafeToPrepare(true)]
        public static DateTime AjouterJoursOuvres(DateTime dateDepart, int nombreJours)
        {
            DateTime dateResultat = dateDepart;
            int joursAjoutes = 0;

            while (joursAjoutes < nombreJours)
            {
                dateResultat = dateResultat.AddDays(1);
                if (EstJourOuvre(dateResultat))
                {
                    joursAjoutes++;
                }
            }

            return dateResultat;
        }
    }
}
```

### Étape 1.4 : Signer l'assembly (OBLIGATOIRE)

1. Clic droit sur le projet **SSASCustomFunctions** → **Propriétés**
2. Aller dans l'onglet **Signature** (ou **Signing**)
3. Cocher **Signer l'assembly** (Sign the assembly)
4. Dans la liste déroulante, sélectionner **<Nouveau...>** (New...)
5. Nom du fichier de clé : `SSASKey.snk`
6. **Décocher** "Protéger mon fichier de clé avec un mot de passe"
7. Cliquer **OK**

### Étape 1.5 : Compiler le projet

1. Menu **Générer** → **Générer SSASCustomFunctions**

2. Vérifier la compilation dans la fenêtre **Sortie**

3. Noter l'emplacement de la DLL générée :
   
   ```
   [Chemin_Projet]\SSASCustomFunctions\bin\Debug\SSASCustomFunctions.dll
   ```

### Étape 1.6 : Copier la DLL

Copier la DLL dans un emplacement accessible, par exemple :

```
C:\SSAS\Assemblies\SSASCustomFunctions.dll
```

---

## 2. INTÉGRATION DANS SSDT

### Étape 2.1 : Ouvrir le projet SSAS dans SSDT

1. Ouvrir **Visual Studio** avec **SQL Server Data Tools**
2. Ouvrir votre projet SSAS existant (fichier **.dwproj**)
   - Ou créer un nouveau projet Analysis Services Multidimensional

### Étape 2.2 : Ajouter l'assembly au projet

1. Dans l'**Explorateur de solutions**, localiser le dossier **Assemblies**
2. Clic droit sur **Assemblies** → **New Assembly Reference...**

### Étape 2.3 : Référencer la DLL

Dans la fenêtre qui s'ouvre :

1. Cliquer sur l'onglet **.NET**
2. Cliquer sur le bouton **Browse...** (Parcourir)
3. Naviguer vers : `C:\SSAS\Assemblies\`
4. Sélectionner **SSASCustomFunctions.dll**
5. Cliquer **Ouvrir**
6. Cliquer **OK**

L'assembly apparaît maintenant dans le dossier **Assemblies** du projet.

### Étape 2.4 : Configurer les propriétés de l'assembly

1. Dans l'**Explorateur de solutions**, cliquer sur **SSASCustomFunctions** (sous Assemblies)

2. Dans la fenêtre **Propriétés** (F4 si invisible) :
   
   ```
   - Name: SSASCustomFunctions- ID: SSASCustomFunctions- Permission Set: Safe- Impersonation Info: ImpersonateServiceAccount
   ```

### Étape 2.5 : Créer une mesure calculée utilisant l'assembly

1. Dans l'**Explorateur de solutions**, double-cliquer sur votre **Cube** (ex: Ventes.cube)
2. Aller dans l'onglet **Calculs** (Calculations)
3. Cliquer sur l'icône **Nouvelle mesure calculée** (ou clic droit → New Calculated Member)

Ajouter ce code :

```mdx
CREATE MEMBER CURRENTCUBE.[Measures].[Jours Ouvrés Livraison]
AS 
SSASCustomFunctions.DateFunctions.CalculerJoursOuvres(
    [Commande].[Date Commande].CurrentMember.MemberValue,
    [Commande].[Date Livraison].CurrentMember.MemberValue
),
FORMAT_STRING = "#,##0",
VISIBLE = 1;
```

4. **Enregistrer** le cube (Ctrl+S)

### Étape 2.6 : Configurer le serveur de déploiement

1. Clic droit sur le **projet SSAS** (racine) → **Propriétés**

2. Dans **Configuration Properties** → **Deployment** :
   
   ```
   - Server: localhost (ou nom de votre serveur SSAS)- Database: [NomDeVotreBase]- Processing Option: Do Not Process (ou Full selon besoin)
   ```

3. Cliquer **OK**

### Étape 2.7 : Déployer le projet

**Option A : Déploiement complet**

1. Clic droit sur le **projet** → **Deploy**
2. Suivre la progression dans la fenêtre **Deployment Progress**

**Option B : Déploiement de l'assembly uniquement** (première fois)

1. Clic droit sur **SSASCustomFunctions** (sous Assemblies) → **Deploy**

---

## 3. UTILISATION DANS SSMS

### Étape 3.1 : Vérifier le déploiement

1. Ouvrir **SQL Server Management Studio (SSMS)**
2. Se connecter au serveur **Analysis Services**
3. Développer : **Databases** → **[Votre Base]** → **Assemblies**
4. Vérifier la présence de **SSASCustomFunctions**

### Étape 3.2 : Tester avec une requête MDX simple

Dans SSMS, créer une **nouvelle requête MDX** :

```mdx
WITH 
MEMBER [Measures].[Test Jours Ouvrés] AS
    SSASCustomFunctions.DateFunctions.CalculerJoursOuvres(
        CDATE("2024-01-01"),
        CDATE("2024-01-31")
    )

SELECT 
    [Measures].[Test Jours Ouvrés] ON COLUMNS
FROM [VotreCube]
```

**Résultat attendu** : 23 (jours ouvrés en janvier 2024)

### Étape 3.3 : Utiliser avec des dimensions réelles

```mdx
SELECT 
    {[Measures].[Montant Ventes], 
     [Measures].[Jours Ouvrés Livraison]} ON COLUMNS,
    NON EMPTY [Commande].[Numero Commande].[Numero Commande].MEMBERS ON ROWS
FROM [Ventes]
WHERE [Date].[Annee].&[2024]
```

### Étape 3.4 : Créer un filtre sur jours ouvrés

```mdx
WITH 
SET [Commandes Rapides] AS
    FILTER(
        [Commande].[Numero Commande].[Numero Commande].MEMBERS,
        [Measures].[Jours Ouvrés Livraison] <= 5
    )

SELECT 
    [Measures].[Montant Ventes] ON COLUMNS,
    [Commandes Rapides] ON ROWS
FROM [Ventes]
```

### Étape 3.5 : Utiliser la fonction EstJourOuvre

```mdx
WITH 
MEMBER [Measures].[Est Jour Ouvrable] AS
    IIF(
        SSASCustomFunctions.DateFunctions.EstJourOuvre(
            [Date].[Date].CurrentMember.MemberValue
        ),
        "Oui",
        "Non"
    )

SELECT 
    [Measures].[Est Jour Ouvrable] ON COLUMNS,
    [Date].[Date].[Date].MEMBERS ON ROWS
FROM [Ventes]
WHERE [Date].[Annee].&[2024]
```

---

## 4. VÉRIFICATIONS ET DÉPANNAGE

### Vérification 1 : L'assembly est bien déployée

```sql
-- Dans SSMS, connexion SSAS, nouvelle requête XMLA
SELECT * FROM $SYSTEM.DISCOVER_ASSEMBLIES
WHERE ASSEMBLY_NAME = 'SSASCustomFunctions'
```

### Vérification 2 : Permissions

Si erreur de sécurité, vérifier dans SSMS :

1. Propriétés du serveur SSAS
2. **Sécurité** → **Trusted Assemblies**
3. Ajouter le chemin complet de la DLL si nécessaire

### Problème courant : "Type not found"

**Solution** : Vérifier que le namespace et la classe sont corrects

```mdx
-- Syntaxe correcte :
SSASCustomFunctions.DateFunctions.CalculerJoursOuvres(...)

-- Pas :
DateFunctions.CalculerJoursOuvres(...)
```

### Problème : Assembly non signée

**Erreur** : "Assembly must be signed with a strong name" **Solution** : Retourner à l'étape 1.4 et signer l'assembly

---

## 5. CAS D'USAGE PRATIQUES

### Exemple 1 : Calcul de SLA

```mdx
CREATE MEMBER CURRENTCUBE.[Measures].[SLA Respecté]
AS 
IIF(
    SSASCustomFunctions.DateFunctions.CalculerJoursOuvres(
        [Ticket].[Date Ouverture].CurrentMember.MemberValue,
        [Ticket].[Date Résolution].CurrentMember.MemberValue
    ) <= 3,
    "OUI",
    "NON"
),
VISIBLE = 1;
```

### Exemple 2 : Date prévue de livraison

```mdx
CREATE MEMBER CURRENTCUBE.[Measures].[Date Livraison Prévue]
AS 
SSASCustomFunctions.DateFunctions.AjouterJoursOuvres(
    [Commande].[Date Commande].CurrentMember.MemberValue,
    5
),
FORMAT_STRING = "dd/MM/yyyy",
VISIBLE = 1;
```

### Exemple 3 : KPI basé sur jours ouvrés

```mdx
CREATE MEMBER CURRENTCUBE.[Measures].[Délai Moyen Ouvré]
AS 
AVG(
    [Commande].[Numero Commande].[Numero Commande].MEMBERS,
    SSASCustomFunctions.DateFunctions.CalculerJoursOuvres(
        [Commande].[Date Commande].CurrentMember.MemberValue,
        [Commande].[Date Livraison].CurrentMember.MemberValue
    )
),
FORMAT_STRING = "#,##0.0",
VISIBLE = 1;
```

---

## RÉSUMÉ DU WORKFLOW

```
┌─────────────────────────────────────┐
│  1. VISUAL STUDIO (C#)              │
│  - Créer Class Library              │
│  - Ajouter référence AdomdServer    │
│  - Coder les fonctions              │
│  - Signer l'assembly                │
│  - Compiler → DLL générée           │
└──────────────┬──────────────────────┘
               │
               ▼
┌─────────────────────────────────────┐
│  2. SSDT (Visual Studio)            │
│  - Ouvrir projet SSAS               │
│  - Ajouter assembly reference       │
│  - Configurer permissions (Safe)    │
│  - Créer mesures calculées          │
│  - DÉPLOYER vers serveur SSAS       │
└──────────────┬──────────────────────┘
               │
               ▼
┌─────────────────────────────────────┐
│  3. SSMS                            │
│  - Vérifier déploiement             │
│  - Tester requêtes MDX              │
│  - Valider résultats                │
└─────────────────────────────────────┘
```


