# ATELIER 3 : AGR√âGATIONS - VERSION SIMPLIFI√âE



## PR√âPARATION : CUBE SIMPLIFI√â (15 min)

### Script 1 : Base de donn√©es minimale

```sql
USE master;
GO

-- Cr√©er une base simple pour la d√©mo
IF EXISTS (SELECT * FROM sys.databases WHERE name = 'DemoAggregations')
    DROP DATABASE DemoAggregations;
GO

CREATE DATABASE DemoAggregations;
GO

USE DemoAggregations;
GO

-- Table de dimension Date (SIMPLE - seulement 5 attributs)
CREATE TABLE DimDate (
    DateKey INT PRIMARY KEY,
    FullDate DATE NOT NULL,
    Year INT NOT NULL,
    Quarter INT NOT NULL,
    Month INT NOT NULL,
    MonthName VARCHAR(20) NOT NULL
);
GO

-- Table de dimension Product (SIMPLE - 3 attributs)
CREATE TABLE DimProduct (
    ProductKey INT PRIMARY KEY,
    ProductName VARCHAR(100) NOT NULL,
    Category VARCHAR(50) NOT NULL
);
GO

-- Table de faits (SIMPLE)
CREATE TABLE FactSales (
    DateKey INT NOT NULL,
    ProductKey INT NOT NULL,
    Quantity INT NOT NULL,
    Amount DECIMAL(10,2) NOT NULL,
    FOREIGN KEY (DateKey) REFERENCES DimDate(DateKey),
    FOREIGN KEY (ProductKey) REFERENCES DimProduct(ProductKey)
);
GO

-- Ins√©rer des dates (3 ans = 1095 jours)
DECLARE @StartDate DATE = '2022-01-01';
DECLARE @EndDate DATE = '2024-12-31';
DECLARE @CurrentDate DATE = @StartDate;

WHILE @CurrentDate <= @EndDate
BEGIN
    INSERT INTO DimDate (DateKey, FullDate, Year, Quarter, Month, MonthName)
    VALUES (
        YEAR(@CurrentDate) * 10000 + MONTH(@CurrentDate) * 100 + DAY(@CurrentDate),
        @CurrentDate,
        YEAR(@CurrentDate),
        DATEPART(QUARTER, @CurrentDate),
        MONTH(@CurrentDate),
        DATENAME(MONTH, @CurrentDate)
    );

    SET @CurrentDate = DATEADD(DAY, 1, @CurrentDate);
END;
GO

-- Ins√©rer 10 produits
INSERT INTO DimProduct (ProductKey, ProductName, Category) VALUES
(1, 'Laptop HP', 'Computers'),
(2, 'Laptop Dell', 'Computers'),
(3, 'Tablet iPad', 'Tablets'),
(4, 'Tablet Samsung', 'Tablets'),
(5, 'Phone iPhone', 'Phones'),
(6, 'Phone Samsung', 'Phones'),
(7, 'Monitor LG', 'Accessories'),
(8, 'Keyboard Logitech', 'Accessories'),
(9, 'Mouse Logitech', 'Accessories'),
(10, 'Headset Sony', 'Accessories');
GO

-- Ins√©rer 50,000 ventes (assez pour voir l'effet des agr√©gations)
DECLARE @i INT = 1;
WHILE @i <= 50000
BEGIN
    INSERT INTO FactSales (DateKey, ProductKey, Quantity, Amount)
    VALUES (
        (SELECT TOP 1 DateKey FROM DimDate ORDER BY NEWID()),
        (ABS(CHECKSUM(NEWID())) % 10) + 1,
        (ABS(CHECKSUM(NEWID())) % 10) + 1,
        (ABS(CHECKSUM(NEWID())) % 1000) + 100
    );
    SET @i = @i + 1;
END;
GO

-- V√©rifier
SELECT 
    'DimDate' AS TableName, COUNT(*) AS RowCount FROM DimDate
UNION ALL
SELECT 'DimProduct', COUNT(*) FROM DimProduct
UNION ALL
SELECT 'FactSales', COUNT(*) FROM FactSales;
GO
```

**Ex√©cuter ce script dans SSMS ‚Üí Vous avez maintenant une base minimale.**

---

## PARTIE 1 : CR√âER LE CUBE (10 min)

### Pas √† pas SSDT

1. **Nouveau projet SSAS** :
   
   - File ‚Üí New ‚Üí Project
   - Analysis Services Multidimensional Project
   - Nom : `DemoAggregations`

2. **Data Source** :
   
   - Clic droit sur Data Sources ‚Üí New Data Source
   - Connection : Votre serveur ‚Üí Base `DemoAggregations`
   - Finish

3. **Data Source View** :
   
   - Clic droit sur Data Source Views ‚Üí New Data Source View
   - S√©lectionner les 3 tables : DimDate, DimProduct, FactSales
   - Finish

4. **Dimensions** :
   
   **Dim Date :**
   
   - Clic droit sur Dimensions ‚Üí New Dimension
   - Wizard : Use existing table ‚Üí DimDate ‚Üí DateKey comme cl√©
   - Attributs : **Cocher SEULEMENT** Year, Quarter, Month
   - **NE PAS cocher** MonthName (on l'expliquera pendant la d√©mo)
   - Name : Dim Date ‚Üí Finish
   
   **Dim Product :**
   
   - New Dimension ‚Üí DimProduct ‚Üí ProductKey comme cl√©
   - Attributs : **Cocher** Category seulement
   - Name : Dim Product ‚Üí Finish

5. **Cube** :
   
   - Clic droit sur Cubes ‚Üí New Cube
   - Use existing tables ‚Üí FactSales
   - Mesures : Cocher Quantity et Amount
   - Dimensions : Cocher Dim Date et Dim Product
   - Name : Sales Cube ‚Üí Finish

6. **Deploy** :
   
   - Build ‚Üí Deploy Solution

‚úÖ **Cube pr√™t ! Maintenant on attaque les agr√©gations.**

---

## PARTIE 2 : OPTION 1 - DESIGN AGGREGATIONS (30 min)

### D√âMO : Concevoir des agr√©gations

**Sc√©nario √† expliquer :**

> "On va cr√©er des agr√©gations manuellement. SSAS va nous proposer un design bas√© sur nos dimensions."

#### √âtape 1 : Lancer

1. Ouvrir `Sales Cube.cube` ‚Üí Onglet **Aggregations**
2. **Clic droit** sur `Fact Sales` ‚Üí **Design Aggregations...**

#### √âtape 2 : Welcome

- Next

#### √âtape 3 : Review Aggregation Usage ‚≠ê **L'√âCRAN CL√â**

**CE QU'ON VOIT :**

```
Cube Objects         | Default | Full | None | Unrestricted
---------------------|---------|------|------|-------------
Dim Date             | 3       | 0    | 0    | 0
  Year               | ‚óè       |      |      |
  Quarter            | ‚óè       |      |      |
  Month              | ‚óè       |      |      |
Dim Product          | 1       | 0    | 0    | 0
  Category           | ‚óè       |      |      |
```

**EXPLICATION PENDANT LA D√âMO :**

üëâ **"Regardez, tous nos attributs sont en Default. Qu'est-ce que √ßa veut dire ?"**

---

### üìö EXPLICATION : Les 4 options

**Faites cette explication MAINTENANT, devant cet √©cran :**

#### **Default** (colonne 1)

- "SSAS d√©cide tout seul si l'attribut est utile pour les agr√©gations"
- "C'est le mode automatique - √ßa marche dans 80% des cas"
- **Exemple** : Quarter, Month

#### **Full** (colonne 2)

- "L'attribut DOIT √™tre dans TOUTES les agr√©gations"
- "√Ä utiliser pour les attributs TOUJOURS utilis√©s dans vos rapports"
- **Exemple** : Year (tout le monde analyse par ann√©e)

#### **None** (colonne 3)

- "L'attribut n'est JAMAIS dans les agr√©gations"
- "Pour les textes descriptifs ou attributs rarement utilis√©s"
- **Exemple** : MonthName (c'est juste du texte, pas besoin d'agr√©ger dessus)

#### **Unrestricted** (colonne 4)

- "SSAS √©value d'abord combien il y a de valeurs diff√©rentes"
- "Pour les attributs √† haute cardinalit√© (beaucoup de valeurs)"
- **Exemple** : CustomerID (si vous avez 100,000 clients)

---

### üéØ D√âMO : Modifier les settings

**Dire :**

> "Modifions Year en Full, car tout le monde analyse par ann√©e."

1. **Cliquer sur la cellule** Year √ó Full
2. La coche se d√©place : `Year | | ‚óè | |`

**R√©sultat visible :**

```
Dim Date             | 2       | 1    | 0    | 0
```

**Dire :**

> "Si on avait MonthName, on le mettrait en None car c'est du texte."

3. Next

---

#### √âtape 4 : Review Object Counts

**CE QU'ON VOIT :**

```
Partition                 | Estimated Rows
--------------------------|---------------
Fact Sales                | 50,000

Dimension                 | Estimated Members
--------------------------|------------------
Dim Date                  | 1,095
Dim Product               | 10
```

**EXPLICATION :**

üëâ **"Pourquoi SSAS demande le nombre de lignes ?"**

**R√©ponse :**

- "SSAS a besoin de savoir la **taille des donn√©es**"
- "Plus il y a de lignes, plus les agr√©gations sont utiles"
- "Si Fact Sales = 100 lignes ‚Üí Agr√©gations inutiles"
- "Si Fact Sales = 100 millions ‚Üí Agr√©gations ESSENTIELLES"

**Montrer :**

- Fact Sales : 50,000 lignes ‚Üí Bon pour la d√©mo
- Dim Date : 1,095 jours ‚Üí Normal (3 ans)

**Dire :**

> "Si les counts sont √† 0 ou faux, cliquez sur Count pour recalculer."

4. Next

---

#### √âtape 5 : Set Aggregation Options ‚≠ê **LE C≈íUR**

**CE QU'ON VOIT :**

```
‚óã Estimated storage reaches : [  50  ] MB
‚óè Performance gain reaches  : [ 30 ] %
‚óã I click Stop
‚óã Do not design aggregations (0%)
```

**EXPLICATION DES OPTIONS :**

**Option 1 : Estimated storage**

- "Je limite par l'espace disque"
- "Ex: Seulement 50 MB d'agr√©gations max"
- **Quand ?** Serveur avec peu d'espace

**Option 2 : Performance gain** ‚≠ê **LA PLUS UTILIS√âE**

- "Je veux X% d'am√©lioration de performance"
- "SSAS cr√©e des agr√©gations jusqu'√† atteindre ce gain"
- **Quand ?** Production normale (30-50%)

**Option 3 : I click Stop**

- "SSAS cr√©e des agr√©gations, je l'arr√™te quand je veux"
- **Quand ?** Tests, explorations

**Option 4 : 0%**

- "Aucune agr√©gation"
- **Quand ?** Jamais (sauf d√©sactivation temporaire)

---

### üéØ D√âMO : Lancer avec 30%

**Dire :**

> "On va demander 30% d'am√©lioration. C'est un bon d√©but."

1. S√©lectionner **Performance gain reaches : 30%**
2. Cliquer **Start**

**Vous voyez l'animation :**

```
Designing Aggregations...

Aggregations     : 0 ‚Üí 3 ‚Üí 5 ‚Üí 7 ‚Üí 9 ‚Üí 12
Estimated Storage: 0 MB ‚Üí 0.5 MB ‚Üí 1.2 MB ‚Üí 2.1 MB
Performance Gain : 0% ‚Üí 15% ‚Üí 23% ‚Üí 28% ‚Üí 31% ‚úì

[=================>    ]
```

**DIRE PENDANT QUE √áA TOURNE :**

- "SSAS teste plein de combinaisons d'attributs"

- "Il calcule : si j'agr√®ge Year+Category, combien de requ√™tes vont plus vite ?"

- "Il s'arr√™te √† 30%... regardez, 12 agr√©gations cr√©√©es pour 2 MB"
3. Quand c'est fini ‚Üí **Noter les chiffres :**
   
   - Agr√©gations : ____
   - Storage : ____ MB
   - Gain : ____%

4. Next ‚Üí Finish

---

### üéØ TEST : Voir l'effet

**Query 1 : AVANT Processing**

```mdx
SELECT 
    [Measures].[Amount] ON COLUMNS,
    [Dim Date].[Year].[Year].Members ON ROWS
FROM [Sales Cube];
```

1. **Browser** ‚Üí Saisir cette requ√™te MDX
2. Temps d'ex√©cution : ____ ms

**Maintenant Process le cube :**

1. Clic droit sur cube ‚Üí **Process**
2. Process Full ‚Üí Run
3. Close

**Query 2 : APR√àS Processing**

- M√™me requ√™te ‚Üí Temps : ____ ms

**Am√©lioration ?** Oui, mais l√©g√®re (cube petit).

---

## PARTIE 3 : OPTION 2 - USAGE BASED OPTIMIZATION (30 min)

### D√âMO : Optimisation bas√©e sur l'utilisation

**Sc√©nario :**

> "Design Aggregations devine. Usage-Based regarde ce que les VRAIS utilisateurs font."

#### √âtape 0 : Activer le Query Log

**Dans SSMS, connect√© √† SSAS :**

1. Clic droit sur serveur ‚Üí **Properties**
2. Cocher **Show Advanced**
3. Trouver **Log\QueryLog\CreateQueryLogTable** ‚Üí `True`
4. OK

#### √âtape 1 : G√©n√©rer des requ√™tes utilisateur

**Ex√©cuter ces requ√™tes 5-10 fois chacune :**

```mdx
-- Requ√™te fr√©quente 1 : Par Year et Category
SELECT 
    [Measures].[Amount] ON COLUMNS,
    [Dim Date].[Year].[Year].Members ON ROWS,
    [Dim Product].[Category].[Category].Members ON COLUMNS
FROM [Sales Cube];

-- Requ√™te fr√©quente 2 : Par Quarter
SELECT 
    [Measures].[Quantity] ON COLUMNS,
    [Dim Date].[Quarter].[Quarter].Members ON ROWS
FROM [Sales Cube];
```

#### √âtape 2 : V√©rifier le log

**Dans SSMS (SQL Server, pas SSAS) :**

```sql
USE master;
SELECT TOP 10 * FROM OlapQueryLog ORDER BY StartTime DESC;
```

**Vous devez voir vos requ√™tes.**

#### √âtape 3 : Lancer Usage-Based Optimization

1. Onglet **Aggregations**
2. Clic droit sur `Fact Sales` ‚Üí **Usage Based Optimization...**

**Wizard :**

**√âcran 1 : Specify Query Criteria**

- Beginning date : (Aujourd'hui - 1 jour)
- Ending date : Aujourd'hui
- Next

**√âcran 2 : Review queries**

- Vous voyez vos requ√™tes list√©es
- Cocher celles √† optimiser
- Next

**√âcran 3-5 : M√™me que Design Aggregations**

- Next ‚Üí Next
- Performance gain : 20%
- Start ‚Üí Finish

**EXPLICATION :**

> "Cette fois, SSAS a cr√©√© des agr√©gations sp√©cifiquement pour Year+Category, car c'est ce qu'on utilise vraiment !"

---

## PARTIE 4 : OPTION 3 - ASSIGN AGGREGATION DESIGN (10 min)

### D√âMO : R√©utiliser un design existant

**Sc√©nario :**

> "J'ai 10 partitions (une par mois). Je veux appliquer le m√™me design partout."

#### Cr√©er une 2√®me partition (simulation)

1. Onglet **Partitions**
2. Clic droit sur `Fact Sales` ‚Üí Copy
3. Clic droit ‚Üí Paste
4. Renommer : `Fact Sales 2023`

**Maintenant on a :**

```
Fact Sales            | Aggregation Design 1
Fact Sales 2023       | (No Aggregation)
```

#### Assigner le design

1. Onglet **Aggregations**
2. Clic droit sur `Fact Sales 2023` ‚Üí **Assign Aggregation Design...**
3. S√©lectionner **Aggregation Design 1**
4. OK

**R√©sultat :**

```
Fact Sales            | Aggregation Design 1
Fact Sales 2023       | Aggregation Design 1
```

**EXPLICATION :**

> "Les deux partitions partagent maintenant le m√™me design d'agr√©gations. Tr√®s utile pour les partitions mensuelles/annuelles identiques."

---

## Explication des 3 OPTIONS

| Option                  | Quand                           | Avantage             | Inconv√©nient        |
| ----------------------- | ------------------------------- | -------------------- | ------------------- |
| **Design Aggregations** | Nouveau cube, pas d'historique  | Rapide, automatique  | G√©n√©rique           |
| **Usage-Based**         | Apr√®s 1-2 semaines en prod      | Cibl√© sur usage r√©el | Besoin de query log |
| **Assign Design**       | Multiples partitions similaires | R√©utilisation        | Design doit exister |
