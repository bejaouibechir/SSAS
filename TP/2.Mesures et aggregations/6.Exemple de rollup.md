## Mini-Projet : Analyse des Ventes par Région

### 1. Création du Data Warehouse

**Schéma en étoile simple :**

- **1 dimension** : DimRegion
- **1 table de faits** : FactVentes

```sql
-- Création de la base de données
CREATE DATABASE DW_VentesDemo;
GO

USE DW_VentesDemo;
GO

-- Table de dimension : Régions
CREATE TABLE DimRegion (
    RegionKey INT PRIMARY KEY,
    RegionNom NVARCHAR(50),
    Pays NVARCHAR(50),
    Zone NVARCHAR(50) -- Zone géographique (Nord, Sud, etc.)
);

-- Table de faits : Ventes
CREATE TABLE FactVentes (
    VenteID INT IDENTITY(1,1) PRIMARY KEY,
    RegionKey INT FOREIGN KEY REFERENCES DimRegion(RegionKey),
    DateVente DATE,
    Montant DECIMAL(10,2),
    Quantite INT
);
```

### 2. Remplissage des données de démonstration

```sql
-- Insertion des régions
INSERT INTO DimRegion (RegionKey, RegionNom, Pays, Zone)
VALUES 
    (1, 'Ile-de-France', 'France', 'Nord'),
    (2, 'Provence-Alpes', 'France', 'Sud'),
    (3, 'Auvergne-Rhône', 'France', 'Centre'),
    (4, 'Nouvelle-Aquitaine', 'France', 'Ouest'),
    (5, 'Hauts-de-France', 'France', 'Nord');

-- Insertion des ventes (quelques lignes de démonstration)
INSERT INTO FactVentes (RegionKey, DateVente, Montant, Quantite)
VALUES 
    -- Ile-de-France
    (1, '2024-01-15', 1500.00, 10),
    (1, '2024-02-20', 2300.00, 15),
    (1, '2024-03-10', 1800.00, 12),

    -- Provence-Alpes
    (2, '2024-01-18', 1200.00, 8),
    (2, '2024-02-25', 1600.00, 11),
    (2, '2024-03-12', 1400.00, 9),

    -- Auvergne-Rhône
    (3, '2024-01-22', 900.00, 6),
    (3, '2024-02-28', 1100.00, 7),
    (3, '2024-03-15', 950.00, 6),

    -- Nouvelle-Aquitaine
    (4, '2024-01-25', 800.00, 5),
    (4, '2024-02-15', 1000.00, 7),
    (4, '2024-03-20', 850.00, 5),

    -- Hauts-de-France
    (5, '2024-01-28', 1300.00, 9),
    (5, '2024-02-22', 1700.00, 12),
    (5, '2024-03-18', 1450.00, 10);

-- Requête de vérification
SELECT 
    r.RegionNom,
    r.Zone,
    COUNT(*) AS NbVentes,
    SUM(v.Montant) AS MontantTotal,
    SUM(v.Quantite) AS QuantiteTotal
FROM FactVentes v
INNER JOIN DimRegion r ON v.RegionKey = r.RegionKey
GROUP BY r.RegionNom, r.Zone
ORDER BY r.Zone, r.RegionNom;
```

### 3. Procédure d'exemple avec ROLLUP

```sql
-- Procédure stockée démontrant l'utilisation de ROLLUP
CREATE PROCEDURE sp_AnalyseVentesAvecRollup
AS
BEGIN
    -- Exemple 1 : ROLLUP sur Zone et Région
    SELECT 
        r.Zone,
        r.RegionNom,
        COUNT(*) AS NombreVentes,
        SUM(v.Montant) AS ChiffreAffaires,
        SUM(v.Quantite) AS QuantiteTotale,
        AVG(v.Montant) AS MontantMoyen
    FROM FactVentes v
    INNER JOIN DimRegion r ON v.RegionKey = r.RegionKey
    GROUP BY ROLLUP(r.Zone, r.RegionNom)
    ORDER BY r.Zone, r.RegionNom;

    PRINT '-------------------------------------------';
    PRINT 'Explication du ROLLUP :';
    PRINT '- Lignes avec Zone + Région : détail par région';
    PRINT '- Lignes avec Zone NULL : sous-total par zone';
    PRINT '- Ligne avec tout NULL : total général';
    PRINT '-------------------------------------------';
END;
GO

-- Exécution de la procédure
EXEC sp_AnalyseVentesAvecRollup;
```

### 4. Instructions pour SSAS/SSDT

**Une fois votre projet SSAS créé dans SSDT, voici comment configurer le ROLLUP :**

#### Étape A : Créer la source de données

1. Clic droit sur "Data Sources" → New Data Source
2. Connectez-vous à votre base `DW_VentesDemo`

#### Étape B : Créer la vue de source de données (DSV)

1. Clic droit sur "Data Source Views" → New Data Source View
2. Sélectionnez les tables `DimRegion` et `FactVentes`
3. SSDT détectera automatiquement la relation

#### Étape C : Créer la dimension Region

1. Clic droit sur "Dimensions" → New Dimension
2. Choisissez `DimRegion` comme table source
3. Créez une **hiérarchie** nommée "Géographie" :
   - Niveau 1 : Zone
   - Niveau 2 : RegionNom

#### Étape D : Configurer les propriétés d'agrégation

Dans le **Dimension Designer** pour DimRegion :

```xml
<!-- Dans l'onglet "Dimension Structure" -->
<!-- Pour l'attribut Zone : -->
<Attribute>
    <ID>Zone</ID>
    <Name>Zone</Name>
    <KeyColumns>
        <KeyColumn>
            <DataType>WChar</DataType>
            <Source>Zone</Source>
        </KeyColumn>
    </KeyColumns>
    <!-- IMPORTANT : Configuration pour ROLLUP -->
    <AttributeHierarchyEnabled>true</AttributeHierarchyEnabled>
    <AttributeHierarchyOptimizedState>FullyOptimized</AttributeHierarchyOptimizedState>
    <IsAggregatable>true</IsAggregatable>
</Attribute>
```

#### Étape E : Créer le cube

1. Clic droit sur "Cubes" → New Cube
2. Sélectionnez `FactVentes` comme table de mesures
3. Créez les mesures : Montant (Sum), Quantite (Sum)
4. Ajoutez la dimension Region

#### Étape F : Configuration avancée du ROLLUP dans le Cube

Dans le **Cube Designer**, onglet "Aggregations" :

**Fichier de configuration XML à modifier (optionnel) :**

```xml
<!-- Dans le fichier .cube -->
<MeasureGroup>
    <AggregationDesign>
        <ID>AggregationDesign</ID>
        <Aggregations>
            <Aggregation>
                <!-- Force le rollup sur la hiérarchie Zone > Région -->
                <Dimensions>
                    <Dimension>
                        <CubeDimensionID>Dim Region</CubeDimensionID>
                        <Attributes>
                            <Attribute>
                                <AttributeID>Zone</AttributeID>
                            </Attribute>
                        </Attributes>
                    </Dimension>
                </Dimensions>
            </Aggregation>
        </Aggregations>
    </AggregationDesign>
</MeasureGroup>
```

#### Étape G : Requête MDX pour tester le ROLLUP

Une fois le cube déployé, testez avec cette requête MDX :

```mdx
SELECT 
    [Measures].[Montant] ON COLUMNS,
    [Dim Region].[Géographie].MEMBERS ON ROWS
FROM [VentesDemo]

-- Ou avec ROLLUP explicite :
WITH MEMBER [Measures].[Total Zone] AS 
    SUM([Dim Region].[Zone].CURRENTMEMBER.CHILDREN, [Measures].[Montant])
SELECT 
    {[Measures].[Montant], [Measures].[Total Zone]} ON COLUMNS,
    [Dim Region].[Zone].MEMBERS ON ROWS
FROM [VentesDemo]
```

### 5. Points clés sur le ROLLUP dans SSAS

**Le ROLLUP dans SSAS fonctionne via :**

1. **IsAggregatable = True** : Active l'agrégation au niveau "All"
2. **Hiérarchies** : Les niveaux parent agrègent automatiquement les enfants
3. **AggregationUsage** : Contrôle l'utilisation des agrégations (None, Default, Full)

**Pour modifier le comportement du ROLLUP :**

- **Cube Designer** → onglet "Dimension Usage" → cliquez sur l'intersection dimension/measure group
- Configurez "Aggregation Function" : Sum, Count, Min, Max, DistinctCount, None
