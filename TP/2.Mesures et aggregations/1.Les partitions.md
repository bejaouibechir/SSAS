# 1. Requête de validation SQL (DW)

Voici les **types de processing SSAS**

**Process Full**  
Recharge toutes les données + recalcule toutes les agrégations + invalide tout ce qui existait.  
Le plus lent. Utilisé pour une première construction.

---

**Process Data**  
Recharge uniquement les données de la partition ou de la dimension.  
Ne recalcule pas les index ni les agrégations.

---

**Process Index**  
Recalcule les index et les agrégations à partir des données déjà chargées.  
Toujours exécuté après Process Data pour rendre la partition utilisable.

---

**Process Add**  
Ajoute de nouvelles lignes à une partition existante sans toucher aux anciennes.  
Utilisé pour les chargements incrémentaux.

---

**Process Update**  
Recharge les changements dans les dimensions (SCD) et met à jour les relations.  
Ne recharge pas les faits.

---

**Process Default**  
SSAS décide quoi faire selon l’état des objets.  
À éviter en production car non déterministe.

---

**Process Clear**  
Supprime les données de l’objet sans le supprimer.  
Utilisé avant un rechargement.

---

**Process Structure**  
Reconstruit la structure logique après un changement de schéma.  
Rare, très lourd.

---

**Process Recalc**  
Recalcule uniquement les formules MDX, KPI, membres calculés.  
Aucune donnée n’est relue.

## Exemples:

**Nouvelles ventes du jour**  
→ Process Add

**Correction de lignes déjà chargées (mois passé)**  
→ Process Data + Process Index

**Rechargement complet d’une partition (ex décembre 2025)**  
→ Process Full

**Changement dans une dimension SCD**  
→ Process Update  
puis  
→ Process Index sur les partitions impactées

**Ajout d’un nouvel attribut ou hiérarchie**  
→ Process Structure  
puis  
→ Process Full

**Recalcul de KPI ou formules MDX**  
→ Process Recalc

**Swap BUILD → ACTIVE**  
→ Aucun processing  
juste Delete + Rename des partitions

**Première construction du cube**  
→ Process Full partout

## Creation de la base

Dans SSMS (Database Engine) :

```sql
CREATE VIEW v_Sales_Control_Dec2025
AS
SELECT
    COUNT(*) AS RowCount,
    SUM(SalesAmount) AS TotalSales
FROM FactSales f
JOIN DimDate d ON f.DateKey = d.DateKey
WHERE d.Year = 2025 AND d.Month = 12;
```

---

# 2. XMLA – Lecture des métriques côté cube

Créer le fichier **cube_check.xmla** :

```xml
<Batch xmlns="http://schemas.microsoft.com/analysisservices/2003/engine">
  <Statement>
    SELECT 
        COUNT([Measures].[Sales Amount]) AS RowCount,
        SUM([Measures].[Sales Amount]) AS TotalSales
    FROM [Sales]
    WHERE ([DimDate].[Year].&[2025],[DimDate].[Month].&[12])
  </Statement>
</Batch>
```

---

# 3. PowerShell – Validation BUILD vs DW

Créer le fichier **validate.ps1** :

```powershell
# Récupération DW
$sql = "
SELECT RowCount, TotalSales
FROM v_Sales_Control_Dec2025
"

$dw = Invoke-Sqlcmd -ServerInstance "localhost" -Database "DW_HOTWARM" -Query $sql

$dwRows = $dw.RowCount
$dwTotal = $dw.TotalSales

# Récupération Cube (partition BUILD)
$mdx = "
SELECT 
  [Measures].[Sales Amount] ON 0
FROM [Sales]
WHERE ([DimDate].[Year].&[2025],[DimDate].[Month].&[12])
"

$cube = Invoke-ASCmd -Server "localhost" -Query $mdx
$cubeTotal = ($cube | Select-Object -Last 1)."Sales Amount"

# Seuil de tolérance
$delta = [math]::Abs($dwTotal - $cubeTotal)

if ($delta -gt 1) {
    Write-Error "Validation FAILED. Delta=$delta"
    exit 1
}
else {
    Write-Host "Validation OK. Delta=$delta"
}
```

---

# 4. Process BUILD

Créer le fichier **process_build.ps1** :

```powershell
$xmla = @"
<Batch xmlns="http://schemas.microsoft.com/analysisservices/2003/engine">
  <Process>
    <Object>
      <DatabaseID>DW_HOTWARM</DatabaseID>
      <CubeID>Sales</CubeID>
      <MeasureGroupID>FactSales</MeasureGroupID>
      <PartitionID>SALES_2025_12_BUILD</PartitionID>
    </Object>
    <Type>ProcessFull</Type>
  </Process>
</Batch>
"@

Invoke-ASCmd -Server "localhost" -Query $xmla
```

---

# 5. Swap sécurisé

Créer le fichier **swap.ps1** :

```powershell
$xmla = @"
<Batch xmlns="http://schemas.microsoft.com/analysisservices/2003/engine">

<Delete>
<Object>
<DatabaseID>DW_HOTWARM</DatabaseID>
<CubeID>Sales</CubeID>
<MeasureGroupID>FactSales</MeasureGroupID>
<PartitionID>SALES_2025_12_ACTIVE</PartitionID>
</Object>
</Delete>

<Rename>
<Object>
<DatabaseID>DW_HOTWARM</DatabaseID>
<CubeID>Sales</CubeID>
<MeasureGroupID>FactSales</MeasureGroupID>
<PartitionID>SALES_2025_12_BUILD</PartitionID>
</Object>
<NewName>SALES_2025_12_ACTIVE</NewName>
</Rename>

</Batch>
"@

Invoke-ASCmd -Server "localhost" -Query $xmla
```

---

# 6. SQL Server Agent Job

Créer un Job avec 3 étapes :

### Étape 1

Type PowerShell  
Commande :

```powershell
powershell.exe -File "C:\SSAS\process_build.ps1"
```

### Étape 2

Type PowerShell  
Commande :

```powershell
powershell.exe -File "C:\SSAS\validate.ps1"
```

### Étape 3

Type PowerShell  
Commande :

```powershell
powershell.exe -File "C:\SSAS\swap.ps1"
```

Configurer le job pour :

- Arrêter si une étape échoue

- Envoyer un mail si Étape 2 échoue

---

# Résultat réel

- BUILD est recalculée

- Totaux DW vs Cube sont comparés

- Si divergence → pas de swap

- Si OK → swap instantané

- Les utilisateurs n’ont jamais vu la transition
