# ATELIER 3 : PARTITIONS ET AGRÃ‰GATIONS - VERSION COMPLÃˆTE

## OBJECTIFS DE L'ATELIER

1. Comprendre le lien entre partitions et agrÃ©gations
2. MaÃ®triser la crÃ©ation et la configuration des partitions
3. Optimiser les agrÃ©gations pour chaque partition
4. Appliquer les meilleures pratiques de performance

---

## PRÃ‰PARATION : CUBE SIMPLIFIÃ‰ (15 min)

### Script 1 : Base de donnÃ©es minimale

```sql
USE master;
GO

-- CrÃ©er une base simple pour la dÃ©mo
IF EXISTS (SELECT * FROM sys.databases WHERE name = 'DemoAggregations')
    DROP DATABASE DemoAggregations;
GO

CREATE DATABASE DemoAggregations;
GO

USE DemoAggregations;
GO

-- Table de dimension Date (SIMPLE - seulement 5 attributs)
CREATE TABLE DimDate (
    DateKey INT PRIMARY KEY,
    FullDate DATE NOT NULL,
    Year INT NOT NULL,
    Quarter INT NOT NULL,
    Month INT NOT NULL,
    MonthName VARCHAR(20) NOT NULL
);
GO

-- Table de dimension Product (SIMPLE - 3 attributs)
CREATE TABLE DimProduct (
    ProductKey INT PRIMARY KEY,
    ProductName VARCHAR(100) NOT NULL,
    Category VARCHAR(50) NOT NULL
);
GO

-- Table de faits (SIMPLE)
CREATE TABLE FactSales (
    DateKey INT NOT NULL,
    ProductKey INT NOT NULL,
    Quantity INT NOT NULL,
    Amount DECIMAL(10,2) NOT NULL,
    FOREIGN KEY (DateKey) REFERENCES DimDate(DateKey),
    FOREIGN KEY (ProductKey) REFERENCES DimProduct(ProductKey)
);
GO

-- InsÃ©rer des dates (3 ans = 1095 jours)
DECLARE @StartDate DATE = '2022-01-01';
DECLARE @EndDate DATE = '2024-12-31';
DECLARE @CurrentDate DATE = @StartDate;

WHILE @CurrentDate <= @EndDate
BEGIN
    INSERT INTO DimDate (DateKey, FullDate, Year, Quarter, Month, MonthName)
    VALUES (
        YEAR(@CurrentDate) * 10000 + MONTH(@CurrentDate) * 100 + DAY(@CurrentDate),
        @CurrentDate,
        YEAR(@CurrentDate),
        DATEPART(QUARTER, @CurrentDate),
        MONTH(@CurrentDate),
        DATENAME(MONTH, @CurrentDate)
    );

    SET @CurrentDate = DATEADD(DAY, 1, @CurrentDate);
END;
GO

-- InsÃ©rer 10 produits
INSERT INTO DimProduct (ProductKey, ProductName, Category) VALUES
(1, 'Laptop HP', 'Computers'),
(2, 'Laptop Dell', 'Computers'),
(3, 'Tablet iPad', 'Tablets'),
(4, 'Tablet Samsung', 'Tablets'),
(5, 'Phone iPhone', 'Phones'),
(6, 'Phone Samsung', 'Phones'),
(7, 'Monitor LG', 'Accessories'),
(8, 'Keyboard Logitech', 'Accessories'),
(9, 'Mouse Logitech', 'Accessories'),
(10, 'Headset Sony', 'Accessories');
GO

-- InsÃ©rer 150,000 ventes (suffisant pour tester l'effet des partitions)
DECLARE @i INT = 1;
WHILE @i <= 150000
BEGIN
    INSERT INTO FactSales (DateKey, ProductKey, Quantity, Amount)
    VALUES (
        (SELECT TOP 1 DateKey FROM DimDate ORDER BY NEWID()),
        (ABS(CHECKSUM(NEWID())) % 10) + 1,
        (ABS(CHECKSUM(NEWID())) % 10) + 1,
        (ABS(CHECKSUM(NEWID())) % 1000) + 100
    );
    SET @i = @i + 1;
END;
GO

-- VÃ©rifier
SELECT 
    'DimDate' AS TableName, COUNT(*) AS RowCount FROM DimDate
UNION ALL
SELECT 'DimProduct', COUNT(*) FROM DimProduct
UNION ALL
SELECT 'FactSales', COUNT(*) FROM FactSales;
GO
```

**ExÃ©cuter ce script dans SSMS â†’ Vous avez maintenant une base minimale.**

---

## PARTIE 1 : CRÃ‰ER LE CUBE DE BASE (10 min)

### Pas Ã  pas SSDT

1. **Nouveau projet SSAS** :
   
   - File â†’ New â†’ Project
   - Analysis Services Multidimensional Project
   - Nom : `DemoAggregations`

2. **Data Source** :
   
   - Clic droit sur Data Sources â†’ New Data Source
   - Connection : Votre serveur â†’ Base `DemoAggregations`
   - Finish

3. **Data Source View** :
   
   - Clic droit sur Data Source Views â†’ New Data Source View
   - SÃ©lectionner les 3 tables : DimDate, DimProduct, FactSales
   - Finish

4. **Dimensions** :
   
   **Dim Date :**
   
   - Clic droit sur Dimensions â†’ New Dimension
   - Wizard : Use existing table â†’ DimDate â†’ DateKey comme clÃ©
   - Attributs : **Cocher SEULEMENT** Year, Quarter, Month
   - **NE PAS cocher** MonthName (on l'expliquera pendant la dÃ©mo)
   - Name : Dim Date â†’ Finish
   
   **Dim Product :**
   
   - New Dimension â†’ DimProduct â†’ ProductKey comme clÃ©
   - Attributs : **Cocher** Category seulement
   - Name : Dim Product â†’ Finish

5. **Cube** :
   
   - Clic droit sur Cubes â†’ New Cube
   - Use existing tables â†’ FactSales
   - Mesures : Cocher Quantity et Amount
   - Dimensions : Cocher Dim Date et Dim Product
   - Name : Sales Cube â†’ Finish

6. **Deploy Initial** :
   
   - Build â†’ Deploy Solution

âœ… **Cube de base prÃªt ! Maintenant on configure les partitions.**

---

## PARTIE 2 : COMPRENDRE LES PARTITIONS (15 min)

### Concept clÃ© : Pourquoi partitionner ?

**ScÃ©nario Ã  expliquer :**

> "Imaginez un cube avec 10 millions de lignes de ventes sur 5 ans. Si tout est dans une seule partition :
> 
> - Processing = retraiter TOUT Ã  chaque fois
> - AgrÃ©gations = gÃ©nÃ©riques pour toutes les annÃ©es
> - Performance = sous-optimale"

**Solution : Partitionnement**

| StratÃ©gie      | Description                                | Avantage                                       |
| -------------- | ------------------------------------------ | ---------------------------------------------- |
| **Par annÃ©e**  | Une partition par annÃ©e (2022, 2023, 2024) | Processing incrÃ©mental, agrÃ©gations ciblÃ©es    |
| **Par mois**   | Une partition par mois                     | TrÃ¨s granulaire, optimal pour donnÃ©es rÃ©centes |
| **Par rÃ©gion** | Une partition par zone gÃ©ographique        | Bon pour analyses rÃ©gionales                   |

### ğŸ“Š RÃˆGLE D'OR

**Les agrÃ©gations sont dÃ©finies PAR PARTITION, pas globalement.**

Chaque partition peut avoir :

- Son propre design d'agrÃ©gations
- Ses propres optimisations
- Son propre cycle de traitement
- **Son propre mode de stockage (MOLAP, ROLAP, HOLAP)**

---

## PARTIE 2.5 : MODES DE STOCKAGE DES PARTITIONS (20 min)

### Les 4 modes de stockage SSAS

**Concept fondamental :**

> "Chaque partition peut avoir un mode de stockage diffÃ©rent. Le choix impacte directement les performances, l'espace disque, et la fraÃ®cheur des donnÃ©es."

---

### 1. MOLAP (Multidimensional OLAP) â­ **LE PLUS UTILISÃ‰**

**DÃ©finition :**

- DonnÃ©es ET agrÃ©gations stockÃ©es dans des fichiers SSAS propriÃ©taires
- Aucune connexion Ã  la base source pendant les requÃªtes
- Compression trÃ¨s efficace

**Architecture :**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SQL Server (Source)                â”‚
â”‚  FactSales : 10 GB                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ Processing
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SSAS MOLAP Partition               â”‚
â”‚  - DonnÃ©es : 2 GB (compressÃ©es)     â”‚
â”‚  - AgrÃ©gations : 500 MB             â”‚
â”‚  Total : 2.5 GB                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†‘
           â”‚ RequÃªtes MDX (ultra-rapides)
           â”‚
     [Utilisateurs]
```

**CaractÃ©ristiques :**

| Aspect            | Valeur                                      |
| ----------------- | ------------------------------------------- |
| **Performance**   | â­â­â­â­â­ Excellente (tout en mÃ©moire/cache)    |
| **Espace disque** | âš ï¸ Moyen (compression 5:1 Ã  10:1)           |
| **FraÃ®cheur**     | âš ï¸ DonnÃ©es figÃ©es jusqu'au prochain Process |
| **AgrÃ©gations**   | âœ… Pleinement supportÃ©es et optimales        |
| **Usage typique** | DonnÃ©es historiques, rapports BI            |

**Exemple concret :**

```
Partition 2022 (MOLAP)
- Source : 50,000 lignes = 5 MB
- SSAS : 800 KB donnÃ©es + 200 KB aggs = 1 MB
- RequÃªte : 5 ms (tout en cache)
```

**Quand utiliser MOLAP :**

- âœ… DonnÃ©es historiques (annÃ©es prÃ©cÃ©dentes)
- âœ… Rapports avec performance critique
- âœ… Cubes avec agrÃ©gations complexes
- âœ… DonnÃ©es ne changeant pas frÃ©quemment

---

### 2. ROLAP (Relational OLAP)

**DÃ©finition :**

- Aucune donnÃ©e stockÃ©e dans SSAS
- AgrÃ©gations stockÃ©es dans SQL Server (tables indexed views)
- Chaque requÃªte MDX â†’ requÃªte SQL en temps rÃ©el

**Architecture :**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SQL Server (Source)                â”‚
â”‚  - FactSales : 10 GB                â”‚
â”‚  - Indexed Views (aggs) : 2 GB      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†‘
           â”‚ RequÃªtes SQL (pour chaque MDX)
           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SSAS ROLAP Partition               â”‚
â”‚  - DonnÃ©es : 0 GB                   â”‚
â”‚  - MÃ©tadonnÃ©es seulement            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†‘
           â”‚ RequÃªtes MDX
           â”‚
     [Utilisateurs]
```

**CaractÃ©ristiques :**

| Aspect            | Valeur                                |
| ----------------- | ------------------------------------- |
| **Performance**   | â­â­ Faible (dÃ©pend de SQL Server)      |
| **Espace disque** | â­â­â­â­â­ Minimal (SSAS ne stocke rien)   |
| **FraÃ®cheur**     | â­â­â­â­â­ Temps rÃ©el (toujours actuel)    |
| **AgrÃ©gations**   | âš ï¸ LimitÃ©es (indexed views dans SQL)  |
| **Usage typique** | DonnÃ©es trÃ¨s volumineuses, temps rÃ©el |

**Exemple concret :**

```
Partition CurrentMonth (ROLAP)
- SSAS : 0 KB (mÃ©tadonnÃ©es seulement)
- SQL : Indexed views pour agrÃ©gations
- RequÃªte : 200 ms (dÃ©pend de SQL Server)
- Avantage : DonnÃ©es toujours Ã  jour
```

**Quand utiliser ROLAP :**

- âœ… DonnÃ©es devant Ãªtre en temps rÃ©el
- âœ… Volumes trÃ¨s importants (centaines de GB)
- âœ… Espace disque limitÃ© sur SSAS
- âœ… Peu de requÃªtes concurrentes
- âŒ Pas pour des dashboards temps rÃ©el avec beaucoup d'utilisateurs

---

### 3. HOLAP (Hybrid OLAP)

**DÃ©finition :**

- AgrÃ©gations stockÃ©es dans SSAS (comme MOLAP)
- DonnÃ©es dÃ©taillÃ©es restent dans SQL Server (comme ROLAP)
- Compromis entre performance et espace disque

**Architecture :**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SQL Server (Source)                â”‚
â”‚  FactSales : 10 GB (dÃ©tail)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ RequÃªtes pour dÃ©tail seulement
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SSAS HOLAP Partition               â”‚
â”‚  - DonnÃ©es : 0 GB                   â”‚
â”‚  - AgrÃ©gations : 500 MB (SSAS)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†‘
           â”‚ RequÃªtes MDX
           â”‚
     [Utilisateurs]
```

**CaractÃ©ristiques :**

| Aspect            | Valeur                                              |
| ----------------- | --------------------------------------------------- |
| **Performance**   | â­â­â­â­ Excellente (agrÃ©gations) / â­â­ Moyenne (dÃ©tail) |
| **Espace disque** | â­â­â­â­ Faible (agrÃ©gations seulement)                 |
| **FraÃ®cheur**     | âš ï¸ Aggs figÃ©es, dÃ©tail temps rÃ©el                   |
| **AgrÃ©gations**   | âœ… Pleinement supportÃ©es (stockÃ©es dans SSAS)        |
| **Usage typique** | Gros volumes avec rapports agrÃ©gÃ©s frÃ©quents        |

**Exemple concret :**

```
Partition 2023 (HOLAP)
- SSAS : 300 MB (agrÃ©gations seulement)
- SQL : 50,000 lignes (dÃ©tail)
- RequÃªte agrÃ©gÃ©e : 10 ms (SSAS cache)
- RequÃªte dÃ©taillÃ©e : 150 ms (va dans SQL)
```

**Quand utiliser HOLAP :**

- âœ… Rapports principalement agrÃ©gÃ©s (tableaux de bord)
- âœ… Drill-down occasionnel vers le dÃ©tail
- âœ… Compromis espace/performance
- âœ… Volumes moyens Ã  Ã©levÃ©s

---

### 4. In-Memory (SSAS Tabular / DirectQuery)

**Note importante :**

> "In-Memory fait rÃ©fÃ©rence au moteur SSAS Tabular (pas Multidimensional). Dans cet atelier Multidimensional, on utilise **MOLAP** qui charge aussi les donnÃ©es en mÃ©moire pour les performances."

**Ã‰quivalence :**

- **SSAS Multidimensional MOLAP** â‰ˆ DonnÃ©es en cache mÃ©moire + fichiers disque
- **SSAS Tabular In-Memory** = Tout en RAM (xVelocity engine)
- **SSAS Tabular DirectQuery** = ROLAP (requÃªtes temps rÃ©el)

**Pour l'atelier Multidimensional, on se concentre sur MOLAP/ROLAP/HOLAP.**

---

### Comparaison des 3 modes (Multidimensional)

| CritÃ¨re             | MOLAP                    | ROLAP                 | HOLAP                                           |
| ------------------- | ------------------------ | --------------------- | ----------------------------------------------- |
| **Vitesse requÃªte** | TrÃ¨s rapide (5-20 ms)    | Lente (100-500 ms)    | Rapide aggs (10-30 ms)<br>Lent dÃ©tail (100+ ms) |
| **Espace SSAS**     | Ã‰levÃ© (donnÃ©es + aggs)   | Minimal (mÃ©tadonnÃ©es) | Moyen (aggs seulement)                          |
| **FraÃ®cheur**       | Process requis           | Temps rÃ©el            | Aggs : process<br>DÃ©tail : temps rÃ©el           |
| **AgrÃ©gations**     | Optimales                | LimitÃ©es              | Optimales                                       |
| **Processing**      | CoÃ»teux (donnÃ©es + aggs) | Rapide (mÃ©tadonnÃ©es)  | Moyen (aggs seulement)                          |
| **Compression**     | 5:1 Ã  10:1               | N/A                   | AgrÃ©gations compressÃ©es                         |

---

### ğŸ¯ STRATÃ‰GIE RECOMMANDÃ‰E : Mode hybride par partition

**Architecture optimale :**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Cube Sales (3 ans de donnÃ©es)                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                      â”‚
â”‚  Partition 2022 â†’ MOLAP                             â”‚
â”‚  - Historique, rarement modifiÃ©                     â”‚
â”‚  - AgrÃ©gations agressives (50%)                     â”‚
â”‚  - Tout en cache                                    â”‚
â”‚  - Processing : 1x/trimestre                        â”‚
â”‚                                                      â”‚
â”‚  Partition 2023 â†’ MOLAP                             â”‚
â”‚  - RÃ©cent mais stable                               â”‚
â”‚  - AgrÃ©gations modÃ©rÃ©es (30%)                       â”‚
â”‚  - Processing : 1x/mois                             â”‚
â”‚                                                      â”‚
â”‚  Partition 2024 Jan-Nov â†’ HOLAP                     â”‚
â”‚  - DonnÃ©es stabilisÃ©es                              â”‚
â”‚  - AgrÃ©gations lÃ©gÃ¨res (20%)                        â”‚
â”‚  - Processing : 1x/semaine                          â”‚
â”‚                                                      â”‚
â”‚  Partition 2024 Dec (courant) â†’ ROLAP              â”‚
â”‚  - DonnÃ©es changeant constamment                    â”‚
â”‚  - Pas d'agrÃ©gations (ou SQL indexed views)         â”‚
â”‚  - Temps rÃ©el                                       â”‚
â”‚                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Avantages de cette approche :**

1. **Performance optimale** : Historique ultra-rapide (MOLAP)
2. **FraÃ®cheur** : Mois courant toujours Ã  jour (ROLAP)
3. **Espace maÃ®trisÃ©** : Anciens mois en HOLAP (agrÃ©gations seulement)
4. **Processing efficace** : Anciennes partitions rarement retraitÃ©es

---

### DÃ©monstration : Changer le mode de stockage

**On va crÃ©er 3 partitions avec 3 modes diffÃ©rents**

#### Configuration sera dans la Partie 3 (suite)

---

## PARTIE 3 : CRÃ‰ER DES PARTITIONS AVEC MODES DE STOCKAGE (30 min)

### Ã‰tape 1 : Ouvrir le Partition Manager

1. Ouvrir `Sales Cube.cube`
2. Onglet **Partitions**
3. Vous voyez : `Fact Sales` (partition par dÃ©faut)

### Ã‰tape 2 : CrÃ©er des partitions par annÃ©e avec modes diffÃ©rents

**IMPORTANT : On va crÃ©er 3 partitions (2022, 2023, 2024) avec 3 modes de stockage diffÃ©rents**

**StratÃ©gie :**

- 2022 â†’ **MOLAP** (historique, performance max)
- 2023 â†’ **HOLAP** (compromis espace/performance)
- 2024 â†’ **ROLAP** (mois courant, temps rÃ©el)

---

#### Partition 2022 - MOLAP

1. **Clic droit** sur `Fact Sales` â†’ **PropriÃ©tÃ©**

2. Changer le nom de **Fact Sales** Ã  **Fact Sales 2022**

3. Changer la propriÃ©tÃ© **Source** :
   
   - Type de liaison : Liaison de requÃªte
   - Query :
   
   ```sql
   SELECT [dbo].[FactSales].[DateKey],[dbo].[FactSales].[ProductKey],[dbo].[FactSales].[Quantity],[dbo].[FactSales].[Amount]
     FROM [dbo].[FactSales]
           WHERE DateKey >= 20220101 AND DateKey < 20230101
   ```

4. Cliquez **OK**

5. Vous obtenez une partition avec **Nom de partition** : `Fact Sales 2022`
   
   et **source** n'est plus vide  et le mode de stockage **MOLAP**

**Configuration du mode de stockage :**

8. Onglet **Partitions**, **clic droit** sur `Fact Sales 2022` â†’ **Storage Settings...**
9. **Standard setting** : SÃ©lectionner **MOLAP**
10. **Options** :
    - âœ… Activer la mise en cache proactive (dÃ©sactivÃ© pour le moment)
    - Aggregation options : (on le fera dans Partie 4)
11. OK

**Explication pendant la dÃ©mo :**

> "MOLAP pour 2022 car :
> 
> - DonnÃ©es historiques, ne changent plus
> - On veut la performance maximale
> - AgrÃ©gations agressives possibles
> - Processing 1x/trimestre suffit"

---

#### Partition 2023 - HOLAP

1. **Clic droit** sur la table â†’ **New Partition**

2. Query :
   
   ```sql
   SELECT * FROM FactSales WHERE DateKey >= 20230101 AND DateKey < 20240101
   ```

3. Name : `Fact Sales 2023`

4. Seelctionnez **CrÃ©er les agrÃ©gations plus tard** et puis **Terminer**

**Configuration HOLAP :**

5. **Clic droit** sur `Fact Sales 2023` â†’ **Storage Settings...**

6. **Standard setting** : SÃ©lectionner **HOLAP**

7. **Notification** :
   
   ```
   HOLAP stores aggregations in SSAS multidimensional format,but leaves detail data in the relational source.
   ```

8. OK

**Explication pendant la dÃ©mo :**

> "HOLAP pour 2023 car :
> 
> - DonnÃ©es assez rÃ©centes, quelques modifications possibles
> - Ã‰conomie d'espace (pas de donnÃ©es dÃ©taillÃ©es dans SSAS)
> - AgrÃ©gations performantes pour les rapports
> - Drill-down vers SQL si besoin de dÃ©tail"

---

#### Partition 2024 - ROLAP

1. **Clic droit** â†’ **New Partition**

2. Query :
   
   ```sql
   SELECT * FROM FactSales WHERE DateKey >= 20240101 AND DateKey < 20250101
   ```

3. Name : `Fact Sales 2024`

4. SÃ©lÃ©ctionnez **CrÃ©er les agrÃ©gations** plus tard et puis **Terminer**

**Configuration ROLAP :**

5. **Clic droit** sur `Fact Sales 2024` â†’ **Storage Settings...**

6. **Standard setting** : SÃ©lectionner **ROLAP**
   
   Vous avez rÃ©ussi Ã  crÃ©er les 3 partitions. Mais il y a le warning qui dit :
   
   "DÃ©finir la propriÃ©tÃ© Slice des partitions avec le mode de stockage ROLAP ou avec les paramÃ¨tres de mise en cache proactive qui autorisent l'accÃ¨s au mode ROLAP."
   
   Ce warning est **normal et pas bloquant** pour la partition 2024 en ROLAP. Cependant, il faut configurer la propriÃ©tÃ© **Slice** pour optimiser les performances.
   
   ## Solution : Configurer la propriÃ©tÃ© Slice
   
   La propriÃ©tÃ© **Slice** indique Ã  SSAS quelle portion des donnÃ©es contient chaque partition. C'est crucial pour les partitions ROLAP et HOLAP.
   
   ### Ã‰tapes pour corriger :
   
   1. **SÃ©lectionnez la partition `Fact Sales 2024`** (elle est dÃ©jÃ  sÃ©lectionnÃ©e dans votre capture)
   
   2. Dans le panneau **PropriÃ©tÃ©s** Ã  droite, trouvez la section **"Configurable"**
   
   3. Cherchez la propriÃ©tÃ© **"Slice"** (elle devrait Ãªtre vide : `(aucun)`)
   
   4. **Cliquez sur la valeur** de Slice â†’ Un bouton `...` devrait apparaÃ®tre
   
   5. **DÃ©finissez le Slice** avec cette expression MDX :
      
      ```mdx
      [Dim Date].[Year].[Year].&[2024]
      ```
      
      Ou en format complet si nÃ©cessaire :
      
      ```mdx
      {[Dim Date].[Year].[Year].&[2024]}
      ```
      
      ## Pourquoi c'est important ?
      
      Le **Slice** permet Ã  SSAS de savoir :
      
      - Partition 2022 â†’ contient uniquement l'annÃ©e 2022
      - Partition 2023 â†’ contient uniquement l'annÃ©e 2023
      - Partition 2024 â†’ contient uniquement l'annÃ©e 2024
      
      **Sans Slice**, quand une requÃªte demande "2024", SSAS pourrait interroger TOUTES les partitions au lieu de seulement celle de 2024.
      
      ## Configurez les Slices pour toutes les partitions
      
      **Pour Fact Sales 2022 :**
      
      [Dim Date].[Year].[Year].&[2022]
      
      **Pour Fact Sales 2023 :**
      
      [Dim Date].[Year].[Year].&[2023]
      
      **Pour Fact Sales 2024 :**
      
      [Dim Date].[Year].[Year].&[2024]

      ### VÃ©rification
    
      AprÃ¨s avoir configurÃ© les Slices :
    
      1. Le warning jaune devrait disparaÃ®tre
      2. **Build â†’ Deploy Solution**
      3. **Process** le cube
    
    
    
         Votre configuration actuelle montre :
         - âœ… Fact Sales 2022 : MOLAP (bon pour historique)
         - âœ… Fact Sales 2023 : HOLAP (bon pour compromis)
         - âœ… Fact Sales 2024 : ROLAP (bon pour temps rÃ©el)

**Explication pendant la dÃ©mo :**

> "ROLAP pour 2024 car :
> 
> - Mois courant, donnÃ©es changent constamment
> - Besoin de temps rÃ©el (ventes d'aujourd'hui)
> - Aucun processing requis
> - Trade-off : performance plus faible mais donnÃ©es actuelles"

---

### Ã‰tape 3 : Supprimer la partition par dÃ©faut

1. **Clic droit** sur `Fact Sales` (partition originale) â†’ **Delete**
2. Confirm

**RÃ©sultat final :**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Partition        â”‚ Storage     â”‚ Aggregation Design   â”‚ Size       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Fact Sales 2022  â”‚ MOLAP       â”‚ (none yet)           â”‚ To process â”‚
â”‚ Fact Sales 2023  â”‚ HOLAP       â”‚ (none yet)           â”‚ To process â”‚
â”‚ Fact Sales 2024  â”‚ ROLAP       â”‚ (none yet)           â”‚ 0 KB       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Ã‰tape 4 : Deploy et Process

1. **Build â†’ Deploy Solution**
2. Une fois dÃ©ployÃ© :
   - Clic droit sur cube â†’ **Process**
   - Process Full
   - Run â†’ Observer le processing

---

### ğŸ§ª Test de performance : Impact du mode de stockage

**Query 1 : AgrÃ©gation simple sur MOLAP (2022)**

```mdx
SELECT 
    [Measures].[Amount] ON COLUMNS,
    [Dim Date].[Year].[Year].&[2022] ON ROWS
FROM  [Demo Aggregations];
```

**Temps attendu :** ~5-10 ms (donnÃ©es en cache SSAS)

---

**Query 2 : AgrÃ©gation sur HOLAP (2023)**

```mdx
SELECT 
    [Measures].[Amount] ON COLUMNS,
    [Dim Date].[Year].[Year].&[2023] ON ROWS
FROM [Demo Aggregations];
```

**Temps attendu :** ~10-20 ms (agrÃ©gations en cache SSAS)

---

**Query 3 : AgrÃ©gation sur ROLAP (2024)**

```mdx
SELECT 
    [Measures].[Amount] ON COLUMNS,
    [Dim Date].[Year].[Year].&[2024] ON ROWS
FROM [Demo Aggregations];
```

**Temps attendu :** ~50-100 ms (requÃªte SQL vers source)

---

**Query 4 : Drill-down dÃ©taillÃ© sur HOLAP (2023)**

```mdx
SELECT 
    [Measures].[Amount] ON COLUMNS,
    NON EMPTY [Dim Product].[Product Name].[Product Name].Members ON ROWS
FROM [Sales Cube]
WHERE [Dim Date].[Year].[Year].&[2023];
```

**Temps attendu :** ~80-150 ms (dÃ©tail rÃ©cupÃ©rÃ© depuis SQL Server)

---

### ğŸ“Š Tableau comparatif des rÃ©sultats

| Query              | MOLAP (2022)   | HOLAP (2023)                        | ROLAP (2024) |
| ------------------ | -------------- | ----------------------------------- | ------------ |
| AgrÃ©gation Year    | ~8 ms          | ~15 ms                              | ~75 ms       |
| Drill-down dÃ©tail  | ~10 ms         | ~120 ms                             | ~150 ms      |
| Espace disque SSAS | 2.5 MB         | 0.8 MB                              | 0 KB         |
| FraÃ®cheur          | Process requis | Aggs: process<br>DÃ©tail: temps rÃ©el | Temps rÃ©el   |

**Conclusion Ã  expliquer :**

> "Chaque mode a ses avantages :
> 
> - MOLAP = performance max, espace max, processing requis
> - HOLAP = compromis, rapide sur agrÃ©gations, drill-down plus lent
> - ROLAP = temps rÃ©el, lent, pas d'espace SSAS"

---

## PARTIE 4 : DESIGN AGGREGATIONS PAR PARTITION (30 min)

### Concept : StratÃ©gie diffÃ©renciÃ©e

**Principe Ã  expliquer :**

> "Les donnÃ©es anciennes (2022) sont rarement consultÃ©es au dÃ©tail â†’ AgrÃ©gations agressives
> Les donnÃ©es rÃ©centes (2024) sont souvent consultÃ©es â†’ AgrÃ©gations modÃ©rÃ©es"

### StratÃ©gie d'agrÃ©gation

| Partition            | Performance Gain | Raison                          |
| -------------------- | ---------------- | ------------------------------- |
| 2022 (historique)    | 50%              | DonnÃ©es stables, peu de dÃ©tail  |
| 2023 (intermÃ©diaire) | 30%              | Usage modÃ©rÃ©                    |
| 2024 (courante)      | 20%              | Beaucoup de requÃªtes dÃ©taillÃ©es |

---

### DÃ‰MO 1 : Design pour Partition 2022 (50%)

#### Ã‰tape 1 : Lancer

1. Onglet **Aggregations**
2. **Clic droit** sur `Fact Sales 2022` â†’ **Design Aggregations...**

#### Ã‰tape 2 : Welcome â†’ Next

#### Ã‰tape 3 : Review Aggregation Usage â­ **L'Ã‰CRAN CLÃ‰**

**CE QU'ON VOIT :**

```
Cube Objects         | Default | Full | None | Unrestricted
---------------------|---------|------|------|-------------
Dim Date             | 3       | 0    | 0    | 0
  Year               | â—       |      |      |
  Quarter            | â—       |      |      |
  Month              | â—       |      |      |
Dim Product          | 1       | 0    | 0    | 0
  Category           | â—       |      |      |
```

**MODIFICATION IMPORTANTE :**

> "Pour 2022, Year est TOUJOURS utilisÃ© â†’ Mettre en Full"

1. **Cliquer** sur Year Ã— Full
2. Result :

```
Dim Date             | 2       | 1    | 0    | 0
```

3. Next

#### Ã‰tape 4 : Review Object Counts

**CE QU'ON VOIT :**

```
Partition                 | Estimated Rows
--------------------------|---------------
Fact Sales 2022           | ~50,000

Dimension                 | Estimated Members
--------------------------|------------------
Dim Date                  | 365 (annÃ©e 2022)
Dim Product               | 10
```

**EXPLICATION :**

> "SSAS estime ~50,000 lignes pour 2022. Si ce n'est pas correct, cliquez sur Count."

4. Next

#### Ã‰tape 5 : Set Aggregation Options

**CE QU'ON VOIT :**

```
â—‹ Estimated storage reaches : [  50  ] MB
â— Performance gain reaches  : [ 50 ] %
â—‹ I click Stop
â—‹ Do not design aggregations (0%)
```

**DÃ‰MONSTRATION :**

1. SÃ©lectionner **Performance gain reaches : 50%**
2. Cliquer **Start**

**Animation :**

```
Designing Aggregations...

Aggregations     : 0 â†’ 5 â†’ 10 â†’ 15 â†’ 18 â†’ 22 âœ“
Estimated Storage: 0 MB â†’ 1.2 MB â†’ 2.8 MB â†’ 4.5 MB
Performance Gain : 0% â†’ 15% â†’ 30% â†’ 42% â†’ 51% âœ“

[=====================>]
```

**DIRE PENDANT QUE Ã‡A TOURNE :**

- "SSAS teste plein de combinaisons"

- "Year est dans TOUTES car on l'a mis en Full"

- "Il s'arrÃªte Ã  51% - mission accomplie"
3. **Noter les rÃ©sultats** :
   
   - Aggregations : ____ (environ 22)
   - Storage : ____ MB (environ 4.5)
   - Gain : ____% (51%)

4. Next â†’ Finish

---

### DÃ‰MO 2 : Design pour Partition 2023 (30%)

1. **Clic droit** sur `Fact Sales 2023` â†’ **Design Aggregations...**
2. **Review Aggregation Usage** :
   - Year â†’ Full (mÃªme stratÃ©gie)
   - Next
3. **Set Aggregation Options** :
   - Performance gain : **30%**
   - Start

**RÃ©sultats attendus :**

- Aggregations : environ 12

- Storage : environ 2.5 MB

- Gain : 31%
4. Next â†’ Finish

---

### DÃ‰MO 3 : Design pour Partition 2024 (20%)

1. **Clic droit** sur `Fact Sales 2024` â†’ **Design Aggregations...**
2. **Review Aggregation Usage** :
   - Year â†’ Full
   - Next
3. **Set Aggregation Options** :
   - Performance gain : **20%**
   - Start

**RÃ©sultats attendus :**

- Aggregations : environ 7

- Storage : environ 1.5 MB

- Gain : 21%
4. Next â†’ Finish

---

### RÃ©sultat Final

**Vue dans l'onglet Aggregations :**

```
Fact Sales 2022  | Aggregation Design 1  | 22 aggs | 4.5 MB | 51%
Fact Sales 2023  | Aggregation Design 2  | 12 aggs | 2.5 MB | 31%
Fact Sales 2024  | Aggregation Design 3  |  7 aggs | 1.5 MB | 21%
```

### Ã‰tape 5 : Deploy et Process

1. **Build â†’ Deploy Solution**
2. Clic droit sur cube â†’ **Process**
3. Process Full â†’ Run â†’ Close

âœ… **AgrÃ©gations optimisÃ©es par partition !**

---

## PARTIE 5 : TESTS DE PERFORMANCE (15 min)

### Test 1 : Query sur annÃ©e historique (2022)

```mdx
SELECT 
    [Measures].[Amount] ON COLUMNS,
    [Dim Date].[Year].[Year].&[2022] ON ROWS
FROM [Sales Cube];
```

**Attendu :** RÃ©ponse trÃ¨s rapide (agrÃ©gation Year existe)

### Test 2 : Query dÃ©taillÃ©e sur 2024

```mdx
SELECT 
    [Measures].[Amount] ON COLUMNS,
    NON EMPTY [Dim Date].[Month].[Month].Members ON ROWS
FROM [Sales Cube]
WHERE [Dim Date].[Year].[Year].&[2024];
```

**Attendu :** LÃ©gÃ¨rement plus lent (moins d'agrÃ©gations sur 2024)

### Test 3 : Query cross-partition

```mdx
SELECT 
    [Measures].[Amount] ON COLUMNS,
    [Dim Date].[Year].[Year].Members ON ROWS
FROM [Sales Cube];
```

**Attendu :** SSAS combine les agrÃ©gations de toutes les partitions

---

## PARTIE 6 : USAGE-BASED OPTIMIZATION (20 min)

### Concept : Optimisation basÃ©e sur l'utilisation rÃ©elle

**ScÃ©nario :**

> "Design Aggregations devine. Usage-Based regarde ce que les VRAIS utilisateurs font."

### Ã‰tape 0 : Activer le Query Log

**Dans SSMS, connectÃ© Ã  SSAS :**

1. Clic droit sur serveur â†’ **Properties**
2. Cocher **Show Advanced**
3. Trouver **Log\QueryLog\CreateQueryLogTable** â†’ `True`
4. **Log\QueryLog\QueryLogConnectionString** â†’ (laisser vide = mÃªme serveur)
5. **Log\QueryLog\QueryLogSampling** â†’ `10` (Ã©chantillonnage)
6. OK

### Ã‰tape 1 : GÃ©nÃ©rer des requÃªtes utilisateur

**ExÃ©cuter ces requÃªtes 10 fois chacune :**

```mdx
-- RequÃªte frÃ©quente 1 : Par Year et Category sur 2024
SELECT 
    [Measures].[Amount] ON COLUMNS,
    [Dim Date].[Year].[Year].&[2024] ON ROWS
FROM [Sales Cube]
WHERE [Dim Product].[Category].[Category].&[Computers];

-- RequÃªte frÃ©quente 2 : Par Quarter sur 2024
SELECT 
    [Measures].[Quantity] ON COLUMNS,
    [Dim Date].[Quarter].[Quarter].Members ON ROWS
FROM [Sales Cube]
WHERE [Dim Date].[Year].[Year].&[2024];

-- RequÃªte frÃ©quente 3 : Par Month + Category sur 2023
SELECT 
    [Measures].[Amount] ON COLUMNS,
    [Dim Date].[Month].[Month].Members ON ROWS
FROM [Sales Cube]
WHERE ([Dim Date].[Year].[Year].&[2023],
       [Dim Product].[Category].[Category].&[Phones]);
```

### Ã‰tape 2 : VÃ©rifier le log

**Dans SSMS (SQL Server, pas SSAS) :**

```sql
USE master;
SELECT TOP 20 
    MSOLAP_Database,
    MSOLAP_ObjectPath,
    StartTime,
    Duration
FROM OlapQueryLog 
ORDER BY StartTime DESC;
```

**Vous devez voir vos requÃªtes.**

### Ã‰tape 3 : Lancer Usage-Based Optimization pour 2024

1. Onglet **Aggregations**
2. **Clic droit** sur `Fact Sales 2024` â†’ **Usage Based Optimization...**

**Wizard :**

**Ã‰cran 1 : Specify Query Criteria**

- Beginning date : (Aujourd'hui - 1 jour)
- Ending date : Aujourd'hui
- Filter :
  - Partition : Fact Sales 2024
- Next

**Ã‰cran 2 : Review queries**

- Vous voyez vos requÃªtes listÃ©es avec leur frÃ©quence
- **Cocher** les 2-3 requÃªtes sur 2024
- Next

**Ã‰cran 3-5 : MÃªme que Design Aggregations**

- Review Aggregation Usage â†’ Next
- Review Object Counts â†’ Next
- Set Aggregation Options :
  - Performance gain : **30%**
  - Start

**EXPLICATION :**

> "Cette fois, SSAS a crÃ©Ã© des agrÃ©gations spÃ©cifiquement pour Quarter+Computers, Month+Phones, car c'est ce qu'on utilise vraiment sur 2024 !"

**RÃ©sultat :**

- Nouvelles agrÃ©gations : +5 (total ~12)

- Storage : +1 MB (total ~2.5 MB)

- Gain : augmente de 21% â†’ 32%
4. Next â†’ Finish

### Ã‰tape 4 : Deploy et Re-test

1. **Build â†’ Deploy**
2. Process cube
3. Re-exÃ©cuter les requÃªtes frÃ©quentes â†’ Beaucoup plus rapides !

---

## PARTIE 7 : ASSIGN AGGREGATION DESIGN (10 min)

### ScÃ©nario : RÃ©utiliser un design existant

> "J'ai crÃ©Ã© un super design pour 2023. Je veux l'appliquer Ã  2022 aussi."

### MÃ©thode

1. Onglet **Aggregations**
2. **Clic droit** sur `Fact Sales 2022` â†’ **Assign Aggregation Design...**
3. **SÃ©lectionner** : `Aggregation Design 2` (celui de 2023)
4. OK

**RÃ©sultat :**

```
Fact Sales 2022  | Aggregation Design 2  | (partage avec 2023)
Fact Sales 2023  | Aggregation Design 2  |
```

**EXPLICATION :**

> "Les deux partitions partagent maintenant le mÃªme design. TrÃ¨s utile pour des partitions de structure identique."

**âš ï¸ ATTENTION :**

- Les agrÃ©gations sont toujours **calculÃ©es et stockÃ©es sÃ©parÃ©ment** par partition
- Seul le **plan d'agrÃ©gation** est partagÃ©
- Si les donnÃ©es sont diffÃ©rentes (ex: 2022 a 50K lignes, 2023 a 100K), les agrÃ©gations physiques seront diffÃ©rentes

---

## PARTIE 8 : BONNES PRATIQUES (15 min)

### RÃ¨gle 1 : Partitionner par usage ET mode de stockage

| Type de donnÃ©es                  | StratÃ©gie de partition | Mode de stockage   | AgrÃ©gations         | Processing   |
| -------------------------------- | ---------------------- | ------------------ | ------------------- | ------------ |
| **Historiques** (> 2 ans)        | Par annÃ©e              | **MOLAP**          | Agressives (50-70%) | 1x/trimestre |
| **RÃ©centes** (< 1 an)            | Par mois               | **HOLAP**          | ModÃ©rÃ©es (20-30%)   | 1x/semaine   |
| **Courantes** (mois actuel)      | Partition unique       | **ROLAP**          | LÃ©gÃ¨res ou aucune   | Temps rÃ©el   |
| **TrÃ¨s volumineuses** (> 500 GB) | Par annÃ©e + rÃ©gion     | **HOLAP ou ROLAP** | Minimales           | Variable     |

### RÃ¨gle 2 : Choisir le bon mode de stockage

**Arbre de dÃ©cision :**

```
Les donnÃ©es changent-elles frÃ©quemment ?
â”‚
â”œâ”€ NON (historique)
â”‚  â”‚
â”‚  â””â”€ Volume important (> 100 GB) ?
â”‚     â”‚
â”‚     â”œâ”€ OUI â†’ HOLAP (agrÃ©gations performantes, Ã©conomie d'espace)
â”‚     â”‚
â”‚     â””â”€ NON â†’ MOLAP (performance maximale)
â”‚
â””â”€ OUI (temps rÃ©el requis)
   â”‚
   â””â”€ Performance critique ?
      â”‚
      â”œâ”€ OUI â†’ MOLAP + Proactive Caching (cache auto-refresh)
      â”‚
      â””â”€ NON â†’ ROLAP (toujours Ã  jour)
```

### RÃ¨gle 3 : Utiliser Aggregation Usage (par mode)

**Pour chaque attribut :**

| Usage                 | MOLAP        | HOLAP   | ROLAP                   |
| --------------------- | ------------ | ------- | ----------------------- |
| **Toujours utilisÃ©**  | Full         | Full    | N/A (indexed views SQL) |
| **Souvent utilisÃ©**   | Default      | Default | N/A                     |
| **Rarement utilisÃ©**  | None         | None    | N/A                     |
| **Haute cardinalitÃ©** | Unrestricted | None    | N/A                     |

**Note pour ROLAP :**

- Les agrÃ©gations SSAS ne s'appliquent pas

- CrÃ©er des indexed views dans SQL Server pour performance

- Exemple :
  
  ```sql
  CREATE VIEW AggSales2024_YearWITH SCHEMABINDINGASSELECT     d.Year,    SUM(f.Amount) as TotalAmount,    COUNT_BIG(*) as RowCountFROM dbo.FactSales fINNER JOIN dbo.DimDate d ON f.DateKey = d.DateKeyWHERE d.Year = 2024GROUP BY d.Year;CREATE UNIQUE CLUSTERED INDEX IX_AggSales2024_Year ON AggSales2024_Year(Year);
  ```

### RÃ¨gle 4 : HiÃ©rarchies naturelles prioritaires (selon mode)

**MOLAP :**

- Toutes les hiÃ©rarchies naturelles bÃ©nÃ©ficient des agrÃ©gations
- Year â†’ Quarter â†’ Month â†’ Day (temporelle) âœ…
- Country â†’ Region â†’ City (gÃ©ographique) âœ…

**HOLAP :**

- AgrÃ©gations hauts niveaux (Year, Country) âœ…
- Drill-down vers SQL pour dÃ©tails (Day, City) âš ï¸

**ROLAP :**

- Pas d'agrÃ©gations SSAS
- Indexer les colonnes de hiÃ©rarchies dans SQL Server
- CrÃ©er des indexed views pour combinaisons frÃ©quentes

### RÃ¨gle 5 : Ã‰viter la sur-agrÃ©gation (impact par mode)

**MOLAP - Signe d'alerte :**

- Storage > 30% de la taille des donnÃ©es brutes
- Processing time > 1 heure pour 1 GB de donnÃ©es
- Performance gain stagne (50% â†’ 51% pour +20 agrÃ©gations)

**HOLAP - Signe d'alerte :**

- Aggregation storage > 50% de la taille source
- Drill-down vers dÃ©tail systÃ©matiquement lent

**ROLAP - Signe d'alerte :**

- Queries > 5 secondes systÃ©matiquement
- SQL Server CPU > 80% pendant les requÃªtes
- Solution : passer en HOLAP ou crÃ©er indexed views

### RÃ¨gle 6 : Proactive Caching (hybride MOLAP temps rÃ©el)

**Concept :**

> "Proactive Caching permet d'avoir MOLAP (performance) avec fraÃ®cheur quasi-temps rÃ©el (auto-refresh)"

**Configuration :**

1. **Clic droit** sur partition MOLAP â†’ **Storage Settings...**
2. **Enable proactive caching** âœ…
3. **Settings** :
   - **Silence interval** : 10 seconds (attendre 10s sans changement avant process)
   - **Silence override** : 10 minutes (forcer process aprÃ¨s 10 min max)
   - **Update cache periodically** : 1 hour (refresh pÃ©riodique)

**Cas d'usage :**

```
Partition CurrentMonth (2024-12)
- Mode : MOLAP + Proactive Caching
- FraÃ®cheur : 10s Ã  10 min aprÃ¨s modification SQL
- Performance : Comme MOLAP pur
- IdÃ©al : DonnÃ©es qui changent 10-100 fois/jour (pas milliers)
```

### RÃ¨gle 7 : Timeline de maintenance en production

**Timeline rÃ©aliste avec modes mixtes :**

#### Maintenance mensuelle (dÃ©but de mois)

1. **CrÃ©er nouvelle partition** pour le mois courant
   
   ```
   Janvier 2025 (nouveau)
   - Mode : ROLAP (ou MOLAP + Proactive Caching)
   - AgrÃ©gations : Aucune (temps rÃ©el)
   ```

2. **Convertir le mois prÃ©cÃ©dent** (DÃ©cembre 2024)
   
   ```
   ROLAP â†’ HOLAP
   - Ajouter agrÃ©gations (20%)
   - Process Full
   - DonnÃ©es stabilisÃ©es
   ```

3. **Optimiser les mois -2 Ã  -12** (si nÃ©cessaire)
   
   ```
   HOLAP reste HOLAP
   - Usage-Based Optimization (si query logs disponibles)
   ```

#### Maintenance trimestrielle

1. **Convertir Q-1 en MOLAP**
   
   ```
   Exemple : Fin Mars 2025
   - Q4 2024 (Oct-Nov-Dec) : HOLAP â†’ MOLAP
   - AgrÃ©gations agressives (40-50%)
   - Compression maximale
   ```

2. **RÃ©-analyser les agrÃ©gations**
   
   - Query logs sur 3 mois
   - Usage-Based Optimization

#### Maintenance annuelle

1. **Consolider les annÃ©es N-2+**
   
   ```
   Exemple : 2023 et avant
   - Merger les partitions mensuelles en annuelle (optionnel)
   - Mode : MOLAP
   - AgrÃ©gations : 60-70%
   - Processing : 1x/an
   ```

2. **Archivage** (optionnel)
   
   ```
   AnnÃ©es > N-5
   - Exporter vers fichiers
   - Ou cubes sÃ©parÃ©s (archives)
   ```

### RÃ¨gle 8 : Monitoring des modes de stockage

**RequÃªtes DMV pour surveiller :**

```sql
-- Voir les partitions et leurs modes
SELECT 
    CUBE_NAME,
    MEASUREGROUP_NAME,
    PARTITION_NAME,
    TYPE as StorageMode,
    ROWS,
    AGGREGATION_DESIGN_ID,
    DATA_SIZE_BYTES / 1024 / 1024 as SizeMB
FROM $SYSTEM.DISCOVER_PARTITIONS
WHERE CUBE_NAME = 'Sales Cube'
ORDER BY PARTITION_NAME;

-- StorageMode values:
-- 1 = MOLAP
-- 2 = ROLAP  
-- 3 = HOLAP
```

**Alertes Ã  configurer :**

| MÃ©trique                 | Seuil        | Action                                 |
| ------------------------ | ------------ | -------------------------------------- |
| MOLAP partition data age | > 24h        | VÃ©rifier processing schedule           |
| ROLAP query duration avg | > 2s         | CrÃ©er indexed views SQL                |
| HOLAP drill-down avg     | > 5s         | ConsidÃ©rer conversion MOLAP            |
| Storage growth           | > 50 GB/mois | Revoir stratÃ©gie compression/archivage |

---

## ARCHITECTURE FINALE RECOMMANDÃ‰E

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Cube Sales Production (5 ans de donnÃ©es, 500 GB source)          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  ğŸ“¦ AnnÃ©es 2020-2022 (Historique lointain)                        â”‚
â”‚     - Mode : MOLAP                                                 â”‚
â”‚     - Partitionnement : Par annÃ©e (3 partitions)                  â”‚
â”‚     - AgrÃ©gations : 60-70% (trÃ¨s agressives)                      â”‚
â”‚     - Storage SSAS : 15 GB (compression 10:1)                     â”‚
â”‚     - Processing : 1x/trimestre                                    â”‚
â”‚     - Usage : Rapports annuels, analyses de tendances             â”‚
â”‚                                                                     â”‚
â”‚  ğŸ“¦ AnnÃ©e 2023 (Historique rÃ©cent)                                â”‚
â”‚     - Mode : MOLAP                                                 â”‚
â”‚     - Partitionnement : Par mois (12 partitions)                  â”‚
â”‚     - AgrÃ©gations : 40-50%                                        â”‚
â”‚     - Storage SSAS : 12 GB                                        â”‚
â”‚     - Processing : 1x/mois                                         â”‚
â”‚     - Usage : Rapports mensuels, comparaisons YoY                 â”‚
â”‚                                                                     â”‚
â”‚  ğŸ“¦ AnnÃ©e 2024 Jan-Oct (DonnÃ©es stabilisÃ©es)                      â”‚
â”‚     - Mode : HOLAP                                                 â”‚
â”‚     - Partitionnement : Par mois (10 partitions)                  â”‚
â”‚     - AgrÃ©gations : 20-30% (agrÃ©gations seulement)               â”‚
â”‚     - Storage SSAS : 3 GB (agrÃ©gations)                           â”‚
â”‚     - Storage SQL : 80 GB (donnÃ©es dÃ©taillÃ©es)                    â”‚
â”‚     - Processing : 1x/semaine                                      â”‚
â”‚     - Usage : Dashboards, analyses opÃ©rationnelles                â”‚
â”‚                                                                     â”‚
â”‚  ğŸ“¦ Novembre 2024 (Mois prÃ©cÃ©dent)                                â”‚
â”‚     - Mode : HOLAP avec agrÃ©gations optimisÃ©es                    â”‚
â”‚     - Partitionnement : 1 partition                               â”‚
â”‚     - AgrÃ©gations : 20% (Usage-Based)                             â”‚
â”‚     - Storage SSAS : 400 MB                                        â”‚
â”‚     - Processing : 1x/jour                                         â”‚
â”‚     - Usage : Analyses rÃ©centes, corrections de donnÃ©es           â”‚
â”‚                                                                     â”‚
â”‚  ğŸ“¦ DÃ©cembre 2024 (Mois courant)                                  â”‚
â”‚     - Mode : MOLAP + Proactive Caching                            â”‚
â”‚     - Partitionnement : 1 partition                               â”‚
â”‚     - AgrÃ©gations : 15% (lÃ©gÃ¨res)                                 â”‚
â”‚     - Storage SSAS : 500 MB                                        â”‚
â”‚     - Refresh : Auto (10s-10min aprÃ¨s changement SQL)             â”‚
â”‚     - Usage : Dashboards temps rÃ©el, monitoring quotidien         â”‚
â”‚                                                                     â”‚
â”‚  ğŸ“Š TOTAUX                                                         â”‚
â”‚     - Partitions : 27 (3 + 12 + 10 + 1 + 1)                       â”‚
â”‚     - Storage SSAS : ~31 GB                                        â”‚
â”‚     - Storage SQL : ~400 GB (source complÃ¨te)                     â”‚
â”‚     - Compression ratio : 12:1                                     â”‚
â”‚     - FraÃ®cheur : 10s Ã  10min (mois courant)                      â”‚
â”‚     - Performance : < 50ms (95% des requÃªtes)                     â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Avantages de cette architecture :**

1. âœ… **Performance optimale** : 95% requÃªtes < 50ms
2. âœ… **Espace maÃ®trisÃ©** : Compression 12:1 global
3. âœ… **FraÃ®cheur** : Mois courant quasi temps-rÃ©el
4. âœ… **Maintenance simplifiÃ©e** : Processing diffÃ©renciÃ©
5. âœ… **Ã‰volutivitÃ©** : Ajout facile de nouvelles partitions
6. âœ… **CoÃ»t optimisÃ©** : HOLAP Ã©conomise 80% espace sur rÃ©cent

---

## TABLEAU RÃ‰CAPITULATIF : 3 MÃ‰THODES D'AGRÃ‰GATION Ã— 3 MODES DE STOCKAGE

### A. MÃ©thodes d'agrÃ©gation (identique tous modes sauf ROLAP)

| MÃ©thode                       | Quand l'utiliser                                                                                 | Avantages                                                                            | InconvÃ©nients                                                                                   |
| ----------------------------- | ------------------------------------------------------------------------------------------------ | ------------------------------------------------------------------------------------ | ----------------------------------------------------------------------------------------------- |
| **Design Aggregations**       | - Nouveau cube<br>- Pas d'historique d'usage<br>- Mise en place initiale                         | - Rapide<br>- Automatique<br>- Couvre les cas gÃ©nÃ©raux                               | - GÃ©nÃ©rique<br>- Pas optimisÃ© pour usage rÃ©el<br>- Peut crÃ©er des agrÃ©gations inutiles          |
| **Usage-Based Optimization**  | - AprÃ¨s 1-2 semaines en prod<br>- Quand on a des query logs<br>- Pour affiner un design existant | - CiblÃ© sur usage rÃ©el<br>- Performance maximale<br>- Ã‰vite les agrÃ©gations inutiles | - Besoin de query log<br>- Peut biaiser vers utilisateurs actuels<br>- Ã€ refaire pÃ©riodiquement |
| **Assign Aggregation Design** | - Multiples partitions similaires<br>- Structure identique<br>- Maintenance simplifiÃ©e           | - RÃ©utilisation<br>- Consistance<br>- Maintenance facile                             | - Design doit exister<br>- Pas optimal si donnÃ©es diffÃ©rentes<br>- Moins flexible               |

### B. Modes de stockage (impact agrÃ©gations)

| Mode                  | AgrÃ©gations SSAS                                   | Performance                                                  | FraÃ®cheur                               | Espace SSAS                | Cas d'usage idÃ©al                                        |
| --------------------- | -------------------------------------------------- | ------------------------------------------------------------ | --------------------------------------- | -------------------------- | -------------------------------------------------------- |
| **MOLAP**             | âœ… Pleinement supportÃ©es<br>StockÃ©es avec donnÃ©es   | â­â­â­â­â­<br>5-20 ms                                             | âš ï¸ Processing requis<br>DonnÃ©es figÃ©es  | âš ï¸ Ã‰levÃ©<br>DonnÃ©es + aggs | Historique, rapports BI, performance critique            |
| **HOLAP**             | âœ… Pleinement supportÃ©es<br>StockÃ©es seules         | â­â­â­â­ Aggs<br>â­â­ DÃ©tail<br>10-30 ms aggs<br>100-200 ms dÃ©tail | âš ï¸ Aggs figÃ©es<br>âœ… DÃ©tail temps rÃ©el   | âœ… Faible<br>Aggs seulement | Volumes moyens, rapports agrÃ©gÃ©s, drill-down occasionnel |
| **ROLAP**             | âŒ Non supportÃ©es<br>(SQL indexed views Ã  la place) | â­â­<br>50-500 ms                                              | âœ… Temps rÃ©el                            | âœ… Minimal<br>MÃ©tadonnÃ©es   | Temps rÃ©el requis, gros volumes, espace limitÃ©           |
| **MOLAP + Proactive** | âœ… SupportÃ©es<br>Auto-refresh                       | â­â­â­â­â­<br>5-20 ms                                             | âœ… Quasi temps rÃ©el<br>10s-10min latence | âš ï¸ Ã‰levÃ©<br>Comme MOLAP    | Compromis performance/fraÃ®cheur, mois courant            |

### C. Matrice dÃ©cisionnelle : Mode Ã— Type de donnÃ©es

|                          | Historique (>2 ans) | RÃ©cent (<1 an)    | Courant (mois actuel)    | TrÃ¨s volumineux (>500 GB) |
| ------------------------ | ------------------- | ----------------- | ------------------------ | ------------------------- |
| **Performance critique** | MOLAP 50-70% aggs   | MOLAP 30-40% aggs | MOLAP + Proactive 10-20% | HOLAP 20-30% aggs         |
| **Ã‰quilibrÃ©**            | MOLAP 40-50%        | HOLAP 20-30%      | MOLAP + Proactive 10%    | HOLAP 15-20%              |
| **Espace limitÃ©**        | HOLAP 30-40%        | HOLAP 15-25%      | ROLAP + indexed views    | ROLAP + indexed views     |
| **Temps rÃ©el requis**    | N/A (ne change pas) | MOLAP + Proactive | ROLAP                    | ROLAP                     |

### D. Combinaisons recommandÃ©es (Production)

| Partition type           | Mode                          | AgrÃ©gations                   | Processing         | Exemple concret |
| ------------------------ | ----------------------------- | ----------------------------- | ------------------ | --------------- |
| **AnnÃ©es N-3+**          | MOLAP                         | 60-70% (Design)               | 1x/trimestre       | 2020, 2021      |
| **AnnÃ©e N-2**            | MOLAP                         | 40-50% (Design + Usage-Based) | 1x/mois            | 2022            |
| **AnnÃ©e N-1**            | MOLAP ou HOLAP                | 30-40% (Usage-Based)          | 1x/semaine         | 2023            |
| **AnnÃ©e courante Q1-Q3** | HOLAP                         | 20-30% (Usage-Based)          | 1x/semaine         | 2024 Jan-Sep    |
| **Mois N-1**             | HOLAP ou MOLAP                | 15-20% (Usage-Based)          | 1x/jour            | 2024 Nov        |
| **Mois courant**         | MOLAP + Proactive<br>ou ROLAP | 10-15% ou aucune              | Auto ou temps rÃ©el | 2024 Dec        |

### E. Aide au choix rapide

**Question 1 : Les donnÃ©es changent-elles aprÃ¨s insertion ?**

- Non â†’ MOLAP (historique)
- Oui, rarement â†’ MOLAP + Proactive Caching
- Oui, souvent â†’ ROLAP

**Question 2 : Quel est le volume de cette partition ?**

- < 10 GB â†’ MOLAP (rapide Ã  processer)
- 10-100 GB â†’ HOLAP (bon compromis)
- > 100 GB â†’ HOLAP ou ROLAP

**Question 3 : Quel est le pattern d'usage principal ?**

- Rapports agrÃ©gÃ©s (dashboards) â†’ MOLAP ou HOLAP
- Drill-down frÃ©quent â†’ MOLAP
- Queries ad-hoc variÃ©es â†’ MOLAP avec bonnes agrÃ©gations
- Temps rÃ©el critique â†’ ROLAP

**Question 4 : Quelle est la contrainte prioritaire ?**

- Performance max â†’ MOLAP
- Espace disque â†’ HOLAP puis ROLAP
- FraÃ®cheur â†’ ROLAP ou MOLAP + Proactive
- CoÃ»t de processing â†’ HOLAP ou ROLAP

---

## RÃ‰SUMÃ‰ DE L'ATELIER

### Ce qu'on a appris

1. âœ… **Partitions = clÃ© de performance**
   
   - Une partition = un sous-ensemble de donnÃ©es
   - AgrÃ©gations dÃ©finies PAR partition
   - Processing incrÃ©mental possible
   - **Mode de stockage PAR partition**

2. âœ… **4 modes de stockage**
   
   - **MOLAP** : Performance max, espace Ã©levÃ©, processing requis
   - **ROLAP** : Temps rÃ©el, lent, pas d'espace SSAS
   - **HOLAP** : Compromis, aggs rapides, dÃ©tail SQL
   - **Proactive Caching** : MOLAP avec auto-refresh

3. âœ… **3 stratÃ©gies d'agrÃ©gation**
   
   - Design : rapide, gÃ©nÃ©rique
   - Usage-Based : optimal, basÃ© sur usage rÃ©el
   - Assign : rÃ©utilisation, maintenance

4. âœ… **Optimisation diffÃ©renciÃ©e**
   
   - Historique : MOLAP + agrÃ©gations agressives (50-70%)
   - IntermÃ©diaire : HOLAP + agrÃ©gations modÃ©rÃ©es (20-30%)
   - Courante : ROLAP ou MOLAP+Proactive (0-15%)

5. âœ… **Bonnes pratiques**
   
   - Partitionner par usage temporel ET mode de stockage
   - Utiliser Aggregation Usage intelligemment (sauf ROLAP)
   - Favoriser les hiÃ©rarchies naturelles
   - Ã‰viter la sur-agrÃ©gation
   - RÃ©-optimiser avec Usage-Based pÃ©riodiquement
   - Monitorer les tailles et performances

### Architecture finale (version mixte)

```
DemoAggregations Cube
â”‚
â”œâ”€â”€ Fact Sales 2022 [MOLAP]
â”‚   â”œâ”€â”€ Aggregation Design 1 (50% gain, 22 aggs)
â”‚   â”œâ”€â”€ Storage: 2.5 MB (donnÃ©es + aggs compressÃ©es)
â”‚   â”œâ”€â”€ Processing: 1x/trimestre
â”‚   â””â”€â”€ Data: ~50,000 rows
â”‚
â”œâ”€â”€ Fact Sales 2023 [HOLAP]
â”‚   â”œâ”€â”€ Aggregation Design 2 (30% gain, 12 aggs)
â”‚   â”œâ”€â”€ Storage SSAS: 0.8 MB (aggs seulement)
â”‚   â”œâ”€â”€ Storage SQL: 5 MB (donnÃ©es source)
â”‚   â”œâ”€â”€ Processing: 1x/mois
â”‚   â””â”€â”€ Data: ~50,000 rows (in SQL)
â”‚
â””â”€â”€ Fact Sales 2024 [ROLAP]
    â”œâ”€â”€ No aggregations (or SQL indexed views)
    â”œâ”€â”€ Storage SSAS: 0 KB (mÃ©tadonnÃ©es)
    â”œâ”€â”€ Storage SQL: 5 MB (donnÃ©es source)
    â”œâ”€â”€ Refresh: Temps rÃ©el
    â””â”€â”€ Data: ~50,000 rows (in SQL)

Total SSAS: 3.3 MB (vs 15 MB en full MOLAP = Ã©conomie 78%)
Total SQL: 10 MB (source)
Performance: MOLAP=10ms, HOLAP=20ms agg/120ms dÃ©tail, ROLAP=80ms
```

### Prochaines Ã©tapes en production

1. **Maintenance mensuelle** :
   
   - CrÃ©er nouvelle partition pour le mois courant
   - Copier le design du mois prÃ©cÃ©dent (Assign)
   - Process incrÃ©mental

2. **Optimisation trimestrielle** :
   
   - Analyser les query logs
   - Usage-Based Optimization sur partitions actives
   - RÃ©Ã©valuer la stratÃ©gie d'agrÃ©gation

3. **Nettoyage annuel** :
   
   - Merger les anciennes partitions
   - AgrÃ©gations trÃ¨s agressives sur historique
   - Archivage si nÃ©cessaire

---

## EXERCICES PRATIQUES

### Exercice 1 : CrÃ©er des partitions mensuelles pour 2024 avec modes mixtes

**Objectif :** CrÃ©er 12 partitions (Jan-2024 Ã  Dec-2024) avec stratÃ©gie mixte

**Configuration recommandÃ©e :**

- Jan-Sep 2024 : HOLAP (stabilisÃ©)
- Oct-Nov 2024 : HOLAP ou MOLAP
- Dec 2024 : MOLAP + Proactive Caching (courant)

**Indice :** Utiliser des requÃªtes WHERE comme :

```sql
WHERE DateKey >= 20240101 AND DateKey < 20240201  -- Jan
WHERE DateKey >= 20240201 AND DateKey < 20240301  -- Feb
...
```

**Questions :**

1. Quelle est la diffÃ©rence de taille totale entre full MOLAP vs mixte ?
2. Quel est le temps de processing pour chaque mode ?
3. Quelle est la diffÃ©rence de performance sur agrÃ©gations vs drill-down ?

---

### Exercice 2 : Tester Proactive Caching

**Objectif :** Configurer une partition MOLAP avec auto-refresh

**Ã‰tapes :**

1. CrÃ©er partition Dec-2024 en MOLAP

2. Activer Proactive Caching :
   
   - Silence interval : 10s
   - Silence override : 5 min

3. InsÃ©rer des donnÃ©es dans SQL Server :
   
   ```sql
   INSERT INTO FactSales VALUES (20241215, 1, 5, 1500.00);
   ```

4. Attendre 10-15 secondes

5. RequÃªter le cube â†’ DonnÃ©es apparaissent automatiquement

**Questions :**

1. Combien de temps avant que les donnÃ©es apparaissent ?
2. Que se passe-t-il si on insÃ¨re 100 lignes/seconde ?
3. Quelle est la diffÃ©rence de performance vs ROLAP pur ?

---

### Exercice 3 : Optimiser ROLAP avec Indexed Views

**Objectif :** CrÃ©er des indexed views SQL pour amÃ©liorer performance ROLAP

**SQL Ã  exÃ©cuter :**

```sql
-- Vue agrÃ©gÃ©e Year + Category
CREATE VIEW AggSales_Year_Category
WITH SCHEMABINDING
AS
SELECT 
    d.Year,
    p.Category,
    SUM(f.Amount) as TotalAmount,
    SUM(f.Quantity) as TotalQuantity,
    COUNT_BIG(*) as RowCount
FROM dbo.FactSales f
INNER JOIN dbo.DimDate d ON f.DateKey = d.DateKey
INNER JOIN dbo.DimProduct p ON f.ProductKey = p.ProductKey
WHERE d.Year = 2024
GROUP BY d.Year, p.Category;
GO

-- Index clustered
CREATE UNIQUE CLUSTERED INDEX IX_AggSales_Year_Category 
ON AggSales_Year_Category(Year, Category);
GO
```

**Test :**

```mdx
SELECT 
    [Measures].[Amount] ON COLUMNS,
    [Dim Product].[Category].[Category].Members ON ROWS
FROM [Sales Cube]
WHERE [Dim Date].[Year].[Year].&[2024];
```

**Questions :**

1. Temps avant indexed view ? AprÃ¨s ?
2. Impact sur CPU SQL Server ?
3. Combien d'indexed views crÃ©er (Ã©quilibre maintenance/performance) ?

---

### Exercice 4 : Simuler une annÃ©e complÃ¨te avec stratÃ©gie production

**Objectif :** ImplÃ©menter l'architecture recommandÃ©e

**Configuration :**

1. **Q1 2024 (Jan-Mar)** : HOLAP, aggs 30%, process 1x/mois
2. **Q2 2024 (Apr-Jun)** : HOLAP, aggs 25%, process 1x/mois
3. **Q3 2024 (Jul-Sep)** : HOLAP, aggs 20%, process 1x/semaine
4. **Oct-Nov 2024** : MOLAP, aggs 15%, process 1x/semaine
5. **Dec 2024** : MOLAP + Proactive Caching, aggs 10%

**Mesurer :**

- Storage total SSAS
- Storage total SQL
- Temps de processing moyen
- Performance moyenne queries (agrÃ©gÃ©es vs dÃ©tail)

**Comparer avec :**

- Full MOLAP (toutes partitions)
- Full ROLAP (toutes partitions)

---

### Exercice 5 : Analyse de Query Performance par mode

**Objectif :** Comprendre l'impact du mode sur diffÃ©rents types de requÃªtes

**RequÃªtes Ã  tester sur chaque partition (2022 MOLAP, 2023 HOLAP, 2024 ROLAP) :**

**Q1 - AgrÃ©gation simple :**

```mdx
SELECT [Measures].[Amount] ON 0
FROM [Sales Cube]
WHERE [Dim Date].[Year].[Year].&[YEAR];
```

**Q2 - AgrÃ©gation + 1 dimension :**

```mdx
SELECT 
    [Measures].[Amount] ON 0,
    [Dim Product].[Category].[Category].Members ON 1
FROM [Sales Cube]
WHERE [Dim Date].[Year].[Year].&[YEAR];
```

**Q3 - Drill-down complet :**

```mdx
SELECT 
    {[Measures].[Amount], [Measures].[Quantity]} ON 0,
    NON EMPTY [Dim Product].[Product Name].[Product Name].Members ON 1
FROM [Sales Cube]
WHERE ([Dim Date].[Year].[Year].&[YEAR], 
       [Dim Date].[Month].[Month].&[1]);
```

**CrÃ©er un tableau de rÃ©sultats :**

| Query | MOLAP (2022) | HOLAP (2023) | ROLAP (2024) | Notes |
| ----- | ------------ | ------------ | ------------ | ----- |
| Q1    | ___ ms       | ___ ms       | ___ ms       |       |
| Q2    | ___ ms       | ___ ms       | ___ ms       |       |
| Q3    | ___ ms       | ___ ms       | ___ ms       |       |

**Analyser :**

1. Sur quelle query la diffÃ©rence est maximale ?
2. HOLAP est-il vraiment un bon compromis ?
3. Dans quels cas ROLAP est acceptable ?

---

## FIN DE L'ATELIER

ğŸ¯ **Objectifs atteints :**

- âœ… Partitions crÃ©Ã©es et configurÃ©es
- âœ… **4 modes de stockage maÃ®trisÃ©s (MOLAP, ROLAP, HOLAP, Proactive Caching)**
- âœ… AgrÃ©gations optimisÃ©es par partition ET par mode
- âœ… 3 mÃ©thodes d'agrÃ©gation maÃ®trisÃ©es
- âœ… Bonnes pratiques appliquÃ©es avec stratÃ©gie mixte
- âœ… Architecture production rÃ©aliste

ğŸ“š **Pour aller plus loin :**

- Partitions distantes (remote partitions)
- Proactive caching avancÃ© (notifications SQL)
- AgrÃ©gations rigides (rigid aggregations)
- MOLAP optimization avancÃ©
- **Migration vers SSAS Tabular (In-Memory xVelocity)**
- DirectQuery mode (Ã©quivalent ROLAP Tabular)

---

## ANNEXE A : MOLAP vs In-Memory (Tabular)

### Clarification importante

**Question frÃ©quente :** "Quelle est la diffÃ©rence entre MOLAP et In-Memory ?"

**RÃ©ponse :**

| Aspect               | SSAS Multidimensional MOLAP    | SSAS Tabular In-Memory                                     |
| -------------------- | ------------------------------ | ---------------------------------------------------------- |
| **Moteur**           | Multidimensional (MDX)         | Tabular/Columnar (DAX)                                     |
| **Stockage mÃ©moire** | Cache en RAM + fichiers disque | **Tout en RAM** (xVelocity)                                |
| **Compression**      | 5:1 Ã  10:1                     | 10:1 Ã  100:1 (columnstore)                                 |
| **RequÃªtes**         | MDX                            | DAX (SQL-like)                                             |
| **AgrÃ©gations**      | Pre-calculÃ©es et stockÃ©es      | **CalculÃ©es Ã  la volÃ©e** (trÃ¨s rapide grÃ¢ce Ã  columnstore) |
| **Limites mÃ©moire**  | Cache configurable             | LimitÃ© par RAM serveur                                     |
| **Performance**      | Excellente avec aggs           | Excellente native                                          |
| **ComplexitÃ©**       | Ã‰levÃ©e (dimensions, cubes)     | Plus simple (modÃ¨le relationnel)                           |

**En rÃ©sumÃ© :**

- **MOLAP (Multidimensional)** = DonnÃ©es compressÃ©es sur disque + cache RAM + agrÃ©gations prÃ©-calculÃ©es
- **In-Memory (Tabular)** = Tout en RAM, columnstore ultra-compressÃ©, agrÃ©gations dynamiques

**Cet atelier couvre SSAS Multidimensional.** Pour In-Memory Tabular, c'est un produit diffÃ©rent avec des concepts distincts.

---

## ANNEXE B : COMMANDES XMLA AVANCÃ‰ES

### VÃ©rifier les agrÃ©gations d'une partition

```xmla
<Discover xmlns="urn:schemas-microsoft-com:xml-analysis">
  <RequestType>DISCOVER_PARTITION_STAT</RequestType>
  <Restrictions>
    <RestrictionList>
      <DATABASE_NAME>DemoAggregations</DATABASE_NAME>
      <CUBE_NAME>Sales Cube</CUBE_NAME>
    </RestrictionList>
  </Restrictions>
</Discover>
```

### Changer le mode de stockage d'une partition (XMLA)

```xmla
<Alter xmlns="http://schemas.microsoft.com/analysisservices/2003/engine">
  <Object>
    <DatabaseID>DemoAggregations</DatabaseID>
    <CubeID>Sales Cube</CubeID>
    <MeasureGroupID>Fact Sales</MeasureGroupID>
    <PartitionID>Fact Sales 2024</PartitionID>
  </Object>
  <ObjectDefinition>
    <Partition>
      <StorageMode>Holap</StorageMode> <!-- Molap, Rolap, Holap -->
    </Partition>
  </ObjectDefinition>
</Alter>
```

### Retraiter une seule partition

```xmla
<Batch xmlns="http://schemas.microsoft.com/analysisservices/2003/engine">
  <Process>
    <Object>
      <DatabaseID>DemoAggregations</DatabaseID>
      <CubeID>Sales Cube</CubeID>
      <MeasureGroupID>Fact Sales</MeasureGroupID>
      <PartitionID>Fact Sales 2024</PartitionID>
    </Object>
    <Type>ProcessFull</Type>
  </Process>
</Batch>
```

### Activer Proactive Caching (XMLA)

```xmla
<Alter xmlns="http://schemas.microsoft.com/analysisservices/2003/engine">
  <Object>
    <DatabaseID>DemoAggregations</DatabaseID>
    <CubeID>Sales Cube</CubeID>
    <MeasureGroupID>Fact Sales</MeasureGroupID>
    <PartitionID>Fact Sales 2024</PartitionID>
  </Object>
  <ObjectDefinition>
    <Partition>
      <StorageMode>Molap</StorageMode>
      <ProactiveCaching>
        <Enabled>true</Enabled>
        <SilenceInterval>PT10S</SilenceInterval>
        <SilenceOverrideInterval>PT10M</SilenceOverrideInterval>
        <Source xsi:type="ProactiveCachingInheritedBinding" />
      </ProactiveCaching>
    </Partition>
  </ObjectDefinition>
</Alter>
```

### Voir les agrÃ©gations utilisÃ©es par une requÃªte (Profiler)

**Activer SQL Server Profiler :**

1. Profiler â†’ New Trace â†’ SSAS

2. Events Ã  capturer :
   
   - **Query Begin** : DÃ©but requÃªte
   - **Query End** : Fin requÃªte
   - **Query Subcube** : Sous-cubes interrogÃ©s
   - **Get Data From Aggregation** : **AgrÃ©gation utilisÃ©e** â­
   - **Get Data From Cache** : DonnÃ©es en cache
   - **Execute SQL** : RequÃªte SQL (si ROLAP/HOLAP)

3. ExÃ©cuter requÃªte MDX

4. Analyser la trace :
   
   ```
   Query Begin        : SELECT [Amount]...Query Subcube      : [2022].[All]Get Data From Agg  : Aggregation15 (Year+Category)  â† AgrÃ©gation utilisÃ©eGet Data From Cache: Hit (0 ms)Query End          : Duration 8ms
   ```

**InterprÃ©tation :**

- **Get Data From Aggregation** = AgrÃ©gation SSAS utilisÃ©e (MOLAP/HOLAP)
- **Execute SQL** = RequÃªte vers SQL Server (ROLAP/HOLAP dÃ©tail)
- **Get Data From Cache** = DonnÃ©es dÃ©jÃ  en mÃ©moire

---

## ANNEXE C : SCRIPTS UTILES

### Script PowerShell : CrÃ©er partitions mensuelles automatiquement

```powershell
# Connexion SSAS
$serverName = "localhost"
$databaseName = "DemoAggregations"
$cubeName = "Sales Cube"
$measureGroupName = "Fact Sales"

# Charger AMO
[System.Reflection.Assembly]::LoadWithPartialName("Microsoft.AnalysisServices") | Out-Null

# Connexion
$server = New-Object Microsoft.AnalysisServices.Server
$server.Connect($serverName)
$db = $server.Databases[$databaseName]
$cube = $db.Cubes[$cubeName]
$mg = $cube.MeasureGroups[$measureGroupName]

# CrÃ©er partitions pour 2024 (12 mois)
for ($month = 1; $month -le 12; $month++) {
    $startDate = Get-Date -Year 2024 -Month $month -Day 1
    $endDate = $startDate.AddMonths(1)

    $partitionName = "Fact Sales 2024-" + $startDate.ToString("MM")
    $query = "SELECT * FROM FactSales WHERE DateKey >= " + 
             $startDate.ToString("yyyyMMdd") + " AND DateKey < " + 
             $endDate.ToString("yyyyMMdd")

    # CrÃ©er partition
    $partition = $mg.Partitions.Add($partitionName)
    $partition.Source = New-Object Microsoft.AnalysisServices.QueryBinding `
        -ArgumentList $db.DataSources[0].ID, $query

    # Mode de stockage (HOLAP pour mois passÃ©s, MOLAP pour courant)
    if ($month -eq 12) {
        $partition.StorageMode = [Microsoft.AnalysisServices.StorageMode]::Molap
        # Activer Proactive Caching
        $partition.ProactiveCaching.Enabled = $true
        $partition.ProactiveCaching.SilenceInterval = 10000 # 10s
    } else {
        $partition.StorageMode = [Microsoft.AnalysisServices.StorageMode]::Holap
    }

    Write-Host "Partition crÃ©Ã©e: $partitionName ($($partition.StorageMode))"
}

# Sauvegarder
$mg.Update([Microsoft.AnalysisServices.UpdateOptions]::ExpandFull)
$server.Disconnect()

Write-Host "12 partitions mensuelles crÃ©Ã©es avec succÃ¨s!"
```

### Script T-SQL : CrÃ©er indexed views pour ROLAP

```sql
-- Vue agrÃ©gÃ©e pour Year
CREATE VIEW dbo.AggSales_Year
WITH SCHEMABINDING
AS
SELECT 
    d.Year,
    SUM(f.Amount) as TotalAmount,
    SUM(f.Quantity) as TotalQuantity,
    COUNT_BIG(*) as RowCount
FROM dbo.FactSales f
INNER JOIN dbo.DimDate d ON f.DateKey = d.DateKey
GROUP BY d.Year;
GO

CREATE UNIQUE CLUSTERED INDEX IX_AggSales_Year ON dbo.AggSales_Year(Year);
GO

-- Vue agrÃ©gÃ©e pour Year + Quarter
CREATE VIEW dbo.AggSales_Year_Quarter
WITH SCHEMABINDING
AS
SELECT 
    d.Year,
    d.Quarter,
    SUM(f.Amount) as TotalAmount,
    SUM(f.Quantity) as TotalQuantity,
    COUNT_BIG(*) as RowCount
FROM dbo.FactSales f
INNER JOIN dbo.DimDate d ON f.DateKey = d.DateKey
GROUP BY d.Year, d.Quarter;
GO

CREATE UNIQUE CLUSTERED INDEX IX_AggSales_Year_Quarter 
ON dbo.AggSales_Year_Quarter(Year, Quarter);
GO

-- Vue agrÃ©gÃ©e pour Year + Category
CREATE VIEW dbo.AggSales_Year_Category
WITH SCHEMABINDING
AS
SELECT 
    d.Year,
    p.Category,
    SUM(f.Amount) as TotalAmount,
    SUM(f.Quantity) as TotalQuantity,
    COUNT_BIG(*) as RowCount
FROM dbo.FactSales f
INNER JOIN dbo.DimDate d ON f.DateKey = d.DateKey
INNER JOIN dbo.DimProduct p ON f.ProductKey = p.ProductKey
GROUP BY d.Year, p.Category;
GO

CREATE UNIQUE CLUSTERED INDEX IX_AggSales_Year_Category 
ON dbo.AggSales_Year_Category(Year, Category);
GO

-- Statistiques (pour que l'optimiseur SQL les utilise)
UPDATE STATISTICS dbo.AggSales_Year;
UPDATE STATISTICS dbo.AggSales_Year_Quarter;
UPDATE STATISTICS dbo.AggSales_Year_Category;
```

---

## RESSOURCES COMPLÃ‰MENTAIRES

### Documentation Microsoft

- [Storage Modes (Multidimensional)](https://learn.microsoft.com/en-us/analysis-services/multidimensional-models/partitions-storage-modes-and-processing)
- [Proactive Caching](https://learn.microsoft.com/en-us/analysis-services/multidimensional-models/partitions-proactive-caching)
- [Aggregation Design](https://learn.microsoft.com/en-us/analysis-services/multidimensional-models/designing-aggregations-analysis-services-multidimensional)

### Livres recommandÃ©s

- "Professional Microsoft SQL Server Analysis Services 2016" - Paul Turley
- "Microsoft SQL Server 2016 Analysis Services: The SSAS Handbook" - Chris Webb

### Blogs techniques

- Chris Webb's BI Blog (expertise SSAS)
- SQLBI (Marco Russo, Alberto Ferrari - experts DAX/Tabular mais aussi Multidimensional)
