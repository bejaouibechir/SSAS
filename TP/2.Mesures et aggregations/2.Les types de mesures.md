# ATELIER 1 : LES TYPES DE MESURES - PRATIQUE SSDT

**Dur√©e** : 2h00  
**Pr√©requis** : Cube TechMartCube d√©ploy√©, SSDT ouvert

---

## üìã CE QUE VOUS ALLEZ FAIRE

1. Identifier les mesures existantes par type
2. Cr√©er 3 mesures calcul√©es dans SSDT
3. Ajouter une mesure semi-additive
4. Tester et valider

---

## PARTIE 1 : IDENTIFIER LES MESURES EXISTANTES (15 min)

### EXERCICE 1.1 : Ouvrir le cube et examiner les mesures

**√âtapes SSDT :**

1. Ouvrir SSDT
2. File ‚Üí Open ‚Üí Project
3. S√©lectionner votre projet SSAS
4. Dans Solution Explorer ‚Üí Double-clic sur `Cube.cube`
5. Cliquer sur l'onglet **Cube Structure**

**Dans le panneau Measures, vous voyez :**

```
üìÅ Fact Product Sales
   üìä Quantity
   üìä Sub Total
   üìä Discount Amount
   üìä Tax Amount
   üìä Total Amount
   üìä Net Profit
   üìä Unit Price
   üìä Fact Product Sales Nombre (Count)
```

### EXERCICE 1.2 : Identifier le type de chaque mesure

**Remplissez ce tableau :**

| Mesure                    | Fonction d'agr√©gation | Type                           |
| ------------------------- | --------------------- | ------------------------------ |
| Quantity                  | Sum                   | Additive                       |
| Total Amount              | Sum                   | Additive                       |
| Net Profit                | Sum                   | Additive                       |
| Unit Price                | Sum                   | ??? ‚Üí C'est quoi le probl√®me ? |
| Fact Product Sales Nombre | Count                 | Additive                       |

**Question** : Pourquoi Unit Price avec SUM est probl√©matique ?

**R√©ponse** : Le prix unitaire est un **ratio** (Total Amount / Quantity). On ne peut pas additionner les prix de deux produits.

**Exemple concret :**

- Produit A : Prix = 100 ‚Ç¨
- Produit B : Prix = 200 ‚Ç¨
- ‚ùå FAUX : Prix total = 100 + 200 = 300 ‚Ç¨
- ‚úÖ CORRECT : Prix moyen = Total Amount / Quantity

**Conclusion** : Unit Price devrait √™tre une **mesure calcul√©e** (non additive).

![](D:\Formation%20BI\SSAS\Labs\0.%20Cr√©ation%20Datawarehouse\images\23.png)

---

## PARTIE 2 : CR√âER DES MESURES CALCUL√âES (45 min)

### EXERCICE 2.1 : Cr√©er Profit Margin %

**Objectif** : Afficher le taux de marge b√©n√©ficiaire en pourcentage

#### √âtape 1 : Aller dans l'onglet Calculations

Dans SSDT, avec le cube ouvert :

1. Cliquer sur l'onglet **Calculs**

2. Vous voyez en haut √† gauche un panneau de script
   
   ![](D:\Formation%20BI\SSAS\Labs\0.%20Cr√©ation%20Datawarehouse\images\24.png)

#### √âtape 2 : Cr√©er une nouvelle mesure calcul√©e

1. Dans la barre d'outils, cliquer sur l'ic√¥ne **New Calculated Member** (ic√¥ne calculatrice avec un +)
   
   - OU : Menu ‚Üí Cube ‚Üí New Calculated Member

2. Un nouveau membre appara√Æt dans le panneau gauche
   
   ![](D:\Formation%20BI\SSAS\Labs\0.%20Cr√©ation%20Datawarehouse\images\25.png)

#### √âtape 3 : Configurer la mesure

**Dans le panneau de propri√©t√©s (√† droite) :**

| Propri√©t√©            | Valeur √† saisir   |
| -------------------- | ----------------- |
| **Name**             | `Profit Margin %` |
| **Parent hierarchy** | `Measures`        |
| **Format string**    | `0.00`            |
| **Visible**          | `True`            |

Passez au mode script

![](D:\Formation%20BI\SSAS\Labs\0.%20Cr√©ation%20Datawarehouse\images\26.png)

**Dans le panneau Expression (au centre), saisir cette formule MDX :**

```mdx
CALCULATE;

CREATE MEMBER CURRENTCUBE.[Measures].[Profit Margin]
AS
    IIF(
        IsEmpty([Measures].[Total Amount])
        OR [Measures].[Total Amount] = 0,
        NULL,
        ([Measures].[Net Profit] / [Measures].[Total Amount]) * 100
    )
,  FORMAT_STRING = "0.00%"
, VISIBLE = 1;
```

Section "Formats courants" ajout√©e avec exemples :

- `"0.00%"` ‚Üí 25.50%
- `"#,##0.00 ‚Ç¨"` ‚Üí 1,234.56 ‚Ç¨
- `"#,##0"` ‚Üí 1,234
- `"0.00"` ‚Üí 25.50 

#### √âtape 4 : D√©ployer

1. Menu ‚Üí Build ‚Üí Deploy Solution
2. Attendre le message "Deploy completed successfully"

#### √âtape 5 : Tester

1. Cliquer sur l'onglet **Browser**
2. Si demand√©, cliquer sur **Reconnect**
3. Dans le panneau Metadata (√† gauche), d√©velopper **Measures** ‚Üí **Fact Product Sales**
4. Glisser-d√©poser dans la zone Values :
   - `Total Amount`
   - `Net Profit`
   - `Profit Margin %` (votre nouvelle mesure)
5. Glisser `Dim Product` ‚Üí `Product Name` dans la zone Rows

**R√©sultat attendu :**

```
Product Name    | Total Amount | Net Profit | Profit Margin %
----------------|--------------|------------|----------------
Laptop Elite    | 10,000       | 2,500      | 25.00
Tablet Pro      | 5,000        | 1,000      | 20.00
```

‚úÖ **Si vous voyez des valeurs comme ci-dessus : SUCC√àS !**

---

### EXERCICE 2.2 : Cr√©er Average Unit Price (CORRECT)

**Objectif** : Remplacer le Unit Price incorrect par un calcul correct

#### √âtapes dans SSDT :

1. Onglet **Calculations**
2. Cliquer **New Calculated Member**
3. Configurer :

| Propri√©t√©         | Valeur               |
| ----------------- | -------------------- |
| **Name**          | `Average Unit Price` |
| **Format string** | `#,##0.00 ‚Ç¨`         |

4. Expression MDX :

```mdx
IIF(
    [Measures].[Quantity] = 0,
    NULL,
    [Measures].[Total Amount] / [Measures].[Quantity]
)
```

5. Deploy
6. Tester dans Browser avec diff√©rentes dimensions

**Test 1 : Par Produit**

- Rows : Product Name
- Values : Total Amount, Quantity, Average Unit Price

**Test 2 : Par Mois**

- Rows : Calendar Year Month
- Values : Total Amount, Quantity, Average Unit Price

**Observation** : Le prix moyen change selon le contexte ‚Üí c'est une **mesure non additive**.

---

### EXERCICE 2.3 : Cr√©er Discount Rate %

#### √âtapes SSDT :

1. Onglet **Calculations** ‚Üí **New Calculated Member**
2. Name : `Discount Rate %`
3. Format : `0.00`
4. Expression :

```mdx
IIF(
    [Measures].[Sub Total] = 0,
    NULL,
    ([Measures].[Discount Amount] / [Measures].[Sub Total]) * 100
)
```

5. Deploy et tester

**Test avec agr√©gation :**

- Rows : Product Category
- Values : Sub Total, Discount Amount, Discount Rate %

**V√©rifiez que :** Le taux de remise au niveau "All Products" est correct (et non la somme des taux).

---

## PARTIE 3 : AJOUTER UNE MESURE SEMI-ADDITIVE (45 min)

### EXERCICE 3.1 : Ajouter la colonne Stock dans la base

#### √âtape 1 : Ex√©cuter le script SQL

1. Ouvrir **SQL Server Management Studio (SSMS)**
2. Se connecter √† votre serveur
3. Nouvelle requ√™te
4. Copier-coller ce script :

```sql
USE DW;
GO

-- Ajouter la colonne
ALTER TABLE dw.FactProductSales 
ADD StockLevel INT NULL;
GO

-- Remplir avec des donn√©es simul√©es
UPDATE dw.FactProductSales
SET StockLevel = 1000 - (Quantity * 2) + (ABS(CHECKSUM(NEWID())) % 500);
GO

-- V√©rifier
SELECT TOP 20 
    DateKey, 
    ProductSK, 
    Quantity, 
    StockLevel
FROM dw.FactProductSales
ORDER BY DateKey, ProductSK;
```

5. Ex√©cuter (F5)
6. V√©rifier que 20 lignes s'affichent avec la colonne StockLevel

---

### EXERCICE 3.2 : Mettre √† jour la Data Source View dans SSDT

#### √âtape 1 : Rafra√Æchir la DSV

1. Dans SSDT, Solution Explorer ‚Üí Double-clic sur `DW.dsv`
2. Dans le diagramme il faut mettre √† jour la table `FactProductSales`
3. Choisir **Refresh** au niveau des icones au dessus de **Bibliot√®que de diagrammes** au niveau de l'angle gauche en haut 
4. V√©rifier que la colonne `StockLevel` appara√Æt dans la table

---

### EXERCICE 3.3 : Ajouter la mesure au cube

#### √âtape 1 : Ajouter depuis la DSV

1. Ouvrir `Cube.cube` ‚Üí Onglet **Cube Structure**
2. Dans le panneau **Data Source View** (en bas), localiser `FactProductSales`
3. **D√©velopper** la table pour voir ses colonnes
4. Localiser la colonne `StockLevel`
5. **Glisser-d√©poser** `StockLevel` dans le panneau **Measures** ‚Üí Groupe `Fact Product Sales`

Une nouvelle mesure appara√Æt : `Stock Level`

#### √âtape 2 : Examiner les propri√©t√©s

1. Cliquer sur la mesure `Stock Level`
2. Dans Properties (F4) :
   - `Aggregate Function` : **Sum** (par d√©faut)
   - `Format String` : Laisser vide ou mettre `#,##0`

---

### EXERCICE 3.4 : Tester le probl√®me avec Sum

#### √âtape 1 : D√©ployer et tester

1. Deploy Solution
2. Onglet **Browser** ‚Üí Reconnect
3. Cr√©er ce rapport :
   - Rows : Calendar Year
   - Values : Quantity, Stock Level

**R√©sultat que vous verrez (INCORRECT) :**

```
Year    | Quantity | Stock Level
--------|----------|-------------
2023    | 10,000   | 5,234,567   ‚Üê ABSURDE !
2024    | 12,000   | 6,789,123   ‚Üê ABSURDE !
```

**Pourquoi c'est absurde ?**

SSAS additionne tous les stocks de chaque jour de l'ann√©e :

- Stock 1er janvier = 1000
- Stock 2 janvier = 980
- Stock 3 janvier = 1020
- ...
- Total = 1000 + 980 + 1020 + ... = 5,234,567 ‚ùå

**Le probl√®me** : Le stock n'est pas additif sur le temps. On veut le stock au **dernier jour** de la p√©riode.

---

### EXERCICE 3.5 : Cr√©er une mesure calcul√©e pour LastChild

**NOTE** : Les mesures semi-additives (LastChild, FirstChild) n√©cessitent Enterprise Edition. Si vous avez Standard Edition, utilisez cette solution :

#### Dans SSDT :

1. Onglet **Calculations** ‚Üí **New Calculated Member**
2. Name : `Stock Level (End of Period)`
3. Expression MDX :

```mdx
(
    [Date].[Calendar Hierarchy].CurrentMember.LastChild,
    [Measures].[Stock Level]
)
```

**Explication de la formule :**

- `[Date].[Calendar Hierarchy].CurrentMember` : Le niveau de date actuel (ex: 2023)

- `.LastChild` : Le dernier enfant de ce niveau (ex: 31/12/2023)

- La mesure Stock Level est √©valu√©e √† cette derni√®re date
4. Deploy et tester

**R√©sultat (CORRECT) :**

```
Year    | Stock Level (End of Period)
--------|----------------------------
2023    | 1,234        ‚Üê Stock au 31/12/2023
2024    | 1,456        ‚Üê Stock au 31/12/2024
```

‚úÖ **Maintenant c'est correct !**

---

### EXERCICE 3.6 : Si vous avez Enterprise Edition

Si vous avez Enterprise ou Developer Edition, vous pouvez configurer directement :

1. Cube Structure ‚Üí S√©lectionner la mesure `Stock Level`

2. Properties (F4) :
   
   - `Aggregate Function` : **LastChild**

3. Deploy et tester

**R√©sultat** : Le comportement sera automatiquement correct sans mesure calcul√©e suppl√©mentaire.

---

## PARTIE 4 : VALIDATION FINALE (15 min)

### EXERCICE 4.1 : Cr√©er un rapport complet

Dans l'onglet **Browser**, cr√©ez ce rapport :

**Configuration :**

- **Rows** : Product Category
- **Columns** : Calendar Year
- **Values** (dans cet ordre) :
  1. Total Amount
  2. Net Profit
  3. Profit Margin %
  4. Quantity
  5. Average Unit Price
  6. Discount Rate %
  7. Stock Level (End of Period)

**Actions :**

1. Glisser `Dim Product` ‚Üí `Category` dans Rows
2. Glisser `Dim Date` ‚Üí `Calendar Year` dans Columns
3. Glisser toutes les mesures list√©es ci-dessus dans Values

**R√©sultat attendu :**

```
                    2023                                  2024
Category      Sales  Profit  Margin% ... Stock    Sales  Profit  Margin% ... Stock
--------------------------------------------------------------------------
Computers     50K    12K     24.00         456    60K    15K     25.00         523
Mobile        30K    6K      20.00         234    35K    7K      20.00         267
...
```

### EXERCICE 4.2 : V√©rifications

**Cochez chaque point :**

- [ ] Profit Margin % est correct (pas > 100%)
- [ ] Average Unit Price est coh√©rent (Total / Quantity)
- [ ] Discount Rate % est entre 0 et 100
- [ ] Stock Level ne montre pas de valeurs absurdes (millions)
- [ ] Toutes les mesures s'affichent sans erreur

---

## PARTIE 5 : NETTOYAGE (Optionnel)

### Masquer la mesure Unit Price incorrecte

1. Cube Structure
2. Cliquer sur la mesure `Unit Price` (l'ancienne avec Sum)
3. Properties ‚Üí `Visible` : **False**
4. Deploy

Maintenant, seule la mesure calcul√©e `Average Unit Price` sera visible.

---

## R√âCAPITULATIF : CE QUE VOUS AVEZ APPRIS

### Mesures Additives (Type 1)

‚úÖ **Reconnaissance** : On peut additionner sur toutes dimensions  
‚úÖ **Configuration** : Aggregate Function = Sum  
‚úÖ **Exemples** : Quantity, Total Amount, Net Profit

### Mesures Calcul√©es (Type 2)

‚úÖ **Cr√©ation** : Onglet Calculations ‚Üí New Calculated Member  
‚úÖ **Formule** : Expression MDX avec IIF pour g√©rer division par z√©ro  
‚úÖ **Exemples** : Profit Margin %, Average Unit Price

### Mesures Semi-Additives (Type 3)

‚úÖ **Probl√®me** : Additive sur certaines dimensions, pas sur Temps  
‚úÖ **Solution Standard** : Mesure calcul√©e avec LastChild  
‚úÖ **Solution Enterprise** : Aggregate Function = LastChild  
‚úÖ **Exemples** : Stock Level, Account Balance

### Mesures Non-Additives (Type 4)

‚úÖ **Reconnaissance** : Ratios, pourcentages, moyennes  
‚úÖ **Configuration** : Toujours des mesures calcul√©es  
‚úÖ **Exemples** : Discount Rate %, Exchange Rate

---

## CHECKLIST FINALE

Avant de terminer, v√©rifiez que vous savez faire :

- [ ] Ouvrir le cube dans SSDT
- [ ] Identifier le type d'une mesure existante
- [ ] Cr√©er une mesure calcul√©e dans l'onglet Calculations
- [ ] √âcrire une formule MDX simple avec IIF
- [ ] D√©ployer le cube
- [ ] Tester une mesure dans le Browser
- [ ] Ajouter une colonne √† la DSV (Refresh Table)
- [ ] Ajouter une mesure depuis la DSV par glisser-d√©poser
- [ ] Comprendre pourquoi Sum ne fonctionne pas pour le stock
- [ ] Cr√©er une mesure LastChild pour les mesures semi-additives

---

## AIDE-M√âMOIRE FORMULES MDX

### Division avec protection z√©ro

```mdx
IIF(
    [Measures].[Denominateur] = 0,
    NULL,
    [Measures].[Numerateur] / [Measures].[Denominateur]
)
```

### Pourcentage

```mdx
IIF(
    [Measures].[Total] = 0,
    NULL,
    ([Measures].[Partie] / [Measures].[Total]) * 100
)
```

### LastChild (End of Period)

```mdx
(
    [Date].[Hierarchy].CurrentMember.LastChild,
    [Measures].[Ma Mesure]
)
```

### FirstChild (Start of Period)

```mdx
(
    [Date].[Hierarchy].CurrentMember.FirstChild,
    [Measures].[Ma Mesure]
)
```

---

## EN CAS DE PROBL√àME

### Erreur au d√©ploiement

- V√©rifier la syntaxe MDX (parenth√®ses, virgules)
- V√©rifier que les noms de mesures existent
- Rebuilder le projet (Build ‚Üí Rebuild Solution)

### Mesure calcul√©e ne s'affiche pas

- V√©rifier Visible = True
- Reconnect dans Browser
- V√©rifier Parent Hierarchy = Measures

### Valeurs NULL partout

- V√©rifier que les mesures de base ont des donn√©es
- V√©rifier la formule MDX (division par z√©ro ?)

### Stock Level toujours absurde

- V√©rifier que vous utilisez la mesure calcul√©e avec LastChild
- V√©rifier que la dimension Date a une hi√©rarchie
