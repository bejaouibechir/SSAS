# Atelier MDX - Configuration de l'Environnement

## Objectif

Configurer un environnement **SQL Server Analysis Services (SSAS)** avec la base de donn√©es AdventureWorksDW pour pratiquer MDX.

## Pr√©requis

- SQL Server 2019 ou sup√©rieur (ou SQL Server 2017/2016)
- SQL Server Management Studio (SSMS) - derni√®re version
- SQL Server Data Tools (SSDT) ou Visual Studio 2019/2022 avec extension SSAS
- Base de donn√©es AdventureWorksDW

---

## √âtape 1 : Installation de la base de donn√©es AdventureWorksDW

### 1.1 T√©l√©chargement de la base de donn√©es

Microsoft fournit plusieurs versions d'AdventureWorksDW. T√©l√©chargez la version appropri√©e :

**Option 1 : AdventureWorksDW2019 (Recommand√©)**

```
URL de t√©l√©chargement : https://github.com/Microsoft/sql-server-samples/releases/download/adventureworks/AdventureWorksDW2019.bak
```

**Option 2 : AdventureWorksDW2017**

```
URL de t√©l√©chargement : https://github.com/Microsoft/sql-server-samples/releases/download/adventureworks/AdventureWorksDW2017.bak
```

**Option 3 : AdventureWorksDW2016**

```
URL de t√©l√©chargement : https://github.com/Microsoft/sql-server-samples/releases/download/adventureworks/AdventureWorksDW2016.bak
```

### 1.2 Restauration de la base de donn√©es

1. **T√©l√©chargez le fichier .bak** dans un r√©pertoire accessible par SQL Server (ex: `C:\Backup\`)

2. **Ouvrez SQL Server Management Studio (SSMS)**

3. **Connectez-vous √† votre instance SQL Server**

4. **Restaurez la base de donn√©es via l'interface graphique :**
   
   - Clic droit sur "Databases" ‚Üí "Restore Database..."
   - S√©lectionnez "Device" et cliquez sur "..."
   - Cliquez sur "Add" et naviguez vers le fichier .bak t√©l√©charg√©
   - Cliquez sur "OK" pour d√©marrer la restauration

5. **OU via T-SQL :**

```sql
-- Adapter les chemins selon votre configuration
USE master;
GO

RESTORE DATABASE AdventureWorksDW2019
FROM DISK = 'C:\Backup\AdventureWorksDW2019.bak'
WITH 
    MOVE 'AdventureWorksDW2017' TO 'C:\Program Files\Microsoft SQL Server\MSSQL15.MSSQLSERVER\MSSQL\DATA\AdventureWorksDW2019.mdf',
    MOVE 'AdventureWorksDW2017_log' TO 'C:\Program Files\Microsoft SQL Server\MSSQL15.MSSQLSERVER\MSSQL\DATA\AdventureWorksDW2019_log.ldf',
    REPLACE,
    STATS = 5;
GO
```

**Note :** Ajustez les chemins selon votre configuration SQL Server. Pour trouver le chemin par d√©faut :

```sql
SELECT SERVERPROPERTY('InstanceDefaultDataPath') AS DefaultDataPath;
SELECT SERVERPROPERTY('InstanceDefaultLogPath') AS DefaultLogPath;
```

### 1.3 V√©rification de la base de donn√©es

```sql
-- V√©rifier que la base est bien install√©e
USE AdventureWorksDW2019;
GO

-- Lister les tables principales
SELECT TABLE_SCHEMA, TABLE_NAME, TABLE_TYPE
FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_TYPE = 'BASE TABLE'
ORDER BY TABLE_NAME;

-- V√©rifier quelques donn√©es
SELECT COUNT(*) AS NbCustomers FROM DimCustomer;
SELECT COUNT(*) AS NbProducts FROM DimProduct;
SELECT COUNT(*) AS NbSales FROM FactInternetSales;
SELECT COUNT(*) AS NbDates FROM DimDate;
```

**R√©sultats attendus :**

- DimCustomer : ~18,000 lignes
- DimProduct : ~600 lignes
- FactInternetSales : ~60,000 lignes
- DimDate : plusieurs ann√©es de donn√©es

---

## √âtape 2 : Installation et configuration de SQL Server Analysis Services (SSAS)

### 2.1 V√©rification de l'installation SSAS

1. **Ouvrez SQL Server Configuration Manager**

2. **V√©rifiez que le service Analysis Services est d√©marr√© :**
   
   - Cherchez "SQL Server Analysis Services (MSSQLSERVER)" ou votre instance nomm√©e
   - Le statut doit √™tre "Running"
   - Si non d√©marr√©, clic droit ‚Üí Start

3. **V√©rifiez la connexion depuis SSMS :**
   
   - Dans SSMS, cliquez sur "Connect" ‚Üí "Analysis Services"
   - Nom du serveur : `localhost` ou `.` ou `(local)`
   - Cliquez sur "Connect"

### 2.2 Configuration des permissions

Pour pouvoir d√©ployer et requ√™ter le cube, vous devez √™tre administrateur de l'instance SSAS :

```sql
-- Depuis SSMS connect√© √† Analysis Services :
-- Clic droit sur le serveur ‚Üí Properties ‚Üí Security
-- Ajoutez votre compte Windows dans la liste des Server Administrators
```

**Alternative via PowerShell (en tant qu'administrateur) :**

```powershell
# Charger le module AMO
[System.Reflection.Assembly]::LoadWithPartialName("Microsoft.AnalysisServices")

# Se connecter au serveur
$server = New-Object Microsoft.AnalysisServices.Server
$server.Connect("localhost")

# Ajouter un administrateur (remplacez DOMAIN\User par votre compte)
$server.Roles["Administrators"].Members.Add("DOMAIN\User")
$server.Update()

$server.Disconnect()
```

---

## √âtape 3 : Cr√©ation du projet SSAS dans Visual Studio

### 3.1 Cr√©er un nouveau projet

1. **Ouvrez Visual Studio 2019/2022**

2. **Cr√©ez un nouveau projet :**
   
   - Fichier ‚Üí Nouveau ‚Üí Projet
   - Cherchez "Analysis Services" dans les templates
   - S√©lectionnez **"Analysis Services Multidimensional Project"**
   - Nom : `AtelierMDX`
   - Emplacement : choisissez un r√©pertoire de travail
   - Cliquez sur "Create"

### 3.2 Configuration de la Data Source

1. **Dans Solution Explorer, clic droit sur "Data Sources" ‚Üí "New Data Source..."**

2. **Assistant de cr√©ation de Data Source :**
   
   - Page Welcome : cliquez sur "Next"
   - Page "Select how to define the connection" :
     - Cliquez sur "New..."
     - Provider : Native OLE DB\SQL Server Native Client 11.0
     - Server name : `localhost` ou votre nom de serveur
     - Log on to the server : Use Windows Authentication
     - Select or enter a database name : `AdventureWorksDW2019` (ou 2017/2016)
     - Testez la connexion ‚Üí "Test Connection" doit r√©ussir
     - Cliquez sur "OK"
   - Page "Impersonation Information" :
     - S√©lectionnez "Use the service account"
     - Cliquez sur "Next"
   - Page "Completing the Wizard" :
     - Data source name : `Adventure Works DW`
     - Cliquez sur "Finish"

### 3.3 Configuration de la Data Source View (DSV)

1. **Clic droit sur "Data Source Views" ‚Üí "New Data Source View..."**

2. **Assistant de cr√©ation de DSV :**
   
   - Page Welcome : cliquez sur "Next"
   - Page "Select a Data Source" :
     - S√©lectionnez `Adventure Works DW`
     - Cliquez sur "Next"
   - Page "Select Tables and Views" :
     - Cochez les tables suivantes :
       - **Tables de dimension :**
         - `dbo.DimCustomer`
         - `dbo.DimDate`
         - `dbo.DimGeography`
         - `dbo.DimProduct`
         - `dbo.DimProductCategory`
         - `dbo.DimProductSubcategory`
         - `dbo.DimSalesTerritory`
       - **Table de faits :**
         - `dbo.FactInternetSales`
     - Cliquez sur "Next"
   - Page "Completing the Wizard" :
     - Name : `Adventure Works DW`
     - Cliquez sur "Finish"

3. **V√©rification de la DSV :**
   
   - Double-cliquez sur `Adventure Works DW.dsv` dans le Solution Explorer
   - Vous devez voir un diagramme montrant toutes les tables et leurs relations
   - Les relations (cl√©s √©trang√®res) doivent √™tre repr√©sent√©es par des fl√®ches

---

## √âtape 4 : Cr√©ation du cube SSAS

### 4.1 Utiliser l'assistant Cube Wizard

1. **Clic droit sur "Cubes" ‚Üí "New Cube..."**

2. **Assistant de cr√©ation de Cube :**
   
   **Page "Select Creation Method" :**
   
   - S√©lectionnez "Use existing tables"
   - Cliquez sur "Next"
   
   **Page "Select Measure Group Tables" :**
   
   - Cochez `dbo.FactInternetSales`
   - Cliquez sur "Next"
   
   **Page "Select Measures" :**
   
   - Cochez les mesures suivantes (laissez les autres d√©coch√©es pour simplifier) :
     - `Sales Amount`
     - `Order Quantity`
     - `Unit Price`
     - `Total Product Cost`
     - `Tax Amt`
     - `Freight`
     - `Fact Internet Sales Count` (mesure de comptage automatique)
   - Cliquez sur "Next"
   
   **Page "Select Existing Dimensions" :**
   
   - Aucune dimension n'existe encore, cliquez simplement sur "Next"
   
   **Page "Select New Dimensions" :**
   
   - Cochez toutes les dimensions propos√©es :
     - `Dim Customer`
     - `Dim Date` (OrderDate)
     - `Dim Date` (DueDate)
     - `Dim Date` (ShipDate)
     - `Dim Geography`
     - `Dim Product`
     - `Dim Product Category`
     - `Dim Product Subcategory`
     - `Dim Sales Territory`
   - Cliquez sur "Next"
   
   **Page "Completing the Wizard" :**
   
   - Cube name : `Adventure Works`
   - Cliquez sur "Finish"

### 4.2 V√©rification initiale du cube

Le cube est maintenant cr√©√© avec une structure de base. Vous devez voir dans le Solution Explorer :

- **Cubes** ‚Üí `Adventure Works.cube`
- **Dimensions** ‚Üí plusieurs dimensions (Customer, Date, Product, etc.)

---

## √âtape 5 : Configuration des hi√©rarchies

Les hi√©rarchies sont essentielles pour naviguer dans les donn√©es avec MDX. Configurons-les pour chaque dimension.

### 5.1 Hi√©rarchie Date (Calendar Hierarchy)

1. **Ouvrez la dimension Date :**
   
   - Dans Solution Explorer ‚Üí Dimensions ‚Üí double-cliquez sur `Dim Date.dim`

2. **Cr√©ez la hi√©rarchie Calendar :**
   
   - Dans le panneau "Attributes", s√©lectionnez `Calendar Year`
   - Glissez-le vers le panneau "Hierarchies and Levels" (panneau central)
   - Une nouvelle hi√©rarchie appel√©e "Calendar Year" est cr√©√©e
   - Renommez-la en "Calendar Hierarchy" (clic droit ‚Üí Rename)

3. **Ajoutez les niveaux :**
   
   - Glissez `Calendar Semester` sous `Calendar Year` dans la hi√©rarchie
   - Glissez `Calendar Quarter` sous `Calendar Semester`
   - Glissez `English Month Name` sous `Calendar Quarter`
   - Glissez `Full Date Alternate Key` sous `English Month Name`

4. **Structure finale de Calendar Hierarchy :**
   
   ```
   Calendar Hierarchy
   ‚îú‚îÄ‚îÄ Calendar Year
   ‚îú‚îÄ‚îÄ Calendar Semester
   ‚îú‚îÄ‚îÄ Calendar Quarter
   ‚îú‚îÄ‚îÄ English Month Name
   ‚îî‚îÄ‚îÄ Full Date Alternate Key
   ```

5. **Configurez les propri√©t√©s des niveaux :**
   
   - S√©lectionnez le niveau `English Month Name`
   - Dans Properties, changez `OrderBy` ‚Üí `Month Number Of Year`
   - Cela permet de trier les mois correctement (janvier √† d√©cembre)

### 5.2 Hi√©rarchie Fiscal (Fiscal Hierarchy)

1. **Dans la m√™me dimension Date, cr√©ez une deuxi√®me hi√©rarchie :**
   
   - Glissez `Fiscal Year` vers le panneau "Hierarchies and Levels"
   - Renommez en "Fiscal Hierarchy"

2. **Ajoutez les niveaux :**
   
   - `Fiscal Year`
   - `Fiscal Semester` (sous Fiscal Year)
   - `Fiscal Quarter` (sous Fiscal Semester)

### 5.3 Hi√©rarchie Product

1. **Ouvrez la dimension Product :**
   
   - Dimensions ‚Üí double-cliquez sur `Dim Product.dim`

2. **Cr√©ez la Product Hierarchy :**
   
   - Glissez `Product Category Key` vers "Hierarchies and Levels"
   - Renommez en "Product Hierarchy"
   - Ajoutez `Product Subcategory Key` sous Category
   - Ajoutez `Product Key` (ou `English Product Name`) sous Subcategory

3. **Structure finale :**
   
   ```
   Product Hierarchy
   ‚îú‚îÄ‚îÄ Product Category
   ‚îú‚îÄ‚îÄ Product Subcategory
   ‚îî‚îÄ‚îÄ Product Name
   ```

### 5.4 Hi√©rarchie Customer Geography

1. **Ouvrez Dim Customer :**
   
   - Dimensions ‚Üí `Dim Customer.dim`

2. **Cr√©ez Customer Hierarchy :**
   
   - Glissez `Geography Key` vers "Hierarchies and Levels"
   - Renommez en "Customer Hierarchy"
   - Cette hi√©rarchie utilisera la dimension Geography li√©e

3. **Alternative - Hi√©rarchie g√©ographique dans DimGeography :**
   
   - Ouvrez `Dim Geography.dim`
   
   - Cr√©ez une hi√©rarchie "Geography Hierarchy" :
     
     ```
     Geography Hierarchy‚îú‚îÄ‚îÄ Sales Territory Key (Country/Region)‚îú‚îÄ‚îÄ State Province Name‚îî‚îÄ‚îÄ City
     ```

### 5.5 Hi√©rarchie Sales Territory

1. **Ouvrez Dim Sales Territory :**
   
   - Dimensions ‚Üí `Dim Sales Territory.dim`

2. **Cr√©ez Sales Territory Hierarchy :**
   
   ```
   Sales Territory Hierarchy
   ‚îú‚îÄ‚îÄ Sales Territory Group
   ‚îú‚îÄ‚îÄ Sales Territory Country
   ‚îî‚îÄ‚îÄ Sales Territory Region
   ```

---

## √âtape 6 : D√©ploiement et traitement du cube

### 6.1 Configuration du d√©ploiement

1. **Clic droit sur le projet `AtelierMDX` dans Solution Explorer**

2. **S√©lectionnez "Properties"**

3. **Dans Configuration Properties ‚Üí Deployment :**
   
   - Server : `localhost` (ou votre serveur SSAS)
   - Database : `AtelierMDX`
   - Processing Option : `Full`
   - Transactional Deployment : `False`

### 6.2 Construire et d√©ployer

1. **Build le projet :**
   
   - Clic droit sur le projet ‚Üí "Build"
   - V√©rifiez qu'il n'y a pas d'erreurs dans la fen√™tre Output

2. **D√©ployer le projet :**
   
   - Clic droit sur le projet ‚Üí "Deploy"
   - Le processus prend quelques minutes
   - Surveillez la fen√™tre "Deployment Progress"

3. **V√©rification du d√©ploiement :**
   
   - Ouvrez SSMS
   - Connectez-vous √† Analysis Services
   - D√©veloppez Databases ‚Üí vous devez voir `AtelierMDX`
   - D√©veloppez AtelierMDX ‚Üí Cubes ‚Üí `Adventure Works`

---

## √âtape 7 : Test de la connexion MDX

### 7.1 Premi√®re requ√™te MDX dans SSMS

1. **Dans SSMS connect√© √† Analysis Services :**
   
   - Fichier ‚Üí Nouveau ‚Üí Requ√™te Analysis Services ‚Üí MDX
   - OU cliquez sur l'ic√¥ne "New MDX Query"

2. **Connectez-vous √† la base de donn√©es :**
   
   - Dans la barre d'outils, s√©lectionnez `AtelierMDX` dans la liste d√©roulante des bases

3. **Ex√©cutez votre premi√®re requ√™te MDX :**

```mdx
SELECT
  [Measures].[Sales Amount] ON COLUMNS,
  [Dim Date].[Calendar Hierarchy].[Calendar Year].MEMBERS ON ROWS
FROM [Adventure Works]
```

4. **Cliquez sur "Execute" (F5)**

**R√©sultat attendu :**

```
             Sales Amount
2010         ...
2011         ...
2012         ...
2013         ...
2014         ...
```

### 7.2 V√©rification des hi√©rarchies

```mdx
-- Test hi√©rarchie produits
SELECT
  [Measures].[Sales Amount] ON COLUMNS,
  [Dim Product].[Product Hierarchy].MEMBERS ON ROWS
FROM [Adventure Works]

-- Test hi√©rarchie g√©ographique
SELECT
  [Measures].[Sales Amount] ON COLUMNS,
  [Dim Sales Territory].[Sales Territory Hierarchy].MEMBERS ON ROWS
FROM [Adventure Works]
```

---

## √âtape 8 : Configuration des utilisateurs (optionnel - pour environnement multi-utilisateurs)

### 8.1 Cr√©er un r√¥le de lecture

1. **Dans SSMS, connect√© √† Analysis Services :**
   
   - D√©veloppez Databases ‚Üí AtelierMDX ‚Üí Roles
   - Clic droit sur Roles ‚Üí New Role...

2. **Configuration du r√¥le :**
   
   - General :
     - Role name : `MDX Readers`
     - Description : `Lecture seule pour les exercices MDX`
   - Membership :
     - Cliquez sur "Add..."
     - Ajoutez les utilisateurs Windows qui auront acc√®s
   - Cubes :
     - S√©lectionnez le cube "Adventure Works"
     - Access : `Read`
   - Cell Data :
     - Laissez "Enable read permissions" coch√©
   - Cliquez sur "OK"

### 8.2 Tester avec un utilisateur non-admin

Les utilisateurs ajout√©s au r√¥le pourront maintenant :

- Se connecter √† Analysis Services
- Ex√©cuter des requ√™tes MDX en lecture seule
- Ne pourront PAS modifier la structure du cube

---

## √âtape 9 : Outils additionnels (optionnel mais recommand√©)

### 9.1 Excel pour visualiser les r√©sultats

Excel peut se connecter directement au cube SSAS :

1. **Dans Excel :**
   
   - Donn√©es ‚Üí Obtenir des donn√©es ‚Üí √Ä partir d'Analysis Services

2. **Connexion :**
   
   - Serveur : `localhost`
   - Base de donn√©es : `AtelierMDX`
   - Cube : `Adventure Works`

3. **Avantages :**
   
   - Visualisation interactive des donn√©es
   - Cr√©ation de tableaux crois√©s dynamiques
   - Graphiques bas√©s sur les requ√™tes MDX

### 9.2 DAX Studio (alternative pour tests)

DAX Studio peut aussi ex√©cuter des requ√™tes MDX :

1. T√©l√©chargez depuis : https://daxstudio.org/
2. Connectez-vous √† votre serveur SSAS
3. Ex√©cutez des requ√™tes MDX dans l'√©diteur

### 9.3 SSAS Tabular Editor (si vous migrez vers tabular plus tard)

Pour information, si vous travaillez avec des mod√®les tabulaires :

- https://tabulareditor.com/

---

## R√©sum√© de la configuration

Vous avez maintenant :

 Base de donn√©es AdventureWorksDW2019 restaur√©e  
 SQL Server Analysis Services configur√© et d√©marr√©  
 Projet SSAS cr√©√© dans Visual Studio  
 Data Source et Data Source View configur√©es  
 Cube "Adventure Works" cr√©√© et d√©ploy√©  
 Hi√©rarchies configur√©es (Date, Product, Geography, Territory)  
 Permissions configur√©es (optionnel)  
 Premi√®re requ√™te MDX test√©e avec succ√®s

**Vous √™tes pr√™t √† commencer les exercices MDX ! üéâ**

---

## D√©pannage (Troubleshooting)

### Probl√®me : "Cannot connect to Analysis Services"

**Solutions :**

1. V√©rifiez que le service SSAS est d√©marr√© (SQL Server Configuration Manager)
2. V√©rifiez le firewall Windows (port 2383 par d√©faut pour SSAS)
3. Essayez de vous connecter avec `localhost`, `.`, `(local)`, ou le nom complet du serveur

### Probl√®me : "Deployment failed"

**Solutions :**

1. V√©rifiez que vous √™tes administrateur du serveur SSAS

2. V√©rifiez que la base de donn√©es source (AdventureWorksDW) est accessible

3. Supprimez la base SSAS existante et red√©ployez :
   
   ```sql
   -- Dans SSMS connect√© √† SSAS-- Clic droit sur AtelierMDX ‚Üí Delete
   ```

### Probl√®me : "The hierarchy contains no levels"

**Solutions :**

1. Retournez dans la dimension concern√©e
2. V√©rifiez que les attributs sont bien ajout√©s √† la hi√©rarchie
3. Reconstruisez et red√©ployez le projet

### Probl√®me : Les donn√©es ne s'affichent pas

**Solutions :**

1. V√©rifiez que le cube a √©t√© trait√© (processed) :
   
   ```sql
   -- Dans SSMS connect√© √† SSAS-- Clic droit sur le cube ‚Üí Process ‚Üí Process Full
   ```

2. V√©rifiez les relations entre les tables dans la DSV

---

## Prochaines √©tapes

Passez maintenant au fichier **02_Structure_Cube_XMLA.md** pour obtenir le script XMLA complet du cube si vous souhaitez le d√©ployer automatiquement.

Ensuite, rendez-vous dans **03_Exercices_MDX.md** pour commencer les 40+ exercices pratiques !
