# Atelier 4 : Scripts et SCOPE

## Calculs Complexes et Conditionnels dans le Cube

---

## Pr√©requis

‚úÖ Atelier 1 compl√©t√© (Cube d√©ploy√© avec donn√©es)
‚úÖ Atelier 2 compl√©t√© (Membres calcul√©s ma√Ætris√©s)
‚úÖ Atelier 3 compl√©t√© (Named Sets cr√©√©s)
‚úÖ Compr√©hension de base de MDX

---

## Objectifs de l'Atelier

Ma√Ætriser les scripts MDX avec SCOPE pour :

1. **Remises automatiques par volume** - Calculs conditionnels sur quantit√©
2. **Allocation budg√©taire dynamique** - Distribution par r√©gion
3. **Commissions par canal** - Calculs diff√©renci√©s selon le canal
4. **Pr√©visions bas√©es sur historique** - Projections automatiques
5. **R√©partition des frais marketing** - Allocation proportionnelle
6. **Calculs multi-niveaux hi√©rarchiques** - Agr√©gations personnalis√©es

---

## Partie 1 : Comprendre les Scripts et SCOPE

### Qu'est-ce qu'un Script MDX ?

Les scripts permettent de d√©finir des **sous-cubes** et d'y appliquer des calculs sp√©cifiques. Contrairement aux membres calcul√©s qui s'appliquent globalement, les scripts permettent des calculs **contextuels**.

### Structure de base d'un SCOPE

```mdx
SCOPE(sous-cube);
    THIS = expression;
END SCOPE;
```

**Composants** :

- **SCOPE** : D√©finit la zone du cube concern√©e
- **THIS** : Repr√©sente les cellules du scope courant
- **END SCOPE** : Ferme le scope

### Pourquoi utiliser SCOPE ?

| Approche       | Avantage             | Inconv√©nient  |
| -------------- | -------------------- | ------------- |
| Membre calcul√© | Simple, global       | Peu flexible  |
| SCOPE          | Flexible, contextuel | Plus complexe |

**Cas d'usage SCOPE** :

- Calculs diff√©rents selon la dimension
- Modifications de valeurs existantes
- Calculs hi√©rarchiques complexes
- Allocations conditionnelles

---

## Partie 2 : Acc√©der √† l'√âditeur de Scripts

1. **Ouvrir** le projet `ProjetCube_ECommerce`
2. **Double-cliquer** sur `Cube_Ventes.cube`
3. **Onglet Calculations**
4. **Cliquer** sur le script `CALCULATE;` (premier √©l√©ment)
5. **Passer en Script View** (ic√¥ne dans la barre d'outils)

### Emplacement du code

Tout le code script doit √™tre plac√© **apr√®s** la ligne `CALCULATE;`

---

## Partie 3 : Script 1 - Remises Automatiques par Volume

### Contexte M√©tier

Appliquer des remises progressives selon la quantit√© command√©e :

- 100-499 unit√©s : -5%
- 500-999 unit√©s : -10%
- 1000+ unit√©s : -15%

### Impl√©mentation

**Apr√®s la ligne CALCULATE;**, ajouter :

```mdx
/* ================================================================
   SCRIPT 1 : REMISES AUTOMATIQUES PAR VOLUME
   Applique des remises d√©gressives selon la quantit√© achet√©e
================================================================ */

-- Cr√©er une nouvelle mesure pour le prix avec remise volume
CREATE MEMBER CURRENTCUBE.[Measures].[Prix Unitaire Remis√©]
AS [Measures].[Prix Unitaire],
FORMAT_STRING = "Currency",
VISIBLE = 1,
DISPLAY_FOLDER = "Tarification";

-- Scope pour quantit√©s 100-499
SCOPE(
    [Measures].[Prix Unitaire Remis√©],
    {[Measures].[Quantite] >= 100 AND [Measures].[Quantite] < 500}
);
    THIS = [Measures].[Prix Unitaire] * 0.95; -- -5%
END SCOPE;

-- Scope pour quantit√©s 500-999
SCOPE(
    [Measures].[Prix Unitaire Remis√©],
    {[Measures].[Quantite] >= 500 AND [Measures].[Quantite] < 1000}
);
    THIS = [Measures].[Prix Unitaire] * 0.90; -- -10%
END SCOPE;

-- Scope pour quantit√©s 1000+
SCOPE(
    [Measures].[Prix Unitaire Remis√©],
    {[Measures].[Quantite] >= 1000}
);
    THIS = [Measures].[Prix Unitaire] * 0.85; -- -15%
END SCOPE;

-- Calcul du CA avec remise volume
CREATE MEMBER CURRENTCUBE.[Measures].[CA Remise Volume]
AS [Measures].[Prix Unitaire Remis√©] * [Measures].[Quantite],
FORMAT_STRING = "Currency",
VISIBLE = 1,
DISPLAY_FOLDER = "Tarification";
```

### Test

1. **D√©ployer** le projet
2. **Browser** ‚Üí Reconnect
3. **Navigation** :
   - Lignes : `Nom Produit`
   - Valeurs : `Quantite`, `Prix Unitaire`, `Prix Unitaire Remis√©`, `CA Remise Volume`
4. **Observer** : Le prix diminue selon les paliers de quantit√©

---

## Partie 4 : Script 2 - Allocation Budg√©taire par R√©gion

### Contexte M√©tier

Allouer un budget de croissance de +12% sur le CA N-1, r√©parti proportionnellement par r√©gion selon leurs performances historiques.

### Impl√©mentation

```mdx
/* ================================================================
   SCRIPT 2 : ALLOCATION BUDGETAIRE DYNAMIQUE PAR R√âGION
   Budget 2025 = CA 2024 * 1.12 (objectif +12% croissance)
================================================================ */

-- Cr√©er la mesure Budget
CREATE MEMBER CURRENTCUBE.[Measures].[Budget Allou√©]
AS NULL,
FORMAT_STRING = "Currency",
VISIBLE = 1,
DISPLAY_FOLDER = "Budget et Objectifs";

-- Scope pour l'ann√©e 2025 (projection)
SCOPE(
    [Measures].[Budget Allou√©],
    [Dim Temps].[Calendrier].[Annee].&[2025]
);
    -- Budget bas√© sur CA 2024 + 12%
    THIS = (
        [Measures].[Chiffre d'Affaires],
        [Dim Temps].[Calendrier].[Annee].&[2024]
    ) * 1.12;
END SCOPE;

-- Scope pour r√©partition par r√©gion
SCOPE(
    [Measures].[Budget Allou√©],
    [Dim Temps].[Calendrier].[Annee].&[2025],
    [Dim Client].[G√©ographie].[Region].MEMBERS
);
    -- Allocation proportionnelle bas√©e sur performance historique
    THIS = (
        [Measures].[Chiffre d'Affaires],
        [Dim Client].[G√©ographie].[Region].CURRENTMEMBER,
        [Dim Temps].[Calendrier].[Annee].&[2024]
    ) * 1.12;
END SCOPE;

-- Calcul du taux de r√©alisation
CREATE MEMBER CURRENTCUBE.[Measures].[Taux R√©alisation Budget]
AS 
    IIF(
        [Measures].[Budget Allou√©] = 0,
        NULL,
        [Measures].[Chiffre d'Affaires] / [Measures].[Budget Allou√©]
    ),
FORMAT_STRING = "Percent",
VISIBLE = 1,
DISPLAY_FOLDER = "Budget et Objectifs";
```

### Test

1. **D√©ployer**
2. **Navigation** :
   - Lignes : `G√©ographie` ‚Üí `Region`
   - Colonnes : `Annee` (2024 et 2025)
   - Valeurs : `Chiffre d'Affaires`, `Budget Allou√©`
3. **V√©rifier** : Budget 2025 = CA 2024 √ó 1.12

---

## Partie 5 : Script 3 - Commissions par Canal de Vente

### Contexte M√©tier

Calculer les commissions selon le canal de vente :

- Site Web / App Mobile : 2%
- Amazon Marketplace : 15%
- eBay : 12%
- Magasin Physique : 0% (vendeurs salari√©s)

### Impl√©mentation

```mdx
/* ================================================================
   SCRIPT 3 : CALCUL DES COMMISSIONS PAR CANAL
   Commissions variables selon le type de canal de distribution
================================================================ */

-- Cr√©er la mesure Commission
CREATE MEMBER CURRENTCUBE.[Measures].[Commission]
AS 0,
FORMAT_STRING = "Currency",
VISIBLE = 1,
DISPLAY_FOLDER = "Commissions";

-- Commission 2% pour Site Web
SCOPE(
    [Measures].[Commission],
    [Dim Canal].[Nom Canal].&[Site Web]
);
    THIS = [Measures].[Chiffre d'Affaires] * 0.02;
END SCOPE;

-- Commission 2% pour App Mobile
SCOPE(
    [Measures].[Commission],
    [Dim Canal].[Nom Canal].&[Application Mobile]
);
    THIS = [Measures].[Chiffre d'Affaires] * 0.02;
END SCOPE;

-- Commission 15% pour Amazon
SCOPE(
    [Measures].[Commission],
    [Dim Canal].[Nom Canal].&[Amazon Marketplace]
);
    THIS = [Measures].[Chiffre d'Affaires] * 0.15;
END SCOPE;

-- Commission 12% pour eBay
SCOPE(
    [Measures].[Commission],
    [Dim Canal].[Nom Canal].&[eBay]
);
    THIS = [Measures].[Chiffre d'Affaires] * 0.12;
END SCOPE;

-- Commission 0% pour Magasin Physique
SCOPE(
    [Measures].[Commission],
    [Dim Canal].[Nom Canal].&[Magasin Physique]
);
    THIS = 0;
END SCOPE;

-- Calcul de la marge nette apr√®s commission
CREATE MEMBER CURRENTCUBE.[Measures].[Marge Nette Apr√®s Commission]
AS 
    [Measures].[Marge Commerciale] - [Measures].[Commission],
FORMAT_STRING = "Currency",
VISIBLE = 1,
DISPLAY_FOLDER = "Commissions";

-- Calcul du taux de marge nette
CREATE MEMBER CURRENTCUBE.[Measures].[Taux Marge Nette]
AS 
    IIF(
        [Measures].[Chiffre d'Affaires] = 0,
        NULL,
        [Measures].[Marge Nette Apr√®s Commission] / [Measures].[Chiffre d'Affaires]
    ),
FORMAT_STRING = "Percent",
VISIBLE = 1,
DISPLAY_FOLDER = "Commissions";
```

### Test

1. **D√©ployer**
2. **Navigation** :
   - Lignes : `Type de Canal` ‚Üí `Nom Canal`
   - Valeurs : `CA`, `Commission`, `Marge Commerciale`, `Marge Nette Apr√®s Commission`, `Taux Marge Nette`
3. **Analyser** : La rentabilit√© r√©elle par canal

---

## Partie 6 : Script 4 - Pr√©visions Automatiques

### Contexte M√©tier

G√©n√©rer des pr√©visions pour 2025 bas√©es sur :

- Moyenne mobile des 12 derniers mois
- Facteur de croissance saisonni√®re
- Ajustement selon la tendance historique

### Impl√©mentation

```mdx
/* ================================================================
   SCRIPT 4 : PR√âVISIONS AUTOMATIQUES POUR 2025
   Bas√© sur historique 2023-2024 avec facteur de croissance
================================================================ */

-- Cr√©er la mesure Pr√©vision
CREATE MEMBER CURRENTCUBE.[Measures].[Pr√©vision CA]
AS NULL,
FORMAT_STRING = "Currency",
VISIBLE = 1,
DISPLAY_FOLDER = "Pr√©visions";

-- Scope pour les mois de 2025
SCOPE(
    [Measures].[Pr√©vision CA],
    [Dim Temps].[Calendrier].[Annee].&[2025],
    DESCENDANTS([Dim Temps].[Calendrier].[Annee].&[2025], [Dim Temps].[Calendrier].[Mois Nom])
);
    -- Pr√©vision = Moyenne du m√™me mois sur 2 ans pr√©c√©dents * 1.08 (croissance)
    THIS = (
        (
            ([Measures].[Chiffre d'Affaires], 
             PARALLELPERIOD([Dim Temps].[Calendrier].[Annee], 1, [Dim Temps].[Calendrier].CURRENTMEMBER))
            +
            ([Measures].[Chiffre d'Affaires], 
             PARALLELPERIOD([Dim Temps].[Calendrier].[Annee], 2, [Dim Temps].[Calendrier].CURRENTMEMBER))
        ) / 2
    ) * 1.08;
END SCOPE;

-- Scope pour pr√©visions par cat√©gorie de produits
SCOPE(
    [Measures].[Pr√©vision CA],
    [Dim Temps].[Calendrier].[Annee].&[2025],
    [Dim Produit].[Hi√©rarchie Produit].[Categorie].MEMBERS
);
    -- Ajustement selon performance cat√©gorie
    THIS = AVG(
        {
            ([Dim Temps].[Calendrier].[Annee].&[2023], [Measures].[Chiffre d'Affaires]),
            ([Dim Temps].[Calendrier].[Annee].&[2024], [Measures].[Chiffre d'Affaires])
        }
    ) * 1.10; -- +10% croissance cat√©gorie
END SCOPE;

-- √âcart pr√©vision vs r√©el (pour 2024 et ann√©es ant√©rieures)
CREATE MEMBER CURRENTCUBE.[Measures].[√âcart Pr√©vision]
AS 
    [Measures].[Chiffre d'Affaires] - [Measures].[Pr√©vision CA],
FORMAT_STRING = "Currency",
VISIBLE = 1,
DISPLAY_FOLDER = "Pr√©visions";

-- Pr√©cision de la pr√©vision
CREATE MEMBER CURRENTCUBE.[Measures].[Pr√©cision Pr√©vision %]
AS 
    IIF(
        [Measures].[Pr√©vision CA] = 0,
        NULL,
        1 - (ABS([Measures].[√âcart Pr√©vision]) / [Measures].[Pr√©vision CA])
    ),
FORMAT_STRING = "Percent",
VISIBLE = 1,
DISPLAY_FOLDER = "Pr√©visions";
```

### Test

1. **D√©ployer**
2. **Navigation** :
   - Lignes : `Calendrier` ‚Üí `Mois Nom`
   - Colonnes : `Annee` (2023, 2024, 2025)
   - Valeurs : `Chiffre d'Affaires`, `Pr√©vision CA`
3. **Comparer** : R√©el 2023-2024 vs Pr√©vision 2025

---

## Partie 7 : Script 5 - R√©partition Proportionnelle des Frais

### Contexte M√©tier

R√©partir le budget marketing (100 000‚Ç¨) proportionnellement au CA de chaque cat√©gorie de produits.

### Impl√©mentation

```mdx
/* ================================================================
   SCRIPT 5 : ALLOCATION PROPORTIONNELLE DES FRAIS MARKETING
   R√©partition du budget selon contribution au CA total
================================================================ */

-- Budget marketing total fixe
CREATE MEMBER CURRENTCUBE.[Measures].[Budget Marketing Total]
AS 100000,
FORMAT_STRING = "Currency",
VISIBLE = 1,
DISPLAY_FOLDER = "Marketing";

-- Allocation par cat√©gorie
CREATE MEMBER CURRENTCUBE.[Measures].[Budget Marketing Allou√©]
AS NULL,
FORMAT_STRING = "Currency",
VISIBLE = 1,
DISPLAY_FOLDER = "Marketing";

-- Scope pour allocation aux cat√©gories
SCOPE(
    [Measures].[Budget Marketing Allou√©],
    [Dim Produit].[Hi√©rarchie Produit].[Categorie].MEMBERS
);
    -- Allocation proportionnelle au CA de la cat√©gorie
    THIS = [Measures].[Budget Marketing Total] * 
           (
               [Measures].[Chiffre d'Affaires] / 
               ([Measures].[Chiffre d'Affaires], [Dim Produit].[Hi√©rarchie Produit].[All])
           );
END SCOPE;

-- Scope pour r√©partition aux sous-cat√©gories
SCOPE(
    [Measures].[Budget Marketing Allou√©],
    [Dim Produit].[Hi√©rarchie Produit].[Sous Categorie].MEMBERS
);
    -- R√©partition dans la sous-cat√©gorie selon sa contribution
    THIS = (
        [Measures].[Budget Marketing Allou√©], 
        [Dim Produit].[Hi√©rarchie Produit].CURRENTMEMBER.PARENT
    ) * (
        [Measures].[Chiffre d'Affaires] / 
        (
            [Measures].[Chiffre d'Affaires], 
            [Dim Produit].[Hi√©rarchie Produit].CURRENTMEMBER.PARENT
        )
    );
END SCOPE;

-- ROI Marketing (CA g√©n√©r√© / Budget allou√©)
CREATE MEMBER CURRENTCUBE.[Measures].[ROI Marketing]
AS 
    IIF(
        [Measures].[Budget Marketing Allou√©] = 0,
        NULL,
        [Measures].[Chiffre d'Affaires] / [Measures].[Budget Marketing Allou√©]
    ),
FORMAT_STRING = "#,##0.00",
VISIBLE = 1,
DISPLAY_FOLDER = "Marketing";
```

### Test

1. **D√©ployer**
2. **Navigation** :
   - Lignes : `Hi√©rarchie Produit` (d√©velopper Cat√©gorie ‚Üí Sous Categorie)
   - Valeurs : `CA`, `Budget Marketing Allou√©`, `ROI Marketing`
3. **V√©rifier** : La somme des budgets allou√©s = 100 000‚Ç¨

---

## Partie 8 : Script 6 - Calculs Diff√©renci√©s par Segment Client

### Contexte M√©tier

Appliquer des r√®gles de calcul diff√©rentes selon le segment du client :

- Premium : Remise fid√©lit√© 5%
- Professionnel : Conditions nettes (0% remise)
- Particulier : Remise standard

### Impl√©mentation

```mdx
/* ================================================================
   SCRIPT 6 : TARIFICATION DIFF√âRENCI√âE PAR SEGMENT CLIENT
   Conditions commerciales adapt√©es au type de client
================================================================ */

-- Cr√©er mesure CA Segment
CREATE MEMBER CURRENTCUBE.[Measures].[CA Apr√®s Ajustement Segment]
AS [Measures].[Chiffre d'Affaires],
FORMAT_STRING = "Currency",
VISIBLE = 1,
DISPLAY_FOLDER = "Segmentation";

-- Scope pour clients Premium : bonus -5%
SCOPE(
    [Measures].[CA Apr√®s Ajustement Segment],
    [Dim Client].[Segment].&[Premium]
);
    THIS = [Measures].[Chiffre d'Affaires] * 0.95;
END SCOPE;

-- Scope pour clients Professionnels : conditions nettes
SCOPE(
    [Measures].[CA Apr√®s Ajustement Segment],
    [Dim Client].[Segment].&[Professionnel]
);
    -- Annuler toutes les remises pour les pros
    THIS = [Measures].[Montant Brut];
END SCOPE;

-- Calcul de la valeur vie client (LTV) - simplifi√©e
CREATE MEMBER CURRENTCUBE.[Measures].[Valeur Vie Client Estim√©e]
AS NULL,
FORMAT_STRING = "Currency",
VISIBLE = 1,
DISPLAY_FOLDER = "Segmentation";

SCOPE(
    [Measures].[Valeur Vie Client Estim√©e],
    [Dim Client].[Segment].&[Premium]
);
    -- Premium : LTV = CA annuel * 5 ans
    THIS = [Measures].[Chiffre d'Affaires] * 5;
END SCOPE;

SCOPE(
    [Measures].[Valeur Vie Client Estim√©e],
    [Dim Client].[Segment].&[Professionnel]
);
    -- Professionnel : LTV = CA annuel * 7 ans
    THIS = [Measures].[Chiffre d'Affaires] * 7;
END SCOPE;

SCOPE(
    [Measures].[Valeur Vie Client Estim√©e],
    [Dim Client].[Segment].&[Particulier]
);
    -- Particulier : LTV = CA annuel * 3 ans
    THIS = [Measures].[Chiffre d'Affaires] * 3;
END SCOPE;
```

### Test

1. **D√©ployer**
2. **Navigation** :
   - Lignes : `Segment`
   - Valeurs : `CA`, `CA Apr√®s Ajustement Segment`, `Valeur Vie Client Estim√©e`
3. **Analyser** : L'impact des ajustements par segment

---

## Partie 9 : Script 7 - Calcul Hi√©rarchique Personnalis√©

### Contexte M√©tier

Modifier le comportement d'agr√©gation pour certaines mesures selon le niveau hi√©rarchique.

### Impl√©mentation

```mdx
/* ================================================================
   SCRIPT 7 : AGR√âGATIONS HI√âRARCHIQUES PERSONNALIS√âES
   Calculs diff√©rents selon le niveau d'analyse
================================================================ */

-- Cr√©er une mesure de performance
CREATE MEMBER CURRENTCUBE.[Measures].[Score Performance]
AS NULL,
FORMAT_STRING = "#,##0.00",
VISIBLE = 1,
DISPLAY_FOLDER = "Performance";

-- Au niveau Produit : Score = Marge * Quantit√© / 1000
SCOPE(
    [Measures].[Score Performance],
    [Dim Produit].[Hi√©rarchie Produit].[Nom Produit].MEMBERS
);
    THIS = ([Measures].[Marge Commerciale] * [Measures].[Quantite]) / 1000;
END SCOPE;

-- Au niveau Sous-Cat√©gorie : Moyenne des scores produits
SCOPE(
    [Measures].[Score Performance],
    [Dim Produit].[Hi√©rarchie Produit].[Sous Categorie].MEMBERS
);
    THIS = AVG(
        [Dim Produit].[Hi√©rarchie Produit].CURRENTMEMBER.CHILDREN,
        [Measures].[Score Performance]
    );
END SCOPE;

-- Au niveau Cat√©gorie : Somme pond√©r√©e
SCOPE(
    [Measures].[Score Performance],
    [Dim Produit].[Hi√©rarchie Produit].[Categorie].MEMBERS
);
    THIS = SUM(
        [Dim Produit].[Hi√©rarchie Produit].CURRENTMEMBER.CHILDREN,
        [Measures].[Score Performance]
    ) * 1.1; -- Bonus 10% au niveau cat√©gorie
END SCOPE;

-- Classification automatique
CREATE MEMBER CURRENTCUBE.[Measures].[Classe Performance]
AS 
    CASE
        WHEN [Measures].[Score Performance] >= 1000 THEN "A - Excellence"
        WHEN [Measures].[Score Performance] >= 500 THEN "B - Tr√®s Bon"
        WHEN [Measures].[Score Performance] >= 200 THEN "C - Bon"
        WHEN [Measures].[Score Performance] >= 50 THEN "D - Moyen"
        ELSE "E - Faible"
    END,
VISIBLE = 1,
DISPLAY_FOLDER = "Performance";
```

### Test

1. **D√©ployer**
2. **Navigation** :
   - Lignes : `Hi√©rarchie Produit` (tous niveaux)
   - Valeurs : `Score Performance`, `Classe Performance`
3. **D√©velopper** les niveaux et observer les calculs diff√©renci√©s

---

## Partie 10 : Script 8 - Corrections et Ajustements Temporels

### Contexte M√©tier

Appliquer des corrections exceptionnelles pour des p√©riodes sp√©cifiques (retours, annulations, ajustements comptables).

### Impl√©mentation

```mdx
/* ================================================================
   SCRIPT 8 : AJUSTEMENTS ET CORRECTIONS EXCEPTIONNELS
   Modifications ponctuelles pour √©v√©nements sp√©cifiques
================================================================ */

-- Mesure CA ajust√©
CREATE MEMBER CURRENTCUBE.[Measures].[CA Ajust√©]
AS [Measures].[Chiffre d'Affaires],
FORMAT_STRING = "Currency",
VISIBLE = 1,
DISPLAY_FOLDER = "Ajustements";

-- Ajustement Janvier 2024 : Retours massifs -12%
SCOPE(
    [Measures].[CA Ajust√©],
    [Dim Temps].[Calendrier].[Mois Nom].&[Janvier],
    [Dim Temps].[Calendrier].[Annee].&[2024]
);
    THIS = [Measures].[Chiffre d'Affaires] * 0.88; -- -12% retours
END SCOPE;

-- Ajustement D√©cembre 2023 : Ventes flash +18%
SCOPE(
    [Measures].[CA Ajust√©],
    [Dim Temps].[Calendrier].[Mois Nom].&[D√©cembre],
    [Dim Temps].[Calendrier].[Annee].&[2023]
);
    THIS = [Measures].[Chiffre d'Affaires] * 1.18; -- +18% promo
END SCOPE;

-- Scope pour produits en rupture stock
-- (simulation : certains produits √âlectronique en T2 2024)
SCOPE(
    [Measures].[CA Ajust√©],
    [Dim Produit].[Hi√©rarchie Produit].[Categorie].&[√âlectronique],
    [Dim Temps].[Calendrier].[Trimestre].&[2],
    [Dim Temps].[Calendrier].[Annee].&[2024]
);
    -- Perte estim√©e 25% due √† rupture
    THIS = [Measures].[Chiffre d'Affaires] * 0.75;
END SCOPE;

-- Calcul √©cart avec/sans ajustements
CREATE MEMBER CURRENTCUBE.[Measures].[Impact Ajustements]
AS 
    [Measures].[CA Ajust√©] - [Measures].[Chiffre d'Affaires],
FORMAT_STRING = "Currency",
VISIBLE = 1,
DISPLAY_FOLDER = "Ajustements";
```

### Test

1. **D√©ployer**
2. **Navigation** :
   - Lignes : `Calendrier` ‚Üí `Mois Nom`
   - Filtre : Ann√©es 2023-2024
   - Valeurs : `CA`, `CA Ajust√©`, `Impact Ajustements`
3. **Identifier** les mois avec ajustements

---

## Partie 11 : Combinaison de Scopes Multiples

### Exemple Avanc√© : Matrice de D√©cision

```mdx
/* ================================================================
   SCRIPT 9 : MATRICE DE D√âCISION MULTI-CRIT√àRES
   Calculs crois√©s segment √ó canal √ó p√©riode
================================================================ */

CREATE MEMBER CURRENTCUBE.[Measures].[Priorit√© Commerciale]
AS 0,
FORMAT_STRING = "#,##0",
VISIBLE = 1,
DISPLAY_FOLDER = "Strat√©gie";

-- Priorit√© 1 : Clients Premium sur canaux propri√©taires
SCOPE(
    [Measures].[Priorit√© Commerciale],
    [Dim Client].[Segment].&[Premium],
    {
        [Dim Canal].[Nom Canal].&[Site Web],
        [Dim Canal].[Nom Canal].&[Application Mobile]
    }
);
    THIS = 10; -- Priorit√© maximale
END SCOPE;

-- Priorit√© 2 : Professionnels sur marketplaces
SCOPE(
    [Measures].[Priorit√© Commerciale],
    [Dim Client].[Segment].&[Professionnel],
    {
        [Dim Canal].[Nom Canal].&[Amazon Marketplace],
        [Dim Canal].[Nom Canal].&[eBay]
    }
);
    THIS = 7;
END SCOPE;

-- Priorit√© 3 : Particuliers p√©riode promotionnelle (Q4)
SCOPE(
    [Measures].[Priorit√© Commerciale],
    [Dim Client].[Segment].&[Particulier],
    [Dim Temps].[Calendrier].[Trimestre].&[4]
);
    THIS = 8;
END SCOPE;

-- Priorit√© par d√©faut
SCOPE(
    [Measures].[Priorit√© Commerciale],
    {
        [Dim Client].[Segment].&[Particulier]
    }
);
    THIS = 5; -- Priorit√© standard
END SCOPE;

-- Action recommand√©e bas√©e sur priorit√©
CREATE MEMBER CURRENTCUBE.[Measures].[Action Recommand√©e]
AS 
    CASE
        WHEN [Measures].[Priorit√© Commerciale] >= 9 THEN "Contact Direct + Offre VIP"
        WHEN [Measures].[Priorit√© Commerciale] >= 7 THEN "Email Personnalis√©"
        WHEN [Measures].[Priorit√© Commerciale] >= 5 THEN "Newsletter Standard"
        ELSE "Pas d'action"
    END,
VISIBLE = 1,
DISPLAY_FOLDER = "Strat√©gie";
```

---

## Partie 12 : Optimisation et Bonnes Pratiques

### Ordre d'Ex√©cution des Scopes

‚ö†Ô∏è **IMPORTANT** : Les scopes s'ex√©cutent **dans l'ordre** o√π ils sont √©crits.

```mdx
-- ‚ùå MAUVAIS : Le second scope √©crase le premier
SCOPE([Measures].[Prix], [Dim Produit].[Categorie].&[√âlectronique]);
    THIS = [Measures].[Prix] * 0.9;
END SCOPE;

SCOPE([Measures].[Prix], [Dim Produit].[Sous Categorie].&[Smartphones]);
    THIS = [Measures].[Prix] * 0.8; -- √âcrase le 0.9 pr√©c√©dent
END SCOPE;

-- ‚úÖ BON : Du plus g√©n√©ral au plus sp√©cifique
SCOPE([Measures].[Prix], [Dim Produit].[Categorie].&[√âlectronique]);
    THIS = [Measures].[Prix] * 0.9;
END SCOPE;

SCOPE([Measures].[Prix], [Dim Produit].[Sous Categorie].&[Smartphones]);
    THIS = THIS * 0.889; -- 0.9 * 0.889 = 0.8 (cumulatif)
END SCOPE;
```

### Performance

**Optimisations** :

```mdx
-- ‚ùå LENT : Calcul √† chaque cellule
SCOPE([Measures].[Total]);
    THIS = [Measures].[A] + [Measures].[B] + [Measures].[C];
END SCOPE;

-- ‚úÖ RAPIDE : Utiliser membres calcul√©s pour logique complexe
CREATE MEMBER [Measures].[Total] AS [Measures].[A] + [Measures].[B] + [Measures].[C];
```

### Debugging

**Technique** : Cr√©er des mesures de diagnostic

```mdx
CREATE MEMBER [Measures].[Debug Scope Active]
AS "Non",
VISIBLE = 0;

SCOPE([Measures].[Debug Scope Active], [Dim Temps].[Calendrier].[Annee].&[2024]);
    THIS = "Oui - Scope 2024 actif";
END SCOPE;
```

---

## Partie 13 : Tests et Validation

### Sc√©nario de Test Complet

1. **Test 1 : Remises Volume**

```mdx
SELECT 
    {
        [Measures].[Quantite],
        [Measures].[Prix Unitaire],
        [Measures].[Prix Unitaire Remis√©],
        [Measures].[CA Remise Volume]
    } ON COLUMNS,
    TOPCOUNT([Dim Produit].[Nom Produit].MEMBERS, 20, [Measures].[Quantite]) ON ROWS
FROM [Cube_Ventes]
```

2. **Test 2 : Budget par R√©gion**

```mdx
SELECT 
    {
        [Measures].[Chiffre d'Affaires],
        [Measures].[Budget Allou√©],
        [Measures].[Taux R√©alisation Budget]
    } ON COLUMNS,
    [Dim Client].[G√©ographie].[Region].MEMBERS ON ROWS
FROM [Cube_Ventes]
WHERE [Dim Temps].[Calendrier].[Annee].&[2024]
```

3. **Test 3 : Commissions par Canal**

```mdx
SELECT 
    {
        [Measures].[Chiffre d'Affaires],
        [Measures].[Commission],
        [Measures].[Marge Commerciale],
        [Measures].[Marge Nette Apr√®s Commission],
        [Measures].[Taux Marge Nette]
    } ON COLUMNS,
    [Dim Canal].[Nom Canal].MEMBERS ON ROWS
FROM [Cube_Ventes]
```

4. **Test 4 : Pr√©visions**

```mdx
SELECT 
    {
        [Measures].[Chiffre d'Affaires],
        [Measures].[Pr√©vision CA],
        [Measures].[√âcart Pr√©vision],
        [Measures].[Pr√©cision Pr√©vision %]
    } ON COLUMNS,
    [Dim Temps].[Calendrier].[Mois Nom].MEMBERS ON ROWS
FROM [Cube_Ventes]
WHERE [Dim Temps].[Calendrier].[Annee].&[2024]
```

---

## Partie 14 : Documentation du Script Final

### Structure Recommand√©e

```mdx
/* ================================================================
   CUBE : Cube_Ventes
   PROJET : ProjetCube_ECommerce
   DATE : 2025-01-09

   DESCRIPTION :
   Scripts de calculs complexes pour analyses commerciales avanc√©es

   SECTIONS :
   1. Remises automatiques par volume
   2. Allocation budg√©taire dynamique
   3. Calcul des commissions par canal
   4. Pr√©visions automatiques
   5. R√©partition des frais marketing
   6. Tarification diff√©renci√©e par segment
   7. Agr√©gations hi√©rarchiques personnalis√©es
   8. Ajustements exceptionnels
   9. Matrice de d√©cision strat√©gique

   AUTEUR : [Votre nom]
================================================================ */

CALCULATE;

/* SECTION 1 : REMISES VOLUME */
-- [Code section 1]

/* SECTION 2 : BUDGETS */
-- [Code section 2]

/* ... etc ... */
```

---

## Partie 15 : Cas d'Usage Avanc√©s

### Cas 1 : Simulation de Sc√©narios

```mdx
/* Param√®tre de simulation */
CREATE MEMBER [Measures].[Facteur Croissance]
AS 1.15, -- +15% de croissance
FORMAT_STRING = "Percent",
VISIBLE = 1;

CREATE MEMBER [Measures].[Simulation CA]
AS NULL,
FORMAT_STRING = "Currency";

SCOPE([Measures].[Simulation CA]);
    THIS = [Measures].[Chiffre d'Affaires] * [Measures].[Facteur Croissance];
END SCOPE;
```

### Cas 2 : D√©tection d'Anomalies

```mdx
CREATE MEMBER [Measures].[Alerte Anomalie]
AS "Normal",
VISIBLE = 1;

SCOPE(
    [Measures].[Alerte Anomalie],
    FILTER(
        [Dim Produit].[Nom Produit].MEMBERS,
        [Measures].[Taux de Marge] < 0.05 -- Marge < 5%
    )
);
    THIS = "‚ö†Ô∏è Marge Critique";
END SCOPE;

SCOPE(
    [Measures].[Alerte Anomalie],
    FILTER(
        [Dim Client].[Nom Client].MEMBERS,
        [Measures].[Croissance vs N-1 %] < -0.50 -- Baisse > 50%
    )
);
    THIS = "üî¥ Client √† Risque";
END SCOPE;
```

---

## R√©capitulatif des Scripts Cr√©√©s

| Script               | Objectif                    | Complexit√© | Impact M√©tier          |
| -------------------- | --------------------------- | ---------- | ---------------------- |
| 1. Remises Volume    | Prix d√©gressif par quantit√© | Moyenne    | Tarification dynamique |
| 2. Allocation Budget | Distribution par r√©gion     | √âlev√©e     | Planification 2025     |
| 3. Commissions Canal | Co√ªts distribution          | Moyenne    | Analyse rentabilit√©    |
| 4. Pr√©visions        | Projections 2025            | √âlev√©e     | Aide d√©cision          |
| 5. Frais Marketing   | R√©partition proportionnelle | √âlev√©e     | ROI marketing          |
| 6. Tarif Segment     | Conditions par client       | Moyenne    | Segmentation           |
| 7. Score Performance | √âvaluation hi√©rarchique     | √âlev√©e     | KPI strat√©gique        |
| 8. Ajustements       | Corrections ponctuelles     | Faible     | Fiabilit√© donn√©es      |
| 9. Matrice D√©cision  | Priorisation actions        | √âlev√©e     | Automatisation CRM     |

---

## Points de Contr√¥le

‚úÖ **9 scripts impl√©ment√©s et test√©s** ‚úÖ **Compr√©hension de l'ordre d'ex√©cution des SCOPE** ‚úÖ **Ma√Ætrise des calculs conditionnels** ‚úÖ **Optimisation des performances** ‚úÖ **Documentation compl√®te** ‚úÖ **Tests de validation r√©ussis** ‚úÖ **Cas d'usage m√©tier impl√©ment√©s**

---

## Exercices Suppl√©mentaires

### Exercice 1 : Bonus Commercial

Cr√©er un script qui calcule un bonus pour les vendeurs :

- Si CA > objectif : bonus = d√©passement √ó 5%
- Diff√©renci√© par canal

### Exercice 2 : Analyse ABC

Impl√©menter une classification ABC des produits :

- A : Top 20% du CA (80% revenu)
- B : 30% suivants
- C : 50% restants

### Exercice 3 : Pr√©vision M√©t√©o des Ventes

Cr√©er des pr√©visions int√©grant :

- Tendance historique
- Saisonnalit√©
- √âv√©nements promotionnels planifi√©s

---

## D√©pannage

| Probl√®me                 | Solution                                            |
| ------------------------ | --------------------------------------------------- |
| Scope ne s'applique pas  | V√©rifier l'ordre d'ex√©cution                        |
| Valeurs NULL inattendues | Ajouter conditions IIF                              |
| Performance d√©grad√©e     | Simplifier expressions, utiliser Non-empty behavior |
| Valeurs √©cras√©es         | R√©organiser scopes du g√©n√©ral au sp√©cifique         |
| Erreur CREATE MEMBER     | V√©rifier syntaxe et unicit√© du nom                  |


