# Atelier 2 : Membres Calculés

## KPIs et Métriques Avancées pour l'Analyse E-Commerce

---

## Prérequis

✅ Avoir complété l'Atelier 1 (Data Warehouse et Cube déployé)
✅ Cube `Cube_Ventes` fonctionnel avec toutes les dimensions

---

## Objectifs de l'Atelier

Créer des membres calculés pertinents pour l'analyse commerciale :

1. **Panier moyen** avec formatage conditionnel
2. **Taux de remise** avec visibilité restreinte
3. **Marge commerciale et taux de marge** avec code couleur
4. **CA cumulé année (YTD)** pour le suivi de la progression
5. **Comparaison année précédente** pour l'analyse d'évolution
6. **Moyenne mobile 30 jours** pour identifier les tendances

Pour chaque membre calculé, nous explorerons les propriétés avancées : formatage, visibilité, couleurs, organisation en dossiers.

---

## Partie 1 : Accéder à l'Éditeur de Calculs

1. **Ouvrir Visual Studio** et votre projet `ProjetCube_ECommerce`
2. **Double-cliquer** sur `Cube_Ventes.cube` dans le Solution Explorer
3. **Onglet Calculations** (4ème onglet)
4. **Vue** : Passer en "Form View" (icône de formulaire dans la barre d'outils)

---

## Partie 2 : Membre Calculé 1 - Panier Moyen

### Contexte Métier

Le panier moyen permet d'évaluer la valeur moyenne d'une commande. C'est un KPI clé pour mesurer l'efficacité commerciale et identifier les opportunités d'upselling.

### Création du Membre

1. **Clic droit** dans le Script Organizer → **New Calculated Member**

2. **Propriétés de base** :
   
   - **Name** : `[Panier Moyen]`
   - **Parent hierarchy** : `Measures`
   - **Parent member** : (laisser vide)

3. **Expression MDX** :

```mdx
[Measures].[Chiffre d'Affaires] / [Measures].[Nombre de Commandes]
```

4. **Format String** : `"Currency"`

5. **Additional Properties** :
   
   - **Visible** : `True`
   - **Display Folder** : `KPIs Commerciaux`
   - **Associated measure group** : `Fact Ventes`

### Configuration des Couleurs Conditionnelles

6. **Fore Color Expression** :

```mdx
CASE 
    WHEN [Measures].[Panier Moyen] >= 500 THEN RGB(0, 128, 0)     -- Vert : Excellent
    WHEN [Measures].[Panier Moyen] >= 300 THEN RGB(0, 0, 255)     -- Bleu : Bon
    WHEN [Measures].[Panier Moyen] >= 150 THEN RGB(255, 165, 0)   -- Orange : Moyen
    ELSE RGB(255, 0, 0)                                             -- Rouge : Faible
END
```

7. **Font Flags Expression** :

```mdx
CASE 
    WHEN [Measures].[Panier Moyen] >= 500 THEN 1  -- Gras (Bold)
    ELSE 0
END
```

8. **Back Color Expression** :

```mdx
CASE 
    WHEN [Measures].[Panier Moyen] >= 500 THEN RGB(230, 255, 230)  -- Vert clair
    WHEN [Measures].[Panier Moyen] < 100 THEN RGB(255, 230, 230)   -- Rouge clair
    ELSE RGB(255, 255, 255)                                          -- Blanc
END
```

### Test du Membre Calculé

9. **Déployer** : Clic droit sur le projet → Deploy
10. **Browser** : Onglet Browser
11. **Glisser** :
    - `Panier Moyen` dans les valeurs
    - `Calendrier` → `Annee` dans les lignes
    - `Type de Canal` → `Nom Canal` dans les colonnes
12. **Observer** les couleurs et le formatage

---

## Partie 3 : Membre Calculé 2 - Taux de Remise

### Contexte Métier

Le taux de remise moyen permet d'évaluer l'agressivité de la politique commerciale. Cette information peut être sensible et réservée aux managers.

### Création du Membre

1. **New Calculated Member**

2. **Propriétés** :
   
   - **Name** : `[Taux de Remise Moyen]`
   - **Parent hierarchy** : `Measures`

3. **Expression** :

```mdx
IIF(
    [Measures].[Montant Brut] = 0,
    NULL,
    [Measures].[Montant Remise] / [Measures].[Montant Brut]
)
```

4. **Format String** : `"Percent"`

5. **Additional Properties** :
   
   - **Display Folder** : `Remises et Promotions`
   - **Non-empty behavior** : `Montant Brut`

### Formatage Conditionnel

6. **Fore Color Expression** :

```mdx
CASE 
    WHEN [Measures].[Taux de Remise Moyen] > 0.20 THEN RGB(255, 0, 0)    -- Rouge : Alerte
    WHEN [Measures].[Taux de Remise Moyen] > 0.15 THEN RGB(255, 165, 0)  -- Orange : Attention
    WHEN [Measures].[Taux de Remise Moyen] > 0.10 THEN RGB(0, 0, 255)    -- Bleu : Normal
    ELSE RGB(0, 128, 0)                                                    -- Vert : Optimal
END
```

7. **Font Flags Expression** :

```mdx
CASE 
    WHEN [Measures].[Taux de Remise Moyen] > 0.20 THEN 1  -- Gras si > 20%
    ELSE 0
END
```

### Test

8. **Déployer et tester** avec différentes dimensions
9. **Analyser** le taux de remise par :
   - Catégorie de produit
   - Canal de vente
   - Période temporelle

---

## Partie 4 : Membre Calculé 3 - Marge et Taux de Marge

### Contexte Métier

La marge commerciale et le taux de marge sont essentiels pour évaluer la rentabilité des ventes.

### Marge Commerciale

1. **New Calculated Member**
2. **Name** : `[Marge Commerciale]`
3. **Expression** :

```mdx
[Measures].[Chiffre d'Affaires] - [Measures].[Cout Total]
```

4. **Format String** : `"Currency"`
5. **Display Folder** : `Rentabilité`

### Taux de Marge

6. **New Calculated Member**
7. **Name** : `[Taux de Marge]`
8. **Expression** :

```mdx
IIF(
    [Measures].[Chiffre d'Affaires] = 0,
    NULL,
    ([Measures].[Chiffre d'Affaires] - [Measures].[Cout Total]) / [Measures].[Chiffre d'Affaires]
)
```

9. **Format String** : `"Percent"`
10. **Display Folder** : `Rentabilité`

### Formatage Avancé - Taux de Marge

11. **Fore Color Expression** :

```mdx
CASE 
    WHEN [Measures].[Taux de Marge] >= 0.50 THEN RGB(0, 100, 0)    -- Vert foncé : Excellent
    WHEN [Measures].[Taux de Marge] >= 0.35 THEN RGB(0, 200, 0)    -- Vert : Très bon
    WHEN [Measures].[Taux de Marge] >= 0.20 THEN RGB(0, 0, 255)    -- Bleu : Bon
    WHEN [Measures].[Taux de Marge] >= 0.10 THEN RGB(255, 165, 0)  -- Orange : Faible
    ELSE RGB(255, 0, 0)                                              -- Rouge : Critique
END
```

12. **Back Color Expression** :

```mdx
CASE 
    WHEN [Measures].[Taux de Marge] >= 0.50 THEN RGB(240, 255, 240)
    WHEN [Measures].[Taux de Marge] < 0.10 THEN RGB(255, 240, 240)
    ELSE RGB(255, 255, 255)
END
```

### Test d'Analyse

13. **Analyser la rentabilité** :
    - Par catégorie de produit
    - Par marque
    - Par canal de vente
    - Identifier les produits à faible marge

---

## Partie 5 : Membre Calculé 4 - CA Cumulé (YTD)

### Contexte Métier

Le chiffre d'affaires cumulé depuis le début de l'année permet de suivre la progression par rapport aux objectifs annuels.

### Création

1. **New Calculated Member**

2. **Name** : `[CA YTD]`

3. **Parent hierarchy** : `Measures`

4. **Expression MDX** :

```mdx
SUM(
    YTD([Dim Temps].[Calendrier].CURRENTMEMBER),
    [Measures].[Chiffre d'Affaires]
)
```

5. **Format String** : `"Currency"`
6. **Display Folder** : `Analyses Temporelles`

### Variation Alternative - QTD (Quarter to Date)

7. **New Calculated Member**
8. **Name** : `[CA QTD]`
9. **Expression** :

```mdx
SUM(
    QTD([Dim Temps].[Calendrier].CURRENTMEMBER),
    [Measures].[Chiffre d'Affaires]
)
```

10. **Format String** : `"Currency"`
11. **Display Folder** : `Analyses Temporelles`

### Test

12. **Navigation** :
    - Glisser `CA YTD` et `Chiffre d'Affaires` dans les valeurs
    - Mettre `Calendrier` → `Mois Nom` dans les lignes
    - Filtrer sur une année spécifique
    - Observer la progression cumulative

---

## Partie 6 : Membre Calculé 5 - Comparaison Année Précédente

### Contexte Métier

Comparer les performances avec l'année précédente permet d'identifier la croissance ou les baisses de performance.

### CA Année Précédente

1. **New Calculated Member**
2. **Name** : `[CA N-1]`
3. **Expression** :

```mdx
(
    PARALLELPERIOD(
        [Dim Temps].[Calendrier].[Annee],
        1,
        [Dim Temps].[Calendrier].CURRENTMEMBER
    ),
    [Measures].[Chiffre d'Affaires]
)
```

4. **Format String** : `"Currency"`
5. **Display Folder** : `Comparaisons`

### Variation Absolue

6. **New Calculated Member**
7. **Name** : `[Variation vs N-1]`
8. **Expression** :

```mdx
[Measures].[Chiffre d'Affaires] - [Measures].[CA N-1]
```

9. **Format String** : `"Currency"`
10. **Display Folder** : `Comparaisons`

### Variation en Pourcentage

11. **New Calculated Member**
12. **Name** : `[Croissance vs N-1 %]`
13. **Expression** :

```mdx
IIF(
    [Measures].[CA N-1] = 0 OR ISEMPTY([Measures].[CA N-1]),
    NULL,
    ([Measures].[Chiffre d'Affaires] - [Measures].[CA N-1]) / [Measures].[CA N-1]
)
```

14. **Format String** : `"Percent"`
15. **Display Folder** : `Comparaisons`

### Formatage Conditionnel - Croissance

16. **Fore Color Expression** :

```mdx
CASE 
    WHEN [Measures].[Croissance vs N-1 %] > 0.10 THEN RGB(0, 128, 0)    -- Vert : Forte croissance
    WHEN [Measures].[Croissance vs N-1 %] > 0 THEN RGB(144, 238, 144)   -- Vert clair : Croissance
    WHEN [Measures].[Croissance vs N-1 %] > -0.05 THEN RGB(255, 165, 0) -- Orange : Légère baisse
    ELSE RGB(255, 0, 0)                                                   -- Rouge : Forte baisse
END
```

17. **Font Flags Expression** :

```mdx
CASE 
    WHEN ABS([Measures].[Croissance vs N-1 %]) > 0.20 THEN 1  -- Gras si variation > 20%
    ELSE 0
END
```

### Test

18. **Créer un tableau comparatif** :
    - Lignes : `Calendrier` → `Mois Nom`
    - Colonnes : Vide
    - Valeurs : `CA`, `CA N-1`, `Variation vs N-1`, `Croissance vs N-1 %`
    - Filtrer sur 2023 et 2024

---

## Partie 7 : Membre Calculé 6 - Moyenne Mobile

### Contexte Métier

La moyenne mobile lisse les variations quotidiennes pour identifier les tendances à moyen terme.

### Moyenne Mobile 30 Jours

1. **New Calculated Member**
2. **Name** : `[CA Moyenne Mobile 30J]`
3. **Expression** :

```mdx
AVG(
    LASTPERIODS(30, [Dim Temps].[Calendrier].CURRENTMEMBER),
    [Measures].[Chiffre d'Affaires]
)
```

4. **Format String** : `"Currency"`
5. **Display Folder** : `Analyses Temporelles`

### Moyenne Mobile 90 Jours

6. **New Calculated Member**
7. **Name** : `[CA Moyenne Mobile 90J]`
8. **Expression** :

```mdx
AVG(
    LASTPERIODS(90, [Dim Temps].[Calendrier].CURRENTMEMBER),
    [Measures].[Chiffre d'Affaires]
)
```

9. **Format String** : `"Currency"`
10. **Display Folder** : `Analyses Temporelles`

### Test et Visualisation

11. **Navigation recommandée** :
    - Lignes : `Date Complete` (au niveau jour)
    - Valeurs : `Chiffre d'Affaires`, `CA Moyenne Mobile 30J`, `CA Moyenne Mobile 90J`
    - Exporter vers Excel pour créer un graphique de tendance

---

## Partie 8 : Dimension Calculée - Regroupement Europe

### Contexte Métier

Créer un membre personnalisé qui agrège plusieurs pays européens pour une analyse régionale.

### Création

1. **New Calculated Member**

2. **Name** : `[Europe]`

3. **Parent hierarchy** : `Dim Client.Géographie`

4. **Parent member** : `[All]` (cliquer sur Change)

5. **Expression** :

```mdx
AGGREGATE({
    [Dim Client].[Géographie].[Pays].&[France],
    [Dim Client].[Géographie].[Pays].&[Belgique],
    [Dim Client].[Géographie].[Pays].&[Suisse]
})
```

### Amérique du Nord

6. **New Calculated Member**

7. **Name** : `[Amérique du Nord]`

8. **Parent hierarchy** : `Dim Client.Géographie`

9. **Parent member** : `[All]`

10. **Expression** :

```mdx
AGGREGATE({
    [Dim Client].[Géographie].[Pays].&[Canada]
})
```

### Test

11. **Navigation** :
    - Glisser `Chiffre d'Affaires` dans les valeurs
    - Glisser `Géographie` dans les lignes
    - Développer pour voir Europe et Amérique du Nord aux côtés des pays standards

---

## Partie 9 : Test Global et Validation

### Scénario de Test Complet

1. **Créer une analyse multi-mesures** :
   
   - Lignes : `Hiérarchie Produit` → `Categorie`
   - Colonnes : `Calendrier` → `Annee`
   - Valeurs (dans cet ordre) :
     - `Chiffre d'Affaires`
     - `Marge Commerciale`
     - `Taux de Marge`
     - `Panier Moyen`
     - `Taux de Remise Moyen`
     - `Croissance vs N-1 %`

2. **Observer** :
   
   - Le formatage des couleurs
   - Le formatage des nombres (devise, pourcentage)
   - Les valeurs en gras selon les conditions
   - L'organisation dans les dossiers

### Requête MDX de Validation

```mdx
SELECT 
    {
        [Measures].[Chiffre d'Affaires],
        [Measures].[Panier Moyen],
        [Measures].[Taux de Remise Moyen],
        [Measures].[Marge Commerciale],
        [Measures].[Taux de Marge],
        [Measures].[CA YTD],
        [Measures].[CA N-1],
        [Measures].[Variation vs N-1],
        [Measures].[Croissance vs N-1 %]
    } ON COLUMNS,
    [Dim Produit].[Hiérarchie Produit].[Categorie].MEMBERS ON ROWS
FROM [Cube_Ventes]
WHERE [Dim Temps].[Calendrier].[Annee].&[2023]
```

---

## Partie 10 : Export et Connexion Excel

### Connexion Excel au Cube

1. **Ouvrir Excel**
2. **Données** → **Obtenir des données** → **À partir d'une base de données** → **À partir d'Analysis Services**
3. **Server** : localhost (ou votre serveur)
4. **Sélectionner** : `SSAS_ECommerce` → `Cube_Ventes`
5. **Insérer un Tableau Croisé Dynamique**

### Créer un Dashboard

6. **Onglet 1 : Vue d'Ensemble**
   
   - Mesures : Tous les KPIs calculés
   - Lignes : Années
   - Observer les couleurs et formatages

7. **Onglet 2 : Analyse Produits**
   
   - Colonnes : `Taux de Marge`, `Panier Moyen`, `Croissance vs N-1 %`
   - Lignes : `Hiérarchie Produit`
   - Trier par marge décroissante

8. **Onglet 3 : Tendances**
   
   - Graphique en courbe avec :
     - `CA Moyenne Mobile 30J`
     - `CA Moyenne Mobile 90J`
     - `Chiffre d'Affaires`
   - Axe X : Dates

---

## Récapitulatif des Membres Calculés

| Membre Calculé        | Formule                       | Format   | Dossier               |
| --------------------- | ----------------------------- | -------- | --------------------- |
| Panier Moyen          | CA / Nombre Commandes         | Currency | KPIs Commerciaux      |
| Taux de Remise Moyen  | Montant Remise / Montant Brut | Percent  | Remises et Promotions |
| Marge Commerciale     | CA - Coût Total               | Currency | Rentabilité           |
| Taux de Marge         | Marge / CA                    | Percent  | Rentabilité           |
| CA YTD                | SUM(YTD(...))                 | Currency | Analyses Temporelles  |
| CA QTD                | SUM(QTD(...))                 | Currency | Analyses Temporelles  |
| CA N-1                | PARALLELPERIOD(...)           | Currency | Comparaisons          |
| Variation vs N-1      | CA - CA N-1                   | Currency | Comparaisons          |
| Croissance vs N-1 %   | (CA - CA N-1) / CA N-1        | Percent  | Comparaisons          |
| CA Moyenne Mobile 30J | AVG(LASTPERIODS(30,...))      | Currency | Analyses Temporelles  |
| CA Moyenne Mobile 90J | AVG(LASTPERIODS(90,...))      | Currency | Analyses Temporelles  |

---

## Propriétés Explorées

### Formatage

✅ **Format String** : Currency, Percent, Custom
✅ **Fore Color Expression** : Couleur de texte conditionnelle
✅ **Back Color Expression** : Couleur de fond conditionnelle
✅ **Font Flags Expression** : Gras (1), Italique (2), Souligné (4)

### Organisation

✅ **Display Folder** : Organisation logique des mesures
✅ **Associated measure group** : Groupement avec les mesures de base

### Performance

✅ **Non-empty behavior** : Optimisation des calculs
✅ **Visible** : Contrôle de la visibilité

---

## Exercices Supplémentaires

### Exercice 1 : Indicateur de Performance

Créer un membre calculé `[Performance Catégorie]` qui compare le CA de chaque catégorie au CA total :

```mdx
[Measures].[Chiffre d'Affaires] / 
([Measures].[Chiffre d'Affaires], [Dim Produit].[Hiérarchie Produit].[All])
```

### Exercice 2 : Panier Moyen par Segment

Créer un membre calculé qui affiche le panier moyen uniquement pour le segment "Premium" et NULL pour les autres.

### Exercice 3 : Objectif Mensuel

Créer un membre calculé `[Objectif Mensuel]` = CA N-1 * 1.10 et un `[Taux d'Atteinte Objectif]`.

---

## Points de Contrôle

✅ **11 membres calculés créés et fonctionnels** ✅ **Formatage conditionnel appliqué (couleurs, polices)** ✅ **Organisation en dossiers logiques** ✅ **Tests de navigation réussis** ✅ **Connexion Excel établie** ✅ **Dashboard créé avec visualisation des KPIs**


