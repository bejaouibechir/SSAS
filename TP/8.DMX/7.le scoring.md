#  DATA MINING SSAS - ATELIER COMPLET
## FICHIER 5/7 : SCORING DMX + R√âINT√âGRATION DW
### **Exploitation des mod√®les en production**

---

##   **OBJECTIF P√âDAGOGIQUE**

**Ce que vous allez apprendre :**
1. Comment interroger les mod√®les de Data Mining avec DMX
2. Comment utiliser les pr√©dictions pour prendre des d√©cisions business
3. Comment r√©int√©grer ces pr√©dictions dans votre Data Warehouse
4. Comment automatiser le processus pour la production

---

## üìñ **QU'EST-CE QUE DMX ?**

**DMX = Data Mining eXtensions**  
‚Üí C'est le **langage SQL sp√©cialis√©** pour interroger les mod√®les de Data Mining dans SSAS

**Analogie simple :**
- **SQL** ‚Üí Pour interroger des **tables** (SELECT * FROM Table)
- **DMX** ‚Üí Pour interroger des **mod√®les** (SELECT Predict() FROM Mod√®le)

**Pourquoi DMX est essentiel ?**  
C'est le **pont** entre vos mod√®les math√©matiques et vos applications m√©tier !

---

##   **PARTIE 1 : REQU√äTES DMX - SCORING BATCH**

### **1.1 Pr√©diction du Churn - Decision Tree**

```sql
SELECT 
  t.CustomerKey,
  PredictProbability([DT_Churn_Model].[HasChurned], 1) AS ChurnProbability
FROM [DT_Churn_Model]
PREDICTION JOIN ...
```

**Explication p√©dagogique :**

**Structure d'une requ√™te DMX :**
1. `SELECT` ‚Üí Ce qu'on veut r√©cup√©rer (cl√© client + pr√©diction)
2. `FROM [Nom_Mod√®le]` ‚Üí Le mod√®le de Data Mining √† interroger
3. `PREDICTION JOIN` ‚Üí Jointure avec les nouvelles donn√©es
4. `OPENQUERY()` ‚Üí R√©cup√®re les donn√©es depuis SQL Server
5. `ON` ‚Üí Conditions de jointure (features du mod√®le = features des donn√©es)

**Fonctions DMX cl√©s :**
- `PredictProbability(model.colonne, valeur)` ‚Üí Calcule la probabilit√© (ex: 0.87 = 87%)
- `Predict()` ‚Üí Pr√©diction cat√©gorielle (0 ou 1 pour churn)

**Interpr√©tation des scores :**
```sql
CASE 
  WHEN Probability >= 0.80 THEN 'Critical'   -- Rouge fonc√©
  WHEN Probability >= 0.60 THEN 'High'       -- Rouge
  WHEN Probability >= 0.40 THEN 'Medium'     -- Orange
  ELSE 'Low'                                 -- Vert
END AS RiskLevel
```

**Action business :**  
‚Üí **Critical** : Appel t√©l√©phonique imm√©diat + offre 30%  
‚Üí **High** : Email personnalis√© + 20%  
‚Üí **Medium** : Newsletter + 15%  
‚Üí **Low** : Pas d'action sp√©cifique

---

### **1.2 Top 100 Clients √† Risque - Neural Network**

```sql
SELECT TOP 100
  t.CustomerKey,
  PredictProbability([NN_Churn_Model].[HasChurned], 1) AS RiskScore,
  t.TotalSpent * 0.3 AS PotentialLoss
...
ORDER BY RiskScore DESC;
```

**Explication p√©dagogique :**

**Pourquoi TOP 100 ?**  
‚Üí Concentrer les efforts marketing sur les clients les plus pr√©cieux √† risque

**Calcul de la "valeur √† risque" :**
- `TotalSpent * 0.3` ‚Üí Si le client churne, on perd 30% de sa valeur annuelle
- Exemple : Client qui d√©pense ‚Ç¨2,450 ‚Üí Risque de perdre ‚Ç¨735/an

**Priorisation des actions :**
1. **Top 10** ‚Üí Appel direct + offre personnalis√©e 30%
2. **Top 50** ‚Üí Email VIP + 20% + livraison gratuite
3. **Top 100** ‚Üí SMS + code promo 15%

---

### **1.3 Segmentation Clients - Clustering**

```sql
SELECT 
  t.CustomerKey,
  Cluster() AS AssignedCluster,
  ClusterProbability() AS Confidence
FROM [Clustering_Model]...
```

**Explication p√©dagogique :**

**Fonctions DMX pour clustering :**
- `Cluster()` ‚Üí Retourne le cluster assign√©
- `ClusterProbability()` ‚Üí Confiance d'appartenance (0.0 √† 1.0)

**Traduction des clusters en segments m√©tier :**
```sql
CASE Cluster()
  WHEN 'Cluster 1' THEN 'VIP Fid√®les'
  WHEN 'Cluster 2' THEN 'R√©guliers Stables'
  WHEN 'Cluster 3' THEN 'Occasionnels √† Potentiel'
  WHEN 'Cluster 4' THEN 'Dormants'
  WHEN 'Cluster 5' THEN 'Nouveaux Testeurs'
  ELSE 'Non classifi√©'
END AS SegmentName
```

**Application m√©tier :**
- **VIP Fid√®les** ‚Üí Programme exclusif, avant-premi√®res
- **Dormants** ‚Üí Campagne "win-back" agressive
- **Nouveaux Testeurs** ‚Üí Offre 2√®me achat

---

### **1.4 Recommandations Produits - Association Rules**

```sql
SELECT 
  PredictAssociation([Assoc_Model].[Products], 5) AS Recommendations
FROM [Assoc_Model]
NATURAL PREDICTION JOIN ...
```

**Explication p√©dagogique :**

**Fonction DMX :** `PredictAssociation(model.colonne, N)`  
‚Üí Recommande N produits associ√©s au panier actuel

**Interpr√©tation des r√©sultats :**
```
ProductKey    $PROBABILITY  $ADJUSTEDPROBABILITY
SHOE-A001     0.68          0.43
```
- **Probability** : 68% des clients qui ach√®tent Sport Shoes ach√®tent aussi Sport Socks
- **AdjustedProbability (Lift)** : 0.43 = corr√©lation forte (si >0.5 = tr√®s fort)

**Application e-commerce :**  
‚Üí "Les clients ayant achet√© ce produit ont aussi achet√© :"  
‚Üí Recommandations en temps r√©el dans le panier

---

### **1.5 Pr√©visions Ventes - Time Series**

```sql
SELECT 
  PredictTimeSeries([TS_Model].[MonthlySales], 12) AS Forecast
FROM [TS_Model];
```

**Explication p√©dagogique :**

**Fonction DMX :** `PredictTimeSeries(colonne, N)`  
‚Üí Pr√©dit N p√©riodes futures automatiquement

**R√©sultats :**
```
$TIME    MonthlySales  Variance
202501   ‚Ç¨95,000       ‚Ç¨8,000
```
- **MonthlySales** : Pr√©vision centrale
- **Variance** : Incertitude (intervalle de confiance)

**Application m√©tier :**
- **Planification stock** : Commander 1.5√ó plus en d√©cembre
- **Marketing** : Campagnes boost en f√©vrier/ao√ªt (mois faibles)
- **Objectifs** : Fixer objectifs = pr√©vision + 10%

---

## üîÑ **PARTIE 2 : R√âINT√âGRATION DANS LE DATA WAREHOUSE**

### **2.1 Pourquoi r√©int√©grer les scores ?**

**Probl√®me :** Les scores DMX restent dans SSAS  
**Solution :** Les stocker dans le DW pour :
1. **Historisation** ‚Üí Suivre l'√©volution des scores
2. **Reporting** ‚Üí Int√©grer dans Power BI/Excel
3. **Automatisation** ‚Üí D√©clencher actions marketing

---

### **2.2 Architecture de r√©int√©gration**

```
SSAS (Mod√®les Mining)
      ‚Üì DMX Query
Temporaire (#ChurnScores)
      ‚Üì INSERT/UPDATE
DW (DimCustomer, FactRecommendations)
      ‚Üì
Applications M√©tier (CRM, Marketing, Reporting)
```

---

### **2.3 √âtapes techniques**

**√âtape 1 : Cr√©er table temporaire**
```sql
CREATE TABLE #ChurnScores (
    CustomerKey INT PRIMARY KEY,
    ChurnScore DECIMAL(5,4),      -- Ex: 0.87
    RiskLevel NVARCHAR(20),       -- 'Critical', 'High', etc.
    ScoringDate DATETIME DEFAULT GETDATE()
);
```

**√âtape 2 : Ins√©rer r√©sultats DMX**
```sql
-- M√©thode A : Via SSMS (copier-coller)
-- M√©thode B : Via SSIS (production)
-- M√©thode C : Via PowerShell/Python
```

**√âtape 3 : Mettre √† jour DimCustomer**
```sql
UPDATE DimCustomer
SET 
    ChurnScore = s.ChurnScore,
    ChurnRiskCategory = s.RiskLevel,
    ChurnPredictionDate = s.ScoringDate
FROM DimCustomer d
INNER JOIN #ChurnScores s ON d.CustomerKey = s.CustomerKey;
```

---

### **2.4 Tables cr√©√©es pour exploitation**

**1. FactRecommendations** ‚Üí Stocke les recommandations produits
```sql
CREATE TABLE FactRecommendations (
    RecommendationKey INT IDENTITY(1,1) PRIMARY KEY,
    CustomerKey INT,
    ProductKey INT,
    Probability DECIMAL(5,4),  -- Ex: 0.68
    Importance DECIMAL(5,4),   -- Ex: 0.85
    Rank INT,                  -- 1 = meilleure recommandation
    GeneratedDate DATETIME
);
```

**2. FactForecasts** ‚Üí Stocke les pr√©visions de ventes
```sql
CREATE TABLE FactForecasts (
    ForecastKey INT IDENTITY(1,1) PRIMARY KEY,
    YearMonth INT,             -- 202501
    ForecastDate DATE,         -- '2025-01-01'
    PredictedSales DECIMAL(12,2),
    LowerBound DECIMAL(12,2),  -- Pr√©diction - variance
    UpperBound DECIMAL(12,2),  -- Pr√©diction + variance
    GeneratedDate DATETIME
);
```

---

### **2.5 Vue analytique enrichie**

```sql
CREATE VIEW vw_CustomerAnalytics_Enriched AS
SELECT 
    c.CustomerKey,
    c.CustomerSegment,
    c.ChurnScore,
    c.ChurnRiskCategory,
    
    -- Action recommand√©e automatique
    CASE 
        WHEN c.ChurnScore >= 0.80 THEN 'Action Urgente'
        WHEN c.ChurnScore >= 0.60 THEN 'Campagne R√©tention'
        WHEN c.ChurnScore >= 0.40 THEN 'Suivi R√©gulier'
        ELSE 'Fid√©lisation Standard'
    END AS RecommendedAction,
    
    -- Valeur √† risque calcul√©e
    c.TotalSpent * 0.30 * c.ChurnScore AS ValueAtRisk,
    
    -- Recommandations produits
    (SELECT TOP 3 STRING_AGG(p.ProductName, ', ') 
     FROM FactRecommendations r
     JOIN DimProduct p ON r.ProductKey = p.ProductKey
     WHERE r.CustomerKey = c.CustomerKey
    ) AS TopRecommendations
FROM DimCustomer c;
```

**Utilisation :** Cette vue est la source unique pour tous les rapports et dashboards.

---

## ü§ñ **PARTIE 3 : AUTOMATISATION POUR LA PRODUCTION**

### **3.1 Pourquoi automatiser ?**

**Sc√©nario manuel :**
- Data Scientist ex√©cute DMX
- Copie-colle dans Excel
- Envoie par email
- Marketing importe dans CRM

**Probl√®mes :** Lent, sujet aux erreurs, pas scalable

**Sc√©nario automatis√© :**
- Job SQL Agent s'ex√©cute chaque nuit
- Scores calcul√©s automatiquement
- DW mis √† jour
- CRM synchronis√©
- Dashboards rafra√Æchis

---

### **3.2 Architecture d'automatisation**

```
SQL Agent Job (Quotidien 6h AM)
      ‚Üì
√âtape 1 : Ex√©cuter scoring DMX (SSIS)
      ‚Üì
√âtape 2 : Mettre √† jour DW (TSQL)
      ‚Üì
√âtape 3 : Process cube SSAS (XMLA)
      ‚Üì
Power BI Refresh
      ‚Üì
Dashboards pr√™ts √† 7h AM
```

---

### **3.3 Job SQL Agent complet**

```sql
-- Cr√©ation du job
EXEC sp_add_job 
    @job_name = 'Daily_Churn_Scoring',
    @description = 'Score clients churn et met √† jour DW quotidiennement';

-- √âtape 1 : Ex√©cution DMX via SSIS
EXEC sp_add_jobstep 
    @step_name = 'Execute DMX Scoring',
    @subsystem = 'SSIS',
    @command = '/FILE "C:\SSIS\ChurnScoring.dtsx"';

-- √âtape 2 : Mise √† jour DW
EXEC sp_add_jobstep 
    @step_name = 'Update DW with Scores',
    @subsystem = 'TSQL',
    @command = 'UPDATE DimCustomer SET ChurnScore = ...';

-- √âtape 3 : Process cube SSAS
EXEC sp_add_jobstep 
    @step_name = 'Process SSAS Dimension',
    @subsystem = 'ANALYSISCOMMAND',
    @command = '<Process>...</Process>';

-- Planification : Tous les jours √† 6h
EXEC sp_add_schedule 
    @schedule_name = 'Daily_6AM',
    @freq_type = 4,            -- Daily
    @active_start_time = 060000; -- 06:00:00
```

---

##  **VALIDATION ET MESURE DE SUCC√àS**

### **4.1 M√©triques de validation**

```sql
-- V√©rification compl√®te
SELECT 
    'Clients scor√©s' AS Metric,
    COUNT(*) AS Value
FROM DimCustomer
WHERE ChurnScore IS NOT NULL

UNION ALL

SELECT 
    'Critical Risk',
    COUNT(*)
FROM DimCustomer
WHERE ChurnRiskCategory = 'Critical'

UNION ALL

SELECT 
    'Recommandations g√©n√©r√©es',
    COUNT(*)
FROM FactRecommendations;
```

**R√©sultats attendus :**
- 100% des clients actifs scor√©s
- 5-10% en risque Critical
- 3 recommandations/client minimum

---

### **4.2 Impact business mesurable**

**Avant Data Mining :**
- Campagnes marketing "spray and pray"
- Taux de r√©ponse : 2-3%
- ROI marketing : 1.5x

**Apr√®s Data Mining :**
- Campagnes cibl√©es sur "Critical Risk"
- Taux de r√©ponse : 15-20%
- ROI marketing : 5-8x

**Calcul ROI :**
```
Co√ªt campagne : ‚Ç¨10,000
Clients sauv√©s : 100
Valeur moyenne client : ‚Ç¨500/an
ROI = (100 √ó ‚Ç¨500) / ‚Ç¨10,000 = 5x
```

---

##   **R√âSUM√â P√âDAGOGIQUE**

### **Ce que vous savez maintenant :**

1. **DMX** = Langage pour interroger les mod√®les SSAS
2. **PREDICTION JOIN** = Jointure mod√®le ‚Üî donn√©es
3. **Fonctions DMX** = Predict(), PredictProbability(), Cluster(), etc.
4. **R√©int√©gration** = Stocker scores dans DW pour exploitation
5. **Automatisation** = SQL Agent + SSIS pour production

### **Workflow complet ma√Ætris√© :**

```
Donn√©es Brutes ‚Üí Features RFMT ‚Üí Mod√®les Mining ‚Üí 
Scores DMX ‚Üí R√©int√©gration DW ‚Üí Dashboards ‚Üí Actions Business
```

### **Prochaines √©tapes :**

1. **Mettre en production** le job SQL Agent
2. **Cr√©er dashboards** Power BI avec vw_CustomerAnalytics_Enriched
3. **Mesurer ROI** apr√®s 3 mois d'exploitation
4. **It√©rer** : Am√©liorer mod√®les avec nouvelles donn√©es

---

##  **CHECKLIST DE MISE EN PRODUCTION**

```
‚òê DMX queries test√©es et valid√©es
‚òê Tables temporaires cr√©√©es (#ChurnScores)
‚òê DimCustomer enrichie avec scores
‚òê FactRecommendations/FactForecasts cr√©√©es
‚òê Vue vw_CustomerAnalytics_Enriched op√©rationnelle
‚òê Job SQL Agent configur√© et test√©
‚òê Dashboard Power BI connect√©
‚òê Process m√©tier d√©fini (qui agit sur les scores ?)
‚òê M√©triques de succ√®s d√©finies (ROI, % churn r√©duit)
‚òê Plan de maintenance (re-training mod√®les mensuel)
```

---

##  **VOUS √äTES PR√äTS POUR LA PRODUCTION !**

**Rappel :** Les 90% du travail √©taient dans la pr√©paration (features, mod√®les).  
Les 10% restants (ce fichier) transforment vos mod√®les en **valeur business concr√®te**.

**Prochain fichier :** MINING_6_Interpretation_Business.md  
‚Üí Comment pr√©senter ces r√©sultats aux d√©cideurs  
‚Üí Quelles actions concr√®tes mettre en place  
‚Üí Comment mesurer et communiquer le succ√®s