# Atelier DAX pour SSAS Tabular

# BLOC 2 : Relations et Contexte

## Comprendre RELATED vs RELATEDTABLE vs USERELATIONSHIP

### Vue d'ensemble des fonctions de relation

Avant de plonger dans les scÃ©narios, clarifions ces 3 fonctions souvent confondues :

#### ğŸ“ RELATED() - Navigation Many-to-One

**C'est quoi ?** RÃ©cupÃ¨re UNE valeur depuis une table liÃ©e (cÃ´tÃ© "one")  
**Direction :** De la table de FAITS â†’ vers la DIMENSION  
**Contexte :** Fonctionne uniquement dans un contexte de ligne  
**Retourne :** Une valeur scalaire (texte, nombre, date...)

```dax
// Dans une colonne calculÃ©e de FactInternetSales
Product Name = RELATED(DimProduct[EnglishProductName])
```

**SchÃ©ma** :

```
FactInternetSales (MANY)  â†’  DimProduct (ONE)
ProductKey: 310           â†’  ProductKey: 310
                             EnglishProductName: "Mountain-100 Silver, 38"
```

---

#### ğŸ“Š RELATEDTABLE() - Navigation One-to-Many

**C'est quoi ?** RÃ©cupÃ¨re TOUTES les lignes liÃ©es (table entiÃ¨re)  
**Direction :** De la DIMENSION â†’ vers la table de FAITS  
**Contexte :** Fonctionne uniquement dans un contexte de ligne  
**Retourne :** Une table complÃ¨te

```dax
// Dans une colonne calculÃ©e de DimProduct
Total Product Sales = SUMX(RELATEDTABLE(FactInternetSales), [SalesAmount])
```

**SchÃ©ma** :

```
DimProduct (ONE)          â†’  FactInternetSales (MANY)
ProductKey: 310           â†’  [toutes les lignes avec ProductKey=310]
                             Ligne 1: SalesAmount = 3399.99
                             Ligne 2: SalesAmount = 2443.35
                             ...
                             â†’ SUMX les agrÃ¨ge
```

---

#### ğŸ”— USERELATIONSHIP() - Activer une relation inactive

**C'est quoi ?** Active temporairement une relation inactive dans CALCULATE  
**Pourquoi ?** On ne peut avoir qu'UNE relation active entre deux tables  
**Usage :** Typiquement pour des dates multiples (OrderDate, ShipDate, DueDate)  
**Retourne :** Modifie le contexte de filtre

```dax
// Activer la relation ShipDate au lieu de OrderDate
Sales by Ship Date := 
    CALCULATE(
        SUM(FactInternetSales[SalesAmount]),
        USERELATIONSHIP(FactInternetSales[ShipDateKey], DimDate[DateKey])
    )
```

**SchÃ©ma** :

```
FactInternetSales              DimDate
â”œâ”€ OrderDateKey  â”â”â”â”â”â”â”â”â”â”â–¶  DateKey  (Relation ACTIVE)
â”œâ”€ ShipDateKey   - - - - - â–¶  DateKey  (Relation INACTIVE)
â””â”€ DueDateKey    - - - - - â–¶  DateKey  (Relation INACTIVE)

USERELATIONSHIP active temporairement une relation pointillÃ©e
```

---

### ğŸ¯ Tableau Comparatif

| Aspect            | RELATED              | RELATEDTABLE           | USERELATIONSHIP         |
| ----------------- | -------------------- | ---------------------- | ----------------------- |
| **Direction**     | Many â†’ One           | One â†’ Many             | N/A (active relation)   |
| **Retour**        | Valeur unique        | Table entiÃ¨re          | Modifie contexte        |
| **Contexte**      | Ligne uniquement     | Ligne uniquement       | Filtre (dans CALCULATE) |
| **Usage typique** | Enrichir table faits | AgrÃ©ger dans dimension | Dates multiples         |
| **Exemple**       | Product Name         | Count of Sales         | Ship Date vs Order Date |

---

## SCÃ‰NARIO 4 : Impact des Relations Actives et Inactives

### ğŸ“‹ Contexte MÃ©tier

**Persona** : Sophie, Responsable Logistique  
**Besoin** : "Je veux analyser nos ventes par date de commande ET par date de livraison pour comprendre nos dÃ©lais."

**ProblÃ¨me** : On a 3 dates dans FactInternetSales :

- OrderDate (date de commande) â† Relation ACTIVE
- ShipDate (date d'expÃ©dition) â† Relation INACTIVE
- DueDate (date prÃ©vue) â† Relation INACTIVE

**Objectif pÃ©dagogique** :

- Comprendre pourquoi on ne peut avoir qu'UNE relation active
- Utiliser USERELATIONSHIP pour activer temporairement d'autres relations
- Analyser l'impact du choix de la relation
- CrÃ©er des mesures pour chaque type de date

---

### Ã‰tape 1 : VÃ©rifier les relations existantes

#### 1.1 Dans Visual Studio - Vue Diagramme

1. Menu **ModÃ¨le** â†’ **Vue du modÃ¨le** â†’ **Vue de diagramme**
2. Localiser les relations entre **FactInternetSales** et **DimDate**

**Ce que vous devriez voir** :

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    FactInternetSales          â”‚        â”‚    DimDate      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ OrderDateKey   â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”¼â”â”â”â”â”â”â”â–¶â”‚ DateKey (PK)    â”‚ Relation ACTIVE (ligne pleine)
â”‚ ShipDateKey    â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€â”¼â”€ â”€ â”€ â–¶â”‚ DateKey         â”‚ Relation INACTIVE (pointillÃ©s)
â”‚ DueDateKey     â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€â”¼â”€ â”€ â”€ â–¶â”‚ DateKey         â”‚ Relation INACTIVE (pointillÃ©s)
â”‚ SalesAmount                   â”‚        â”‚ CalendarYear    â”‚
â”‚ CustomerKey                   â”‚        â”‚ MonthName       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 1.2 VÃ©rifier dans l'Explorateur de modÃ¨les

**Explorateur de modÃ¨les** â†’ **Relations** :

```
Relations
â”œâ”€ FactInternetSales â†’ DimDate (OrderDateKey â†’ DateKey) [ACTIVE]
â”œâ”€ FactInternetSales â†’ DimDate (ShipDateKey â†’ DateKey) [INACTIVE]
â”œâ”€ FactInternetSales â†’ DimDate (DueDateKey â†’ DateKey) [INACTIVE]
â””â”€ ...
```

**ğŸ’¡ Observation** : Une seule relation est active (en gras) !

---

### Ã‰tape 2 : Pourquoi une seule relation active ?

#### 2.1 ExpÃ©rience : Activer deux relations

**Essayons d'activer les deux relations** (juste pour voir l'erreur) :

1. Vue Diagramme â†’ Clic droit sur la relation ShipDate (pointillÃ©s)
2. **PropriÃ©tÃ©s** â†’ **Active** : Changer Ã  `True`

**âŒ ERREUR** :

```
Impossible d'activer cette relation.
Il existe dÃ©jÃ  une relation active entre FactInternetSales et DimDate.
Une seule relation active est autorisÃ©e entre deux tables.
```

**Pourquoi ?** Imaginez un filtre sur l'annÃ©e 2013 :

- Si OrderDate ET ShipDate sont actifs
- Quelle date utiliser pour filtrer ? AmbiguÃ¯tÃ© !
- Solution : UNE seule active, les autres = inactive mais utilisables via USERELATIONSHIP

---

### Ã‰tape 3 : CrÃ©er une mesure avec la relation active (OrderDate)

**ğŸ¯ Type d'objet : ğŸ“Š MESURE**

#### 3.1 Mesure de base (utilise automatiquement OrderDate)

```dax
Total Sales := SUM(FactInternetSales[SalesAmount])
```

#### 3.2 Tester dans Excel

Dans Excel (Analyser dans Excel) :

1. **Lignes** : DimDate[CalendarYear]
2. **Valeurs** : Total Sales

**RÃ©sultat** :

```
CalendarYear (OrderDate) | Total Sales
2011                     | $9,791,060.30
2012                     | $9,770,899.74
2013                     | $9,791,060.30
```

**ğŸ’¡ Par dÃ©faut** : La mesure utilise la relation ACTIVE (OrderDate) !

---

### Ã‰tape 4 : CrÃ©er une mesure avec ShipDate (relation inactive)

**ğŸ¯ Type d'objet : ğŸ“Š MESURE**

#### 4.1 Formule avec USERELATIONSHIP

```dax
Sales by Ship Date := 
    CALCULATE(
        SUM(FactInternetSales[SalesAmount]),
        USERELATIONSHIP(FactInternetSales[ShipDateKey], DimDate[DateKey])
    )
```

**DÃ©composition** :

- `CALCULATE()` : Modifie le contexte de filtre
- `SUM(...)` : Ce qu'on veut calculer
- `USERELATIONSHIP(...)` : Active temporairement la relation ShipDate
  - 1er paramÃ¨tre : Colonne FK dans la table de faits
  - 2Ã¨me paramÃ¨tre : Colonne PK dans la dimension

#### 4.2 Tester les deux mesures cÃ´te Ã  cÃ´te

```
CalendarYear | Total Sales (Order) | Sales by Ship Date
2011         | $9,791,060.30       | $9,845,234.56
2012         | $9,770,899.74       | $9,788,456.23
2013         | $9,791,060.30       | $9,725,987.01
```

**ğŸ’¡ Observation** : Les montants sont DIFFÃ‰RENTS !

**Pourquoi ?**

- Une commande de **dÃ©cembre 2011** peut Ãªtre **expÃ©diÃ©e en janvier 2012**
- DÃ©calage temporel entre commande et expÃ©dition

---

### Ã‰tape 5 : Analyser le dÃ©lai moyen entre commande et expÃ©dition

**ğŸ¯ Type d'objet : ğŸ“Š MESURE**

#### 5.1 CrÃ©er une colonne calculÃ©e pour le dÃ©lai

**Type d'objet : ğŸ“ COLONNE CALCULÃ‰E**

Dans FactInternetSales :

```dax
Shipping Delay Days = 
    DATEDIFF(
        FactInternetSales[OrderDate],
        FactInternetSales[ShipDate],
        DAY
    )
```

**Fonction DATEDIFF** :

- `DATEDIFF(date_dÃ©but, date_fin, unitÃ©)`
- UnitÃ©s : DAY, MONTH, YEAR, HOUR, MINUTE, SECOND

#### 5.2 CrÃ©er une mesure pour le dÃ©lai moyen

```dax
Average Shipping Delay := AVERAGE(FactInternetSales[Shipping Delay Days])
```

#### 5.3 RÃ©sultat

```
CalendarYear | Avg Shipping Delay
2011         | 7.2 jours
2012         | 6.8 jours
2013         | 6.5 jours
```

**ğŸ’¡ Insight** : Les dÃ©lais s'amÃ©liorent ! De 7.2 Ã  6.5 jours.

---

### Ã‰tape 6 : CrÃ©er une mesure pour DueDate

**ğŸ¯ Type d'objet : ğŸ“Š MESURE**

#### 6.1 Formule

```dax
Sales by Due Date := 
    CALCULATE(
        SUM(FactInternetSales[SalesAmount]),
        USERELATIONSHIP(FactInternetSales[DueDateKey], DimDate[DateKey])
    )
```

#### 6.2 Comparer les trois dates

```
CalendarYear | Order Date    | Ship Date     | Due Date
2011         | $9,791,060.30 | $9,845,234.56 | $9,823,456.78
2012         | $9,770,899.74 | $9,788,456.23 | $9,780,123.45
2013         | $9,791,060.30 | $9,725,987.01 | $9,758,234.89
```

**ğŸ’¡ Analyse** :

- **OrderDate** : Quand la vente est enregistrÃ©e
- **ShipDate** : Quand le produit part (souvent quelques jours aprÃ¨s)
- **DueDate** : Date promise au client (entre Order et Ship gÃ©nÃ©ralement)

---

### Ã‰tape 7 : Impact sur les analyses - Cas pratique

#### 7.1 ScÃ©nario : Analyse de saisonnalitÃ©

**Question** : Y a-t-il une diffÃ©rence de saisonnalitÃ© entre commandes et expÃ©ditions ?

**Dans Excel** :

1. **Lignes** : DimDate[MonthName]
2. **Valeurs** : Total Sales (Order) + Sales by Ship Date

**RÃ©sultat** :

```
Month      | Order Date    | Ship Date     | DiffÃ©rence
January    | $2,456,789    | $2,389,456    | -67,333  (expÃ©ditions de dÃ©c)
February   | $2,234,567    | $2,278,901    | +44,334
...
December   | $3,567,890    | $3,612,345    | +44,455  (commandes de nov)
```

**ğŸ’¡ Insight** :

- Pic de commandes en **dÃ©cembre** (fÃªtes)
- Mais beaucoup expÃ©diÃ©es en **janvier**
- Important pour la planification logistique !

#### 7.2 Pour Sophie (Responsable Logistique)

**Recommandations basÃ©es sur l'analyse** :

1. Renforcer les Ã©quipes d'expÃ©dition en **dÃ©cembre-janvier**
2. Anticiper les commandes de novembre pour livraison dÃ©cembre
3. Communiquer les dÃ©lais rallongÃ©s pendant les fÃªtes

---

### Ã‰tape 8 : DÃ©sactiver une relation - Observer l'impact

#### 8.1 Test : DÃ©sactiver la relation OrderDate

**Dans Visual Studio** :

1. Vue Diagramme
2. Clic droit sur la relation OrderDate (ligne pleine)
3. **PropriÃ©tÃ©s** â†’ **Active** : `False`
4. **Traiter le modÃ¨le**

#### 8.2 Que se passe-t-il ?

**Dans Excel, rafraÃ®chir les donnÃ©es** :

```
CalendarYear | Total Sales
2011         | (vide)
2012         | (vide)
2013         | (vide)
Total        | $29,358,677.22
```

**âŒ Plus de dÃ©tail par annÃ©e !**

**Pourquoi ?**

- Sans relation active, DimDate et FactInternetSales ne sont plus connectÃ©es
- Le filtre annÃ©e ne se propage plus
- Seul le total global est calculÃ©

#### 8.3 RÃ©activer la relation

1. Remettre OrderDate â†’ **Active** : `True`
2. Traiter le modÃ¨le
3. Tout revient Ã  la normale

**ğŸ’¡ LeÃ§on** : Les relations sont ESSENTIELLES pour la propagation des filtres !

---

### Ã‰tape 9 : Pattern avancÃ© - Tableau avec sÃ©lection de date

**ğŸ¯ Type d'objet : ğŸ“‹ TABLE CALCULÃ‰E + ğŸ“Š MESURE**

#### 9.1 CrÃ©er une table de paramÃ¨tres pour sÃ©lection de date

```dax
Date Type Selection = 
    DATATABLE(
        "Date Type", STRING,
        "Order Number", INTEGER,
        {
            {"Order Date", 1},
            {"Ship Date", 2},
            {"Due Date", 3}
        }
    )
```

**Comment crÃ©er** :

1. Menu **ModÃ¨le** â†’ **Nouvelle table calculÃ©e**
2. Coller la formule ci-dessus

**RÃ©sultat** : Une nouvelle table avec 3 lignes :

```
Date Type   | Order Number
Order Date  | 1
Ship Date   | 2
Due Date    | 3
```

#### 9.2 CrÃ©er une mesure dynamique

```dax
Sales by Selected Date := 
    VAR SelectedDateType = SELECTEDVALUE('Date Type Selection'[Order Number], 1)
    RETURN
        SWITCH(
            SelectedDateType,
            1, [Total Sales],                    -- Order Date
            2, [Sales by Ship Date],             -- Ship Date
            3, [Sales by Due Date],              -- Due Date
            BLANK()
        )
```

#### 9.3 Utilisation dans Excel

1. Ajouter un **Slicer** sur `Date Type Selection[Date Type]`
2. Utiliser la mesure `Sales by Selected Date`

**RÃ©sultat** :

- SÃ©lectionner "Order Date" â†’ Affiche les ventes par date de commande
- SÃ©lectionner "Ship Date" â†’ Affiche les ventes par date d'expÃ©dition
- **Interface interactive** pour Sophie !

---

### ğŸ“Š CONCLUSION DU SCÃ‰NARIO 4

#### Ce que vous avez appris :

âœ… **Relations actives vs inactives** : Une seule active entre deux tables  
âœ… **USERELATIONSHIP()** : Activer temporairement une relation inactive  
âœ… **Impact rÃ©el** : DiffÃ©rences dans les rÃ©sultats selon la date utilisÃ©e  
âœ… **DATEDIFF()** : Calculer des dÃ©lais entre dates  
âœ… **DÃ©sactivation** : Impact sur la propagation des filtres  
âœ… **Pattern avancÃ©** : SÃ©lection dynamique de relation via table paramÃ¨tre

#### Quand utiliser USERELATIONSHIP ?

| Situation                                   | Solution                                     |
| ------------------------------------------- | -------------------------------------------- |
| Plusieurs dates dans table faits            | USERELATIONSHIP pour dates alternatives      |
| Analyse comparative (commande vs livraison) | CrÃ©er plusieurs mesures avec USERELATIONSHIP |
| Besoin de sÃ©lection dynamique               | Table paramÃ¨tre + SWITCH                     |

#### DiffÃ©rence OrderDate vs ShipDate - Pourquoi c'est important ?

**Pour les ventes (Finance)** â†’ OrderDate (quand la vente est enregistrÃ©e)  
**Pour la logistique** â†’ ShipDate (capacitÃ© d'expÃ©dition)  
**Pour la satisfaction client** â†’ DueDate vs ShipDate (respect des dÃ©lais)

#### Prochaine Ã©tape :

â†’ ScÃ©nario 5 : Navigation multi-niveaux avec RELATED et RELATEDTABLE

---

## SCÃ‰NARIO 5 : Navigation Multi-Niveaux dans le ModÃ¨le

### ğŸ“‹ Contexte MÃ©tier

**Persona** : Thomas, Chef de Produit  
**Besoin** : "Je veux enrichir mes analyses. Pouvoir filtrer sur la couleur du produit dans mes rapports, et voir combien de ventes chaque produit a gÃ©nÃ©rÃ©."

**ProblÃ¨me** :

- Dans FactInternetSales, on n'a que ProductKey (numÃ©ro)
- Les infos produit sont dans DimProduct (nom, couleur, catÃ©gorie)
- La catÃ©gorie est dans DimProductCategory (via DimProductSubcategory)
- **ChaÃ®ne de relations** Ã  traverser !

**Objectif pÃ©dagogique** :

- Utiliser RELATED pour enrichir la table de faits
- Naviguer Ã  travers plusieurs niveaux de relations
- Utiliser RELATEDTABLE pour agrÃ©ger dans les dimensions
- Comprendre la diffÃ©rence de performance

---

### Ã‰tape 1 : Examiner le modÃ¨le relationnel

#### 1.1 SchÃ©ma du modÃ¨le produit

```
FactInternetSales (60K lignes)
       â†“ ProductKey
DimProduct (606 produits)
       â†“ ProductSubcategoryKey
DimProductSubcategory (37 sous-catÃ©gories)
       â†“ ProductCategoryKey
DimProductCategory (4 catÃ©gories)
```

**Relations en cascade** :

```
FactInternetSales[ProductKey] â†’ DimProduct[ProductKey]
DimProduct[ProductSubcategoryKey] â†’ DimProductSubcategory[ProductSubcategoryKey]
DimProductSubcategory[ProductCategoryKey] â†’ DimProductCategory[ProductCategoryKey]
```

#### 1.2 Visualiser dans la vue Diagramme

**Ce que vous voyez** :

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚FactInternetSalesâ”‚â”â”â–¶â”‚ DimProduct   â”‚â”â”â–¶â”‚DimProductSubcategoryâ”‚â”â”â–¶â”‚DimProductCategoryâ”‚
â”‚ ProductKey      â”‚   â”‚ ProductKey   â”‚   â”‚ProductSubcategoryKeyâ”‚   â”‚ProductCategoryKeyâ”‚
â”‚ SalesAmount     â”‚   â”‚ ProductName  â”‚   â”‚ SubcategoryName     â”‚   â”‚ CategoryName     â”‚
â”‚ OrderQuantity   â”‚   â”‚ Color        â”‚   â”‚                     â”‚   â”‚                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ StandardCost â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### Ã‰tape 2 : Enrichir FactInternetSales avec RELATED

**ğŸ¯ Type d'objet : ğŸ“ COLONNE CALCULÃ‰E**

#### 2.1 Ajouter le nom du produit

Dans la table **FactInternetSales**, crÃ©er une colonne calculÃ©e :

```dax
Product Name = RELATED(DimProduct[EnglishProductName])
```

**OÃ¹ crÃ©er** :

1. Vue Grille â†’ FactInternetSales
2. Cliquer sur la premiÃ¨re colonne vide
3. Dans la barre de formule, taper la formule
4. EntrÃ©e

**RÃ©sultat** : Une nouvelle colonne apparaÃ®t :

```
SalesOrderNumber | ProductKey | Product Name
SO43659          | 310        | Mountain-100 Silver, 38
SO43659          | 322        | Road-250 Red, 48
SO43660          | 311        | Mountain-100 Black, 38
```

**ğŸ’¡ Magie de RELATED** : Traverse automatiquement la relation !

#### 2.2 Ajouter la couleur du produit

```dax
Product Color = RELATED(DimProduct[Color])
```

**RÃ©sultat** :

```
SalesOrderNumber | Product Name              | Product Color
SO43659          | Mountain-100 Silver, 38   | Silver
SO43659          | Road-250 Red, 48          | Red
SO43660          | Mountain-100 Black, 38    | Black
```

---

### Ã‰tape 3 : Navigation multi-niveaux - Aller chercher la catÃ©gorie

**ğŸ¯ Type d'objet : ğŸ“ COLONNE CALCULÃ‰E**

#### 3.1 Ajouter la catÃ©gorie (2 niveaux de relations)

```dax
Product Category = RELATED(DimProductCategory[EnglishProductCategoryName])
```

**Comment Ã§a marche ?**

**DAX traverse automatiquement** :

```
FactInternetSales
    â†’ DimProduct (via ProductKey)
        â†’ DimProductSubcategory (via ProductSubcategoryKey)
            â†’ DimProductCategory (via ProductCategoryKey)
                â†’ RÃ©cupÃ¨re EnglishProductCategoryName
```

**RÃ©sultat** :

```
Product Name              | Product Color | Product Category
Mountain-100 Silver, 38   | Silver        | Bikes
Road-250 Red, 48          | Red           | Bikes
Sport-100 Helmet, Blue    | Blue          | Accessories
```

**ğŸ’¡ Avantage** : Pas besoin de spÃ©cifier chaque Ã©tape, DAX suit le chemin !

#### 3.2 Ajouter la sous-catÃ©gorie

```dax
Product Subcategory = RELATED(DimProductSubcategory[EnglishProductSubcategoryName])
```

**RÃ©sultat complet** :

```
Product Name              | Category    | Subcategory      | Color
Mountain-100 Silver, 38   | Bikes       | Mountain Bikes   | Silver
Road-250 Red, 48          | Bikes       | Road Bikes       | Red
Sport-100 Helmet, Blue    | Accessories | Helmets          | Blue
```

---

### Ã‰tape 4 : Utilisation pratique - Filtrer par couleur

#### 4.1 Dans Excel - Ajouter un slicer sur la couleur

1. Analyser dans Excel
2. CrÃ©er un **Slicer** sur `FactInternetSales[Product Color]`
3. Tableau croisÃ© :
   - **Lignes** : Product Category
   - **Valeurs** : Total Sales

#### 4.2 Tester le filtre

**Sans filtre** :

```
Category     | Total Sales
Bikes        | $28,318,144.65
Clothing     | $339,772.61
Accessories  | $700,759.96
```

**Filtrer sur "Red"** :

```
Category     | Total Sales (Red only)
Bikes        | $6,234,567.89
Clothing     | $89,123.45
Accessories  | $0.00
```

**ğŸ’¡ Pour Thomas** : Il peut maintenant analyser les ventes par couleur de produit !

---

### Ã‰tape 5 : RELATEDTABLE pour agrÃ©ger dans les dimensions

**ğŸ¯ Type d'objet : ğŸ“ COLONNE CALCULÃ‰E** (dans DimProduct)

#### 5.1 Compter les ventes par produit

Dans la table **DimProduct**, crÃ©er :

```dax
Sales Count = COUNTROWS(RELATEDTABLE(FactInternetSales))
```

**Ce que fait RELATEDTABLE** :

1. Pour chaque ligne de DimProduct (contexte de ligne)
2. Va chercher TOUTES les lignes de FactInternetSales avec le mÃªme ProductKey
3. COUNTROWS compte ces lignes

**RÃ©sultat** :

```
ProductKey | EnglishProductName        | Sales Count
310        | Mountain-100 Silver, 38   | 236
311        | Mountain-100 Black, 38    | 198
312        | Mountain-100 Black, 42    | 174
...
480        | Touring-1000 Blue, 60     | 0       â† Jamais vendu !
```

**ğŸ’¡ Insight** : On peut identifier les produits jamais vendus !

#### 5.2 Total des ventes par produit

```dax
Total Product Sales = 
    SUMX(
        RELATEDTABLE(FactInternetSales),
        FactInternetSales[SalesAmount]
    )
```

**RÃ©sultat** :

```
EnglishProductName        | Sales Count | Total Product Sales
Mountain-100 Silver, 38   | 236         | $789,234.56
Mountain-100 Black, 38    | 198         | $658,901.23
Road-250 Red, 48          | 87          | $289,456.78
```

---

### Ã‰tape 6 : Comparer RELATED vs RELATEDTABLE vs Mesure

**CrÃ©ons 3 faÃ§ons de calculer le total des ventes** :

#### 6.1 MÃ©thode 1 : Colonne calculÃ©e avec RELATEDTABLE (dans DimProduct)

```dax
Total Sales Column = 
    SUMX(
        RELATEDTABLE(FactInternetSales),
        FactInternetSales[SalesAmount]
    )
```

**Avantages** :

- âœ… StockÃ©, pas recalculÃ©
- âœ… Peut Ãªtre utilisÃ© dans un slicer

**InconvÃ©nients** :

- âŒ Consomme de la mÃ©moire
- âŒ Doit Ãªtre recalculÃ© lors du traitement
- âŒ Ne s'adapte pas au contexte de filtre

#### 6.2 MÃ©thode 2 : Mesure simple (recommandÃ©e)

```dax
Total Sales := SUM(FactInternetSales[SalesAmount])
```

**Avantages** :

- âœ… Pas de stockage
- âœ… S'adapte au contexte de filtre
- âœ… Performance optimale

**InconvÃ©nients** :

- âŒ Ne peut pas Ãªtre dans un slicer

#### 6.3 Test de performance

**Utiliser DAX Studio** :

```
MÃ©thode                        | MÃ©moire  | Temps calcul
Colonne RELATEDTABLE           | 245 KB   | -  (prÃ©-calculÃ©)
Mesure SUM                     | 0 KB     | 12 ms
```

**ğŸ’¡ Recommandation de Thomas** :

- Pour **analyse** : Utiliser MESURE
- Pour **catÃ©gorisation/filtre** : Utiliser COLONNE CALCULÃ‰E

---

### Ã‰tape 7 : Pattern avancÃ© - HiÃ©rarchie produit complÃ¨te

**ğŸ¯ Type d'objet : ğŸ”— HIÃ‰RARCHIE**

#### 7.1 CrÃ©er la hiÃ©rarchie dans DimProductCategory

1. Vue Grille â†’ DimProductCategory
2. Clic droit sur **EnglishProductCategoryName**
3. **CrÃ©er une hiÃ©rarchie** â†’ Nommer "Product Hierarchy"

#### 7.2 Ajouter les niveaux

Dans l'Explorateur de modÃ¨les :

1. Glisser **DimProductSubcategory[EnglishProductSubcategoryName]** dans la hiÃ©rarchie
2. Glisser **DimProduct[EnglishProductName]** dans la hiÃ©rarchie

**Structure** :

```
ğŸ“¦ Product Hierarchy
  â”œâ”€ Category (ex: Bikes)
  â”œâ”€ Subcategory (ex: Mountain Bikes)
  â””â”€ Product (ex: Mountain-100 Silver, 38)
```

#### 7.3 Tester le drill-down

Dans Excel :

1. **Lignes** : Product Hierarchy
2. **Valeurs** : Total Sales

**RÃ©sultat** :

```
+ Bikes                    $28,318,144.65
+ Accessories             $700,759.96
+ Clothing                $339,772.61

DÃ©velopper "Bikes" :
  + Mountain Bikes        $9,952,759.56
  + Road Bikes            $14,520,584.04
  + Touring Bikes         $3,844,801.05

DÃ©velopper "Mountain Bikes" :
    Mountain-100 Silver   $1,912,674.27
    Mountain-200 Black    $2,032,179.99
    ...
```

**ğŸ’¡ Navigation intuitive** pour Thomas !

---

### Ã‰tape 8 : Cas d'usage rÃ©el - Produits sans ventes

#### 8.1 Identifier les produits jamais vendus

**Utiliser la colonne Sales Count crÃ©Ã©e prÃ©cÃ©demment** :

Dans Excel :

1. **Lignes** : DimProduct[EnglishProductName]
2. **Valeurs** : Sales Count
3. **Filtrer** : Sales Count = 0

**RÃ©sultat** :

```
ProductName                    | Sales Count
Touring-1000 Blue, 60          | 0
Classic Vest, M                | 0
Half-Finger Gloves, L          | 0
...                            | 0
Total: 214 produits            | 0
```

**ğŸ’¡ Insight** : 214 produits sur 606 n'ont JAMAIS Ã©tÃ© vendus !

#### 8.2 CrÃ©er une catÃ©gorie "Statut Vente"

**Type d'objet : ğŸ“ COLONNE CALCULÃ‰E** (dans DimProduct)

```dax
Sales Status = 
    VAR SalesCount = COUNTROWS(RELATEDTABLE(FactInternetSales))
    RETURN
        SWITCH(
            TRUE(),
            SalesCount = 0, "Never Sold",
            SalesCount < 50, "Low Sales",
            SalesCount < 150, "Medium Sales",
            "High Sales"
        )
```

**RÃ©sultat** :

```
ProductName                 | Sales Count | Sales Status
Mountain-100 Silver, 38     | 236         | High Sales
Road-250 Red, 48            | 87          | Medium Sales
Sport-100 Helmet, Blue      | 23          | Low Sales
Touring-1000 Blue, 60       | 0           | Never Sold
```

#### 8.3 Dashboard pour Thomas

**Dans Excel - Tableau croisÃ©** :

```
Sales Status  | Count of Products | Total Sales
High Sales    | 158              | $22,456,789.12
Medium Sales  | 176              | $5,234,567.89
Low Sales     | 58               | $1,667,320.67
Never Sold    | 214              | $0.00
```

**Recommandations** :

- ğŸ“Š **High Sales** : Maintenir en stock
- âš ï¸ **Medium Sales** : Surveiller
- ğŸ”» **Low Sales** : ConsidÃ©rer promotion
- âŒ **Never Sold** : Retirer du catalogue ?

---

### ğŸ“Š CONCLUSION DU SCÃ‰NARIO 5

#### Ce que vous avez appris :

âœ… **RELATED()** : Enrichir table faits avec infos dimensions  
âœ… **Navigation multi-niveaux** : DAX traverse automatiquement les relations  
âœ… **RELATEDTABLE()** : AgrÃ©ger depuis dimension vers faits  
âœ… **COUNTROWS + RELATEDTABLE** : Compter les occurrences liÃ©es  
âœ… **HiÃ©rarchie produit** : Navigation drill-down intuitive  
âœ… **Pattern d'analyse** : Identifier produits sous-performants

#### RELATED vs RELATEDTABLE - Quand utiliser ?

| Besoin                     | Fonction     | Direction  | Exemple                    |
| -------------------------- | ------------ | ---------- | -------------------------- |
| Ajouter une info dimension | RELATED      | Many â†’ One | Nom produit dans FactSales |
| AgrÃ©ger les faits          | RELATEDTABLE | One â†’ Many | Total ventes par produit   |
| Navigation multi-niveaux   | RELATED      | Many â†’ One | CatÃ©gorie dans FactSales   |

#### Performance - Colonne vs Mesure

**Colonne calculÃ©e avec RELATEDTABLE** :

- âœ… Quand : Besoin dans slicer/filtre
- âŒ Ã‰viter : Si juste pour agrÃ©gation

**Mesure** :

- âœ… Toujours prÃ©fÃ©rable pour agrÃ©gations
- âœ… Pas de stockage, meilleure performance

#### Prochaine Ã©tape :

â†’ ScÃ©nario 6 : Cas avancÃ© avec USERELATIONSHIP et analyses comparatives

---

## SCÃ‰NARIO 6 : Analyse Comparative Multi-Dates (Cas AvancÃ©)

### ğŸ“‹ Contexte MÃ©tier

**Persona** : Isabelle, Directrice des OpÃ©rations  
**Besoin** : "Je veux un dashboard qui me montre SIMULTANÃ‰MENT :

- Les ventes par date de commande
- Les ventes par date d'expÃ©dition
- Les ventes par date attendue
  Et pouvoir comparer pour optimiser notre logistique."

**DÃ©fi** : Comment afficher 3 perspectives de dates dans le MÃŠME rapport ?

**Objectif pÃ©dagogique** :

- CrÃ©er plusieurs mesures avec USERELATIONSHIP
- Construire un tableau comparatif complet
- Analyser les Ã©carts et leur signification mÃ©tier
- Pattern : Table de paramÃ¨tres pour sÃ©lection dynamique

---

### Ã‰tape 1 : CrÃ©er les trois mesures de base

**ğŸ¯ Type d'objet : ğŸ“Š MESURE (Ã—3)**

#### 1.1 Mesure 1 - Ventes par date de commande (relation active)

```dax
Sales by Order Date := SUM(FactInternetSales[SalesAmount])
```

**Note** : Utilise automatiquement la relation active (OrderDateKey â†’ DateKey)

#### 1.2 Mesure 2 - Ventes par date d'expÃ©dition

```dax
Sales by Ship Date := 
    CALCULATE(
        SUM(FactInternetSales[SalesAmount]),
        USERELATIONSHIP(FactInternetSales[ShipDateKey], DimDate[DateKey])
    )
```

#### 1.3 Mesure 3 - Ventes par date attendue

```dax
Sales by Due Date := 
    CALCULATE(
        SUM(FactInternetSales[SalesAmount]),
        USERELATIONSHIP(FactInternetSales[DueDateKey], DimDate[DateKey])
    )
```

---

### Ã‰tape 2 : CrÃ©er un tableau comparatif mensuel

#### 2.1 Dans Excel

**Configuration du TCD** :

- **Lignes** : DimDate[CalendarYear] + DimDate[MonthName]
- **Valeurs** :
  - Sales by Order Date
  - Sales by Ship Date
  - Sales by Due Date

#### 2.2 RÃ©sultat

```
Month        | Order Date    | Ship Date     | Due Date      | Ã‰cart Order-Ship
Jan 2013     | $802,145.23   | $745,234.89   | $778,456.12   | -$56,910.34
Feb 2013     | $765,234.56   | $798,901.23   | $782,345.67   | +$33,666.67
Mar 2013     | $812,456.78   | $823,789.45   | $818,123.01   | +$11,332.67
Apr 2013     | $789,123.45   | $801,234.56   | $795,678.90   | +$12,111.11
...
Dec 2013     | $1,123,456.78 | $1,089,234.56 | $1,106,345.67 | -$34,222.22
```

**ğŸ’¡ Observation** :

- **Janvier** : Ship Date < Order Date â†’ ExpÃ©ditions de commandes de dÃ©cembre
- **FÃ©vrier-Novembre** : Ship Date > Order Date â†’ DÃ©calage normal
- **DÃ©cembre** : Ship Date < Order Date â†’ Beaucoup sera expÃ©diÃ© en janvier

---

### Ã‰tape 3 : CrÃ©er des mesures d'Ã©cart

**ğŸ¯ Type d'objet : ğŸ“Š MESURE**

#### 3.1 Ã‰cart entre commande et expÃ©dition

```dax
Variance Order vs Ship := 
    [Sales by Ship Date] - [Sales by Order Date]
```

#### 3.2 Ã‰cart entre commande et date attendue

```dax
Variance Order vs Due := 
    [Sales by Due Date] - [Sales by Order Date]
```

#### 3.3 Pourcentage de variance

```dax
Variance % Order vs Ship := 
    DIVIDE(
        [Variance Order vs Ship],
        [Sales by Order Date]
    ) * 100
```

---

### Ã‰tape 4 : Analyse des retards de livraison

**ğŸ¯ Type d'objet : ğŸ“ COLONNE CALCULÃ‰E**

#### 4.1 CrÃ©er un indicateur de retard

Dans FactInternetSales :

```dax
Is Late Delivery = 
    IF(
        FactInternetSales[ShipDate] > FactInternetSales[DueDate],
        "Late",
        "On Time"
    )
```

#### 4.2 Calculer les jours de retard

```dax
Days Late = 
    IF(
        FactInternetSales[ShipDate] > FactInternetSales[DueDate],
        DATEDIFF(
            FactInternetSales[DueDate],
            FactInternetSales[ShipDate],
            DAY
        ),
        0
    )
```

#### 4.3 Mesure : Taux de livraison Ã  temps

**Type d'objet : ğŸ“Š MESURE**

```dax
On-Time Delivery Rate := 
    DIVIDE(
        CALCULATE(
            COUNTROWS(FactInternetSales),
            FactInternetSales[Is Late Delivery] = "On Time"
        ),
        COUNTROWS(FactInternetSales)
    ) * 100
```

**RÃ©sultat par mois** :

```
Month        | On-Time Rate | Avg Days Late
Jan 2013     | 94.5%       | 1.2
Feb 2013     | 96.2%       | 0.8
...
Nov 2013     | 97.1%       | 0.6
Dec 2013     | 89.3%       | 2.4  â† PÃ©riode critique !
```

**ğŸ’¡ Insight** : DÃ©cembre a le pire taux de livraison Ã  temps !

---

### Ã‰tape 5 : Pattern avancÃ© - SÃ©lecteur de perspective de date

**ğŸ¯ Type d'objet : ğŸ“‹ TABLE CALCULÃ‰E + ğŸ“Š MESURE DYNAMIQUE**

#### 5.1 CrÃ©er une table de sÃ©lection de dates

```dax
Date Perspective = 
    DATATABLE(
        "Perspective", STRING,
        "Sort Order", INTEGER,
        {
            {"Order Date", 1},
            {"Ship Date", 2},
            {"Due Date", 3}
        }
    )
```

#### 5.2 CrÃ©er une mesure dynamique qui s'adapte

```dax
Sales by Selected Perspective := 
    VAR SelectedPerspective = SELECTEDVALUE('Date Perspective'[Perspective], "Order Date")
    RETURN
        SWITCH(
            SelectedPerspective,
            "Order Date", [Sales by Order Date],
            "Ship Date", [Sales by Ship Date],
            "Due Date", [Sales by Due Date],
            BLANK()
        )
```

#### 5.3 Utilisation dans Excel

**Configuration** :

1. Ajouter un **Slicer** sur `Date Perspective[Perspective]`
2. **Lignes** : DimDate[MonthName]
3. **Valeurs** : Sales by Selected Perspective

**Interaction** :

- SÃ©lectionner "Order Date" â†’ Voir les ventes par date de commande
- SÃ©lectionner "Ship Date" â†’ Voir les ventes par date d'expÃ©dition
- **Un seul clic** pour changer de perspective !

**ğŸ’¡ Pour Isabelle** : Interface simple pour basculer entre vues !

---

### Ã‰tape 6 : Dashboard complet pour Isabelle

#### 6.1 Structure du dashboard

**Section 1 : Vue d'ensemble**

```
MÃ©thode KPI Cards :
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Order Date      â”‚ â”‚ Ship Date       â”‚ â”‚ On-Time Rate    â”‚
â”‚ $29.3M          â”‚ â”‚ $29.2M          â”‚ â”‚ 94.2%           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Section 2 : Tendance mensuelle**

```
Graphique en lignes :
- Ligne 1 : Sales by Order Date (bleu)
- Ligne 2 : Sales by Ship Date (vert)
- Ligne 3 : Sales by Due Date (orange)
```

**Section 3 : Analyse des retards**

```
Tableau :
Month    | On-Time Rate | Avg Days Late | Late Orders Count
Jan      | 94.5%        | 1.2          | 1,234
Feb      | 96.2%        | 0.8          | 856
...
Dec      | 89.3%        | 2.4          | 2,567  â† Alerte !
```

**Section 4 : Distribution des retards**

```
Histogramme :
Days Late | Count of Orders
0         | â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 54,234
1         | â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 3,456
2         | â–ˆâ–ˆâ–ˆ 1,234
3         | â–ˆâ–ˆ 789
4+        | â–ˆ 685
```

---

### Ã‰tape 7 : Analyse approfondie - Impact financier des retards

**ğŸ¯ Type d'objet : ğŸ“Š MESURE**

#### 7.1 Calculer le coÃ»t estimÃ© des retards

HypothÃ¨se : Chaque jour de retard coÃ»te 50$ en geste commercial

```dax
Estimated Late Delivery Cost := 
    SUMX(
        FactInternetSales,
        IF(
            FactInternetSales[Days Late] > 0,
            FactInternetSales[Days Late] * 50,
            0
        )
    )
```

**RÃ©sultat annuel 2013** :

```
Month    | Late Orders | Estimated Cost
Jan      | 1,234       | $74,040
Feb      | 856         | $34,240
...
Dec      | 2,567       | $307,020  â† Pic de coÃ»t !
Total    | 15,234      | $912,040
```

**ğŸ’¡ Impact financier** : Presque 1M$ de coÃ»ts liÃ©s aux retards !

#### 7.2 Identifier les produits problÃ©matiques

```dax
Average Days Late by Product := 
    AVERAGEX(
        FILTER(
            FactInternetSales,
            FactInternetSales[Days Late] > 0
        ),
        FactInternetSales[Days Late]
    )
```

**Top 5 produits avec retards** :

```
Product                    | Avg Days Late | Count Late Orders
Touring-3000 Blue, 62      | 4.2          | 234
Mountain-500 Silver, 48    | 3.8          | 189
Road-750 Black, 44         | 3.5          | 156
...
```

**Recommandations pour Isabelle** :

1. Augmenter stock pour Touring-3000
2. Revoir la chaÃ®ne d'approvisionnement Mountain-500
3. Renforcer Ã©quipes logistiques en dÃ©cembre

---

### ğŸ“Š CONCLUSION DU SCÃ‰NARIO 6

#### Ce que vous avez appris :

âœ… **Plusieurs USERELATIONSHIP** : CrÃ©er plusieurs perspectives de dates  
âœ… **Mesures d'Ã©cart** : Comparer diffÃ©rentes perspectives  
âœ… **Indicateurs de performance** : Taux de livraison Ã  temps  
âœ… **DATEDIFF** : Calculer retards et dÃ©lais  
âœ… **Table de paramÃ¨tres** : SÃ©lection dynamique de perspective  
âœ… **Impact financier** : Quantifier le coÃ»t des retards  
âœ… **Dashboard complet** : Vue Ã  360Â° pour la direction

#### Pattern : Analyse multi-perspectives de dates

```
Pour chaque perspective temporelle :
1. CrÃ©er une mesure avec USERELATIONSHIP (si inactive)
2. CrÃ©er des mesures d'Ã©cart entre perspectives
3. CrÃ©er une table paramÃ¨tre pour sÃ©lection dynamique
4. Construire un dashboard comparatif
```

#### Quand utiliser ce pattern ?

| Situation     | Perspectives Ã  analyser                       |
| ------------- | --------------------------------------------- |
| E-commerce    | Order, Payment, Ship, Delivery                |
| Manufacturing | Order, Production Start, Production End, Ship |
| Services      | Request, Scheduled, Started, Completed        |
| Finance       | Transaction, Settlement, Reconciliation       |

#### Impact mÃ©tier de l'analyse

**Pour Isabelle** :

- âœ… VisibilitÃ© complÃ¨te sur la chaÃ®ne logistique
- âœ… Identification des pÃ©riodes critiques (dÃ©cembre)
- âœ… Quantification de l'impact financier ($912K/an)
- âœ… Produits problÃ©matiques identifiÃ©s
- âœ… Base pour amÃ©lioration continue

---

### ğŸ“‹ RÃ‰CAPITULATIF BLOC 2 : Relations

#### Fonctions maÃ®trisÃ©es :

| Fonction            | Usage                          | Exemple                   |
| ------------------- | ------------------------------ | ------------------------- |
| **RELATED**         | Enrichir faits avec dimensions | Product Name, Category    |
| **RELATEDTABLE**    | AgrÃ©ger faits dans dimension   | Sales Count, Total Sales  |
| **USERELATIONSHIP** | Activer relation inactive      | Ship Date, Due Date       |
| **DATEDIFF**        | Calculer dÃ©lais                | Shipping Delay, Days Late |

#### Patterns appris :

1. **Enrichissement** : RELATED pour ajouter colonnes
2. **AgrÃ©gation inversÃ©e** : RELATEDTABLE + SUMX
3. **Multi-perspectives** : USERELATIONSHIP + SWITCH
4. **HiÃ©rarchies** : Drill-down intuitif
5. **Analyse de performance** : Taux, dÃ©lais, coÃ»ts
