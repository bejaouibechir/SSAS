# Atelier DAX pour SSAS Tabular

## Table des mati√®res

### BLOC 1 : Fondamentaux avec Sc√©narios (Semaine 1-2)

1. [Comprendre les Types d'Objets DAX](#bloc-1-types-objets)
2. [Sc√©nario 1 : Analyse des Ventes par Dimensions](#scenario-1)
3. [Sc√©nario 2 : Calculs de Marges et Rentabilit√©](#scenario-2)
4. [Sc√©nario 3 : Comparaison SUM vs SUMX](#scenario-3)

### BLOC 2 : Relations et Contexte (Semaine 3-4)

5. [Comprendre RELATED vs RELATEDTABLE](#bloc-2-related)
6. [Sc√©nario 4 : Impact des Relations Actives/Inactives](#scenario-4)
7. [Sc√©nario 5 : Navigation Multi-Niveaux](#scenario-5)
8. [Sc√©nario 6 : USERELATIONSHIP pour Dates Multiples](#scenario-6)

### BLOC 3 : Time Intelligence Pratique (Semaine 5-6)

9. [Sc√©nario 7 : Dashboard Comparatif Temporel](#scenario-7)
10. [Sc√©nario 8 : Analyse de Tendances YTD/QTD](#scenario-8)
11. [Sc√©nario 9 : Croissance et Variations](#scenario-9)

### BLOC 4 : Tables Calcul√©es et Mod√©lisation (Semaine 7)

12. [Sc√©nario 10 : Table de Segmentation Client](#scenario-10)
13. [Sc√©nario 11 : Table de Dates Personnalis√©e](#scenario-11)
14. [Sc√©nario 12 : Table d'Analyse ABC](#scenario-12)

### BLOC 5 : Cas M√©tier Avanc√©s (Semaine 8+)

15. [Sc√©nario 13 : Dashboard Complet du Directeur Commercial](#scenario-13)
16. [Sc√©nario 14 : Analyse de R√©tention Client](#scenario-14)
17. [Sc√©nario 15 : Optimisation de Performance](#scenario-15)

---

# BLOC 1 : Fondamentaux avec Sc√©narios

## 1. Comprendre les Types d'Objets DAX

### Les 4 Types d'Objets DAX

Avant de commencer, **identifions clairement** les 4 types d'objets que vous pouvez cr√©er en DAX :

#### üìä Type 1 : MESURE (Measure)

**C'est quoi ?** Un calcul dynamique qui s'adapte au contexte de filtre  
**Quand l'utiliser ?** Pour les agr√©gations et calculs dans les rapports  
**Stockage ?** ‚ùå Non stock√©e (calcul√©e √† la demande)  
**Symbole DAX :** `:=`

```dax
Total Sales := SUM(FactInternetSales[SalesAmount])
```

**O√π la cr√©er dans SSDT ?**

1. Vue Grille de donn√©es ‚Üí Table FactInternetSales
2. En bas : Grille de mesures ‚Üí Clic dans une cellule vide
3. Taper la formule
4. Appuyer sur Entr√©e

**Ic√¥ne dans l'Explorateur** : üìä avec symbole calculatrice

---

#### üìè Type 2 : COLONNE CALCUL√âE (Calculated Column)

**C'est quoi ?** Une nouvelle colonne dans une table, calcul√©e ligne par ligne  
**Quand l'utiliser ?** Pour enrichir les donn√©es, cr√©er des cat√©gories, utiliser dans slicers  
**Stockage ?** ‚úÖ Stock√©e en m√©moire (consomme de la RAM)  
**Symbole DAX :** `=`

```dax
Profit = FactInternetSales[SalesAmount] - FactInternetSales[TotalProductCost]
```

**O√π la cr√©er dans SSDT ?**

1. Vue Grille de donn√©es ‚Üí Table FactInternetSales
2. Clic sur la premi√®re colonne vide (apr√®s la derni√®re colonne)
3. Dans la barre de formule en haut, taper : `Profit = [SalesAmount] - [TotalProductCost]`
4. Appuyer sur Entr√©e

**Ic√¥ne dans l'Explorateur** : Colonne normale avec symbole fx

---

#### üìã Type 3 : TABLE CALCUL√âE (Calculated Table)

**C'est quoi ?** Une nouvelle table enti√®re cr√©√©e par une formule DAX  
**Quand l'utiliser ?** Pour segmentation, tables de param√®tres, mod√©lisation  
**Stockage ?** ‚úÖ Stock√©e en m√©moire  
**Symbole DAX :** `=` + fonction de table

```dax
Top10Products = 
    TOPN(
        10,
        VALUES(DimProduct[EnglishProductName]),
        [Total Sales],
        DESC
    )
```

**O√π la cr√©er dans SSDT ?**

1. Menu **Mod√®le** ‚Üí **Nouvelle table calcul√©e**
2. Dans la barre de formule, taper la formule compl√®te
3. Appuyer sur Entr√©e

**Ic√¥ne dans l'Explorateur** : üìã Table avec symbole fx

---

#### üîó Type 4 : COLONNE DE HI√âRARCHIE (Hierarchy)

**C'est quoi ?** Organisation de colonnes en niveaux pour drill-down  
**Quand l'utiliser ?** Pour navigation intuitive (Ann√©e ‚Üí Trimestre ‚Üí Mois)  
**Stockage ?** ‚ùå Juste une m√©tadonn√©e (pas de donn√©es suppl√©mentaires)

**Comment cr√©er ?**

1. Dans la vue Grille, clic droit sur une colonne ‚Üí **Cr√©er une hi√©rarchie**
2. Glisser-d√©poser d'autres colonnes dans la hi√©rarchie

**Exemple** : Hi√©rarchie de dates

```
üìÖ Date Hierarchy
  ‚îú‚îÄ Year
  ‚îú‚îÄ Quarter
  ‚îú‚îÄ Month
  ‚îî‚îÄ Day
```

---

### üéØ Tableau Comparatif des Types

| Aspect            | MESURE üìä   | COLONNE üìè      | TABLE üìã     | HI√âRARCHIE üîó     |
| ----------------- | ----------- | --------------- | ------------ | ----------------- |
| **Symbole**       | `:=`        | `=`             | `=` + table  | Visuel uniquement |
| **Stockage**      | Non         | Oui             | Oui          | Non               |
| **Contexte**      | Filtre      | Ligne           | N/A          | N/A               |
| **Usage typique** | Agr√©gations | Cat√©gorisation  | Segmentation | Navigation        |
| **Exemple**       | Total Sales | Profit Margin % | Top Products | Date Hierarchy    |
| **M√©moire**       | Minimale    | Moyenne-√âlev√©e  | √âlev√©e       | Minimale          |

---

### ‚ö†Ô∏è Erreur Fr√©quente : Confusion := vs =

```dax
// ‚ùå ERREUR - Utiliser = pour une mesure
Total Sales = SUM(FactInternetSales[SalesAmount])
// ‚Üí Cr√©e une COLONNE CALCUL√âE dans la table (si dans une table)
//    ou une erreur de syntaxe

// ‚úÖ CORRECT - Mesure
Total Sales := SUM(FactInternetSales[SalesAmount])

// ‚úÖ CORRECT - Colonne calcul√©e
Profit = [SalesAmount] - [TotalProductCost]
```

---

## SC√âNARIO 1 : Analyse des Ventes par Dimensions

### üìã Contexte M√©tier

**Persona** : Sarah, Directrice Commerciale  
**Besoin** : "Je veux voir mes ventes totales et pouvoir les analyser par ann√©e, cat√©gorie de produit et territoire pour identifier les tendances."

**Objectif p√©dagogique** :

- Cr√©er une mesure simple
- Comprendre le contexte de filtre
- Utiliser la mesure avec plusieurs dimensions
- Cr√©er une hi√©rarchie de temps

---

### √âtape 1 : Cr√©er la mesure Total Sales

**üéØ Type d'objet : üìä MESURE**

#### 1.1 Dans Visual Studio (SSDT)

1. Ouvrir la vue **Grille de donn√©es**
2. Cliquer sur la table **FactInternetSales**
3. Descendre jusqu'√† la **Grille de mesures** (en bas)
4. Cliquer dans la premi√®re cellule vide

#### 1.2 Taper la formule

```dax
Total Sales := SUM(FactInternetSales[SalesAmount])
```

**D√©composition** :

- `Total Sales` : Nom de la mesure (choisissez un nom clair !)
- `:=` : Symbole de d√©finition de mesure
- `SUM()` : Fonction d'agr√©gation
- `FactInternetSales[SalesAmount]` : Colonne √† agr√©ger (syntaxe Table[Colonne])

#### 1.3 Appuyer sur Entr√©e

‚úÖ La mesure appara√Æt dans la grille de mesures  
‚úÖ Dans l'Explorateur de mod√®les : **Mesures** ‚Üí üìä **Total Sales**

---

### √âtape 2 : Tester la mesure - Vue d'ensemble

#### 2.1 Utiliser Analyser dans Excel

1. Menu **Mod√®le** ‚Üí **Analyser dans Excel**
2. Excel s'ouvre avec votre mod√®le connect√©

#### 2.2 Cr√©er un tableau crois√© dynamique simple

**Dans Excel** :

1. Dans les champs du TCD, faire glisser :
   - **Total Sales** ‚Üí dans **Valeurs**

**R√©sultat** :

```
Total Sales
$29,358,677.22
```

**üí° Conclusion √âtape 2** : Notre mesure fonctionne ! C'est le total de TOUTES les ventes Internet.

---

### √âtape 3 : Analyse par Ann√©e (Dimension Temps)

#### 3.1 Ajouter la dimension Ann√©e

Dans le TCD Excel :

1. Faire glisser **DimDate[CalendarYear]** ‚Üí dans **Lignes**
2. Faire glisser **Total Sales** ‚Üí dans **Valeurs**

**R√©sultat** :

```
CalendarYear | Total Sales
2011         | $9,791,060.30
2012         | $9,770,899.74
2013         | $9,791,060.30
2014         | $5,956 (partiel)
Total        | $29,358,677.22
```

**üí° Observation** :

- La **M√äME mesure** s'adapte automatiquement !
- En 2011 : elle calcule uniquement les ventes de 2011
- En 2012 : elle calcule uniquement les ventes de 2012
- C'est le **contexte de filtre** en action !

#### 3.2 Question de r√©flexion

**Q** : Que se passe-t-il quand on ajoute une ann√©e dans le filtre ?  
**R** : La mesure recalcule automatiquement pour cette ann√©e uniquement.

**C'est la MAGIE des mesures DAX** : elles s'adaptent au contexte !

---

### √âtape 4 : Analyse par Cat√©gorie de Produit

#### 4.1 Ajouter la dimension Produit

Dans le TCD :

1. **Retirer** CalendarYear des lignes (pour l'instant)
2. Faire glisser **DimProductCategory[EnglishProductCategoryName]** ‚Üí dans **Lignes**

**R√©sultat** :

```
Category     | Total Sales
Bikes        | $28,318,144.65
Clothing     | $339,772.61
Accessories  | $700,759.96
Total        | $29,358,677.22
```

**üí° Analyse m√©tier** :

- 96% des ventes viennent des v√©los ! üö¥
- Les v√™tements et accessoires sont marginaux
- **Recommandation** : Focus commercial sur les v√©los

---

### √âtape 5 : Analyse crois√©e (Ann√©e √ó Cat√©gorie)

#### 5.1 Combiner les deux dimensions

Dans le TCD :

1. **Lignes** : CalendarYear
2. **Colonnes** : EnglishProductCategoryName
3. **Valeurs** : Total Sales

**R√©sultat** :

```
Year | Accessories | Bikes         | Clothing  | Total
2011 | $236,170.22 | $9,420,177.03 | $134,713.05 | $9,791,060.30
2012 | $235,808.27 | $9,401,366.03 | $133,725.44 | $9,770,899.74
2013 | $228,781.47 | $9,496,601.59 | $65,677.13  | $9,791,060.19
Total| $700,759.96 | $28,318,144.65| $334,115.62 | $29,358,677.22
```

**üí° Insights m√©tier** :

- Les v√©los sont **stables** autour de 9,4M$ par an
- Les v√™tements ont **chut√© de 50%** en 2013 ! ‚ö†Ô∏è
- Les accessoires restent stables

**Action recommand√©e** : Investiguer la baisse des v√™tements en 2013

---

### √âtape 6 : Cr√©er une Hi√©rarchie de Temps (Drill-Down)

**üéØ Type d'objet : üîó HI√âRARCHIE**

#### 6.1 Retour dans Visual Studio

1. Vue **Grille de donn√©es** ‚Üí Table **DimDate**
2. **Clic droit** sur la colonne **CalendarYear**
3. S√©lectionner **Cr√©er une hi√©rarchie**
4. Nommer : `Calendar`

#### 6.2 Ajouter les niveaux

Dans l'**Explorateur de mod√®les** ‚Üí **DimDate** ‚Üí **Hi√©rarchies** ‚Üí **Calendar** :

1. Glisser-d√©poser **CalendarQuarter** dans la hi√©rarchie (sous Year)
2. Glisser-d√©poser **MonthNumberOfYear** dans la hi√©rarchie (sous Quarter)
3. Glisser-d√©poser **FullDateAlternateKey** dans la hi√©rarchie (sous Month)

**Structure finale** :

```
üìÖ Calendar
  ‚îú‚îÄ CalendarYear
  ‚îú‚îÄ CalendarQuarter
  ‚îú‚îÄ MonthNumberOfYear
  ‚îî‚îÄ FullDateAlternateKey
```

#### 6.3 Tester le Drill-Down

1. Retour dans Excel ‚Üí Rafra√Æchir
2. Utiliser la hi√©rarchie **Calendar** dans les lignes
3. Cliquer sur le **+** √† c√¥t√© de 2013

**R√©sultat** :

```
2013
‚îú‚îÄ Q1
‚îÇ  ‚îú‚îÄ January: $812,345
‚îÇ  ‚îú‚îÄ February: $789,234
‚îÇ  ‚îî‚îÄ March: $856,789
‚îú‚îÄ Q2
‚îÇ  ‚îú‚îÄ April: ...
```

**üí° Navigation intuitive** : Sarah peut maintenant explorer ann√©e ‚Üí trimestre ‚Üí mois ‚Üí jour !

---

### üìä CONCLUSION DU SC√âNARIO 1

#### Ce que vous avez appris :

‚úÖ **Cr√©er une MESURE** (üìä) vs Colonne vs Table  
‚úÖ **Contexte de filtre** : la mesure s'adapte automatiquement  
‚úÖ **Utilisation r√©elle** : Tableau crois√© avec dimensions multiples  
‚úÖ **Analyse m√©tier** : Identifier tendances et probl√®mes  
‚úÖ **Hi√©rarchies** (üîó) : Navigation drill-down

#### Quand utiliser une mesure vs colonne calcul√©e ?

**Mesure** : Pour les agr√©gations dans les rapports (90% du temps !)  
**Colonne** : Quand vous voulez filtrer/grouper sur le r√©sultat

#### Prochaine √©tape :

‚Üí Sc√©nario 2 : Ajouter des calculs de marge (plusieurs mesures qui s'encha√Ænent)

---

## SC√âNARIO 2 : Calculs de Marges et Rentabilit√©

### üìã Contexte M√©tier

**Persona** : Marc, Directeur Financier  
**Besoin** : "Les ventes c'est bien, mais je veux voir la RENTABILIT√â. Combien on gagne vraiment ? Quelle est notre marge ?"

**Objectif p√©dagogique** :

- Cr√©er plusieurs mesures qui s'encha√Ænent
- Comprendre les r√©f√©rences entre mesures
- Utiliser des colonnes calcul√©es pour cat√©goriser
- Comparer mesure vs colonne calcul√©e

---

### √âtape 1 : Cr√©er la mesure Total Cost

**üéØ Type d'objet : üìä MESURE**

#### 1.1 Formule

```dax
Total Cost := SUM(FactInternetSales[TotalProductCost])
```

**Pourquoi une mesure ?** On veut agr√©ger le co√ªt, pas le stocker.

#### 1.2 Tester

Dans Excel :

```
CalendarYear | Total Sales      | Total Cost
2011         | $9,791,060.30    | $4,869,472.78
2012         | $9,770,899.74    | $4,856,884.18
2013         | $9,791,060.30    | $4,866,674.59
```

---

### √âtape 2 : Cr√©er la mesure Total Profit

**üéØ Type d'objet : üìä MESURE**

#### 2.1 Formule

```dax
Total Profit := [Total Sales] - [Total Cost]
```

**üí° Notez** : On r√©f√©rence les **autres mesures** avec `[NomMesure]`

#### 2.2 R√©sultat

```
CalendarYear | Total Sales   | Total Cost   | Total Profit
2011         | $9,791,060.30 | $4,869,472.78| $4,921,587.52
2012         | $9,770,899.74 | $4,856,884.18| $4,914,015.56
2013         | $9,791,060.30 | $4,866,674.59| $4,924,385.71
```

**üí° Insight** : Environ 50% de marge brute !

---

### √âtape 3 : Cr√©er la mesure Profit Margin %

**üéØ Type d'objet : üìä MESURE**

#### 3.1 Formule

```dax
Profit Margin % := 
    DIVIDE(
        [Total Profit],
        [Total Sales]
    ) * 100
```

**Pourquoi DIVIDE ?** G√®re automatiquement la division par z√©ro (retourne BLANK au lieu d'erreur)

#### 3.2 Formater en pourcentage

1. Clic droit sur la mesure dans l'Explorateur
2. **Propri√©t√©s** ‚Üí **Format** ‚Üí **Pourcentage** ‚Üí **2 d√©cimales**

#### 3.3 R√©sultat

```
Category     | Total Sales   | Profit Margin %
Bikes        | $28,318,144   | 50.25%
Clothing     | $339,772      | 48.12%
Accessories  | $700,759      | 51.87%
```

**üí° Analyse** : Les accessoires sont les plus rentables !

---

### √âtape 4 : Colonne calcul√©e vs Mesure - D√©monstration

**üéØ Comparaison pratique**

#### 4.1 Cr√©er une COLONNE CALCUL√âE Profit

**Type d'objet : üìè COLONNE CALCUL√âE**

Dans Visual Studio :

1. Table **FactInternetSales** ‚Üí Vue Grille
2. Cliquer sur la premi√®re colonne vide
3. Dans la barre de formule :

```dax
Profit = FactInternetSales[SalesAmount] - FactInternetSales[TotalProductCost]
```

**üí° Syntaxe** : `=` (pas `:=`) et r√©f√©rence directe aux colonnes

#### 4.2 Cr√©er une mesure qui somme la colonne

```dax
Total Profit v2 := SUM(FactInternetSales[Profit])
```

#### 4.3 Comparaison des r√©sultats

```
M√©thode                    | R√©sultat
[Total Profit] (mesure)    | $14,710,989
Total Profit v2 (colonne)  | $14,710,989
```

**Identique !** Alors quelle diff√©rence ?

---

### √âtape 5 : Diff√©rence Mesure vs Colonne - Impact R√©el

#### 5.1 Stockage m√©moire

Ouvrir **VertiPaq Analyzer** (outil externe) ou regarder la taille du mod√®le :

```
FactInternetSales (sans colonne Profit) : 2.1 MB
FactInternetSales (avec colonne Profit)  : 2.6 MB (+23%)
```

**üí° Impact** : La colonne consomme de la RAM !

#### 5.2 Utilisation dans les slicers

**Test** : Peut-on filtrer sur le profit ?

**Avec colonne calcul√©e** :

- ‚úÖ Oui ! On peut cr√©er un slicer sur `Profit`
- ‚úÖ On peut grouper : "Profit √©lev√©" / "Profit faible"

**Avec mesure uniquement** :

- ‚ùå Non ! On ne peut pas mettre une mesure dans un slicer
- ‚ùå On ne peut pas filtrer directement dessus

#### 5.3 Cr√©er des cat√©gories avec la colonne

**Type d'objet : üìè COLONNE CALCUL√âE**

```dax
Profit Category = 
    SWITCH(
        TRUE(),
        FactInternetSales[Profit] > 1000, "High",
        FactInternetSales[Profit] > 500, "Medium",
        FactInternetSales[Profit] > 0, "Low",
        "Loss"
    )
```

**Maintenant dans Excel** :

```
Profit Category | Count of Orders | Total Sales
High            | 12,345          | $18,500,000
Medium          | 28,456          | $8,200,000
Low             | 18,234          | $2,500,000
Loss            | 1,363           | $158,677
```

**üí° Utilit√©** : Segmenter et analyser par cat√©gorie de profit !

---

### üìä CONCLUSION DU SC√âNARIO 2

#### Ce que vous avez appris :

‚úÖ **Mesures encha√Æn√©es** : Utiliser [AutoreMesure] dans une formule  
‚úÖ **DIVIDE()** : Division s√©curis√©e (pas d'erreur si division par 0)  
‚úÖ **Colonne calcul√©e** : Quand on veut filtrer/grouper  
‚úÖ **Impact m√©moire** : Colonnes = stockage, Mesures = pas de stockage  
‚úÖ **SWITCH()** : Cat√©goriser proprement

#### D√©cision : Mesure ou Colonne ?

| Besoin                        | Choisir    |
| ----------------------------- | ---------- |
| Agr√©gation pour rapport       | üìä MESURE  |
| Filtrer/Slicer dessus         | üìè COLONNE |
| Cat√©gorisation                | üìè COLONNE |
| Formule complexe r√©utilisable | üìä MESURE  |

#### Prochaine √©tape :

‚Üí Sc√©nario 3 : Comprendre SUM vs SUMX (it√©ration)

---

## SC√âNARIO 3 : D√©mystifier SUM vs SUMX

### üìã Contexte M√©tier

**Persona** : Julie, Analyste BI  
**Probl√®me** : "Je ne comprends pas la diff√©rence entre SUM et SUMX. Quand utiliser l'un ou l'autre ?"

**Objectif p√©dagogique** :

- Comprendre les fonctions X (it√©rateurs)
- Voir concr√®tement la diff√©rence avec SUM
- Savoir quand utiliser SUMX
- Comprendre le contexte de ligne

---

### √âtape 1 : Le probl√®me avec SUM simple

#### 1.1 Tentative na√Øve (ERREUR COURANTE)

Supposons qu'on veut calculer le profit. Essayons avec SUM :

```dax
Total Profit Wrong := 
    SUM(FactInternetSales[SalesAmount]) - SUM(FactInternetSales[TotalProductCost])
```

**Ce code fonctionne !** Mais est-ce toujours correct ?

#### 1.2 Tester avec un filtre complexe

**Sc√©nario** : Marc veut voir le profit moyen PAR COMMANDE (pas par ligne).

Cr√©ons une mesure "profit moyen" :

```dax
Average Profit Wrong := 
    AVERAGE(FactInternetSales[SalesAmount] - FactInternetSales[TotalProductCost])
```

**‚ùå ERREUR DE SYNTAXE !**

```
Error: The expression contains multiple columns, but only a single column
can be used in this context.
```

**Pourquoi ?** AVERAGE attend UNE SEULE colonne, pas un calcul !

---

### √âtape 2 : La solution avec SUMX

**üéØ Type d'objet : üìä MESURE**

#### 2.1 Formule correcte avec SUMX

```dax
Total Profit Correct := 
    SUMX(
        FactInternetSales,
        FactInternetSales[SalesAmount] - FactInternetSales[TotalProductCost]
    )
```

**Syntaxe SUMX** :

```dax
SUMX(
    Table,              -- Sur quelle table it√©rer
    Expression          -- Calcul √† faire pour chaque ligne
)
```

#### 2.2 Que fait SUMX ?

**Processus interne** :

```
Pour chaque ligne de FactInternetSales :
    1. Calculer : SalesAmount - TotalProductCost
    2. Stocker le r√©sultat
Puis :
    3. Sommer tous les r√©sultats
```

**√âquivalent en pseudo-code** :

```
total = 0
pour chaque ligne dans FactInternetSales:
    profit_ligne = ligne.SalesAmount - ligne.TotalProductCost
    total = total + profit_ligne
retourner total
```

---

### √âtape 3 : Comparaison SUM vs SUMX

#### 3.1 Test avec les deux m√©thodes

```dax
// M√©thode 1 : SUM simple
Total Profit Method1 := 
    SUM(FactInternetSales[SalesAmount]) - SUM(FactInternetSales[TotalProductCost])

// M√©thode 2 : SUMX
Total Profit Method2 := 
    SUMX(
        FactInternetSales,
        FactInternetSales[SalesAmount] - FactInternetSales[TotalProductCost]
    )
```

#### 3.2 R√©sultats

```
Method          | R√©sultat
Method1 (SUM)   | $14,710,988.79
Method2 (SUMX)  | $14,710,988.79
```

**Identique !** Alors pourquoi SUMX ?

---

### √âtape 4 : Cas o√π SUMX est OBLIGATOIRE

#### 4.1 Moyenne du profit par ligne

```dax
// ‚ùå IMPOSSIBLE avec fonctions simples
Average Profit Wrong := 
    AVERAGE(FactInternetSales[SalesAmount] - FactInternetSales[TotalProductCost])
    // ERREUR DE SYNTAXE

// ‚úÖ CORRECT avec AVERAGEX
Average Profit Correct := 
    AVERAGEX(
        FactInternetSales,
        FactInternetSales[SalesAmount] - FactInternetSales[TotalProductCost]
    )
```

**R√©sultat** :

```
Average Profit per Line: $243.63
```

#### 4.2 Prix unitaire moyen pond√©r√©

**Besoin** : Prix moyen en tenant compte des quantit√©s vendues

```dax
// ‚ùå FAUX - Moyenne arithm√©tique simple
Simple Average Price := AVERAGE(FactInternetSales[UnitPrice])
// R√©sultat : $485.23

// ‚úÖ CORRECT - Prix moyen pond√©r√©
Weighted Average Price := 
    DIVIDE(
        SUM(FactInternetSales[SalesAmount]),
        SUM(FactInternetSales[OrderQuantity])
    )
// R√©sultat : $486.13
```

**Diff√©rence** : La version pond√©r√©e tient compte des volumes !

---

### √âtape 5 : Cas r√©el - Calcul avec filtres personnalis√©s

**Besoin** : Profit total uniquement sur les commandes > 1000$

#### 5.1 Avec SUMX + FILTER

```dax
Profit High Value Orders := 
    SUMX(
        FILTER(
            FactInternetSales,
            FactInternetSales[SalesAmount] > 1000
        ),
        FactInternetSales[SalesAmount] - FactInternetSales[TotalProductCost]
    )
```

**Ce que fait cette formule** :

1. FILTER cr√©e une table temporaire avec seulement les lignes > 1000$
2. SUMX it√®re sur cette table filtr√©e
3. Pour chaque ligne : calcule le profit
4. Somme tous les profits

**R√©sultat** :

```
Total Profit (all orders)       : $14,710,989
Profit High Value Orders (>1000): $8,456,234
Percentage                      : 57.5%
```

**üí° Insight** : 57% du profit vient des grosses commandes !

---

### √âtape 6 : Performance SUM vs SUMX

#### 6.1 Test de performance

**Cr√©er deux mesures** :

```dax
// Version SUM (rapide)
Profit SUM := 
    SUM(FactInternetSales[SalesAmount]) - SUM(FactInternetSales[TotalProductCost])

// Version SUMX (plus lente)
Profit SUMX := 
    SUMX(
        FactInternetSales,
        [SalesAmount] - [TotalProductCost]
    )
```

**Utiliser DAX Studio pour mesurer** :

```
Mesure          | Temps d'ex√©cution
Profit SUM      | 8 ms
Profit SUMX     | 45 ms
```

**üí° Conclusion** : SUMX est 5x plus lent !

#### 6.2 Quand optimiser ?

**Utiliser SUM si possible** :

```dax
// ‚úÖ OPTIMAL - Utiliser SUM
Total Sales := SUM(FactInternetSales[SalesAmount])

// ‚ùå INUTILE - SUMX sans raison
Total Sales Slow := SUMX(FactInternetSales, [SalesAmount])
```

**Utiliser SUMX quand n√©cessaire** :

```dax
// ‚úÖ N√âCESSAIRE - Calcul par ligne
Total Profit := SUMX(FactInternetSales, [SalesAmount] - [TotalProductCost])

// ‚úÖ N√âCESSAIRE - Avec filtre complexe
Profit Bikes := SUMX(
    FILTER(FactInternetSales, RELATED(DimProduct[Color]) = "Red"),
    [SalesAmount] - [TotalProductCost]
)
```

---

### üìä CONCLUSION DU SC√âNARIO 3

#### Ce que vous avez appris :

‚úÖ **SUM** : Agr√®ge une colonne simple  
‚úÖ **SUMX** : It√®re ligne par ligne avec un calcul personnalis√©  
‚úÖ **Quand SUMX est obligatoire** : Calculs multi-colonnes (AVERAGEX, etc.)  
‚úÖ **Performance** : SUM plus rapide, utiliser quand possible  
‚úÖ **FILTER + SUMX** : Combinaison puissante pour filtres complexes

#### R√®gle de d√©cision :

```
Si calcul simple sur UNE colonne
    ‚Üí Utiliser SUM, AVERAGE, COUNT, etc.
Si calcul impliquant PLUSIEURS colonnes
    ‚Üí Utiliser SUMX, AVERAGEX, COUNTX, etc.
```

#### Famille des fonctions X :

| Simple  | It√©rateur | Usage                            |
| ------- | --------- | -------------------------------- |
| SUM     | SUMX      | Somme avec calcul personnalis√©   |
| AVERAGE | AVERAGEX  | Moyenne avec calcul personnalis√© |
| COUNT   | COUNTX    | Compte avec condition complexe   |
| MIN     | MINX      | Minimum avec calcul              |
| MAX     | MAXX      | Maximum avec calcul              |
